{% extends "app/campaign/campaign-base.html" %}

{% block title %}Campaign schedule{% endblock %}

{% block cmp-base-content %}

<style>
/* Custom styles for schedule page */
.schedule-item {
    transition: all 0.2s ease;
}

.schedule-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.schedule-item.active {
    box-shadow: 0 4px 20px rgba(59, 130, 246, 0.15);
}

.delete-schedule-btn {
    opacity: 0;
    transition: opacity 0.2s ease;
}

.schedule-item:hover .delete-schedule-btn {
    opacity: 1;
}

.delete-schedule-btn:hover {
    color: #ef4444 !important;
}

.time-select, .timezone-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
}

.form-control input:focus,
.form-control select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.time-select:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}
</style>

        <!-- div two-column layout -->
        <div class="flex-1 flex gap-8 mt-6 overflow-hidden">
          <!-- Left Column: Schedule List -->
          <div class="w-full max-w-xs flex-shrink-0 flex flex-col gap-4">
            <!-- Campaign Dates -->
            <div class="space-y-3 text-sm">
                <div class="flex items-center gap-3">
                    <i class="fa-regular fa-calendar-days w-4 text-center text-gray-500"></i>
                    <span class="font-semibold text-gray-600">Start</span>
                    <div class="w-full border-b border-dashed"></div>
                    <button class="font-semibold text-primary" onclick="editCampaignStart()" id="campaign-start">Now</button>
                </div>
                <div class="flex items-center gap-3">
                    <i class="fa-regular fa-calendar-days w-4 text-center text-gray-500"></i>
                    <span class="font-semibold text-gray-600">End</span>
                    <div class="w-full border-b border-dashed"></div>
                    <button class="font-semibold text-primary whitespace-nowrap" onclick="editCampaignEnd()" id="campaign-end">No end date</button>
                </div>
            </div>

            <div class="divider my-1"></div>

            <!-- Schedules List -->
            <div class="space-y-3" id="schedules-container">
                <!-- Default Schedule -->
                <div class="bg-white border-2 border-primary rounded-lg p-3 flex items-center justify-between cursor-pointer schedule-item active"
                     data-schedule-id="1" onclick="selectSchedule(1)">
                    <div class="flex items-center gap-2 text-gray-800 font-semibold">
                        <i class="fa-regular fa-calendar-days"></i>
                        <span class="schedule-name">Business Hours</span>
                    </div>
                    <button class="btn btn-ghost btn-sm btn-square text-gray-400 delete-schedule-btn"
                            onclick="confirmDeleteSchedule(1)" title="Delete schedule">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>

            <button class="btn btn-ghost bg-white border border-gray-200 mt-2 text-primary font-semibold"
                    onclick="addSchedule()">
                <i class="fa-solid fa-plus mr-2"></i>Add schedule
            </button>

          </div>

          {% if not schedule %}

          <!-- Right Column: Schedule Editor -->
          <div class="flex-1 flex flex-col gap-6 overflow-y-auto">
            <form id="schedule-form" class="space-y-6" onsubmit="saveSchedule(event)">
                <!-- Schedule Name Card -->
                <div class="card bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="font-bold text-gray-800 text-xl mb-4">Schedule Name</h3>
                    <h3 class="text-neutral text-lg mb-4 ml-4">Default Schedule</h3>
                </div>

                <!-- Timing Card -->
                <div class="card bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="font-bold text-gray-800 text-lg mb-4">Timing</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                        <div class="form-control">
                            <label class="label"><span class="label-text">From</span></label>
                            <h3 class="text-neutral text-lg mb-4 ml-4">Midnight | 12:00 AM</h3>
                        </div>
                        <div class="form-control">
                            <label class="label"><span class="label-text">To</span></label>
                            <h3 class="text-neutral text-lg mb-4 ml-4">11:00 PM</h3>
                        </div>
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Timezone</span></label>
                        <h3 class="text-neutral text-lg mb-4 ml-4">Europe/London | (UTCÂ±00:00) Greenwich Mean Time</h3>
                    </div>
                </div>



                <!-- Days Card -->
                <div class="card bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="font-bold text-gray-800 text-lg mb-4">Days</h3>
                    <div class="flex flex-wrap gap-x-6 gap-y-3">
                        <h3 class="text-neutral text-lg mb-4 ml-4">Monday</h3>
                        <h3 class="text-neutral text-lg mb-4 ml-4">Tuesday</h3>
                        <h3 class="text-neutral text-lg mb-4 ml-4">Wednesday</h3>
                        <h3 class="text-neutral text-lg mb-4 ml-4">Thursday</h3>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fa-solid fa-edit mr-2"></i>Edit Default Schedule
                    </button>
                </div>
            </form>
          </div>
        </div>


          {% else %}

          <!-- Right Column: Schedule Editor -->
          <div class="flex-1 flex flex-col gap-6 overflow-y-auto">
            <form id="schedule-form" class="space-y-6" onsubmit="saveSchedule(event)">
                <!-- Schedule Name Card -->
                <div class="card bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="font-bold text-gray-800 text-lg mb-4">Schedule Name</h3>
                    <input type="text"
                           id="schedule-name"
                           name="name"
                           value="Business Hours"
                           class="input input-bordered w-full bg-white"
                           placeholder="Enter schedule name" />
                </div>

                <!-- Timing Card -->
                <div class="card bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="font-bold text-gray-800 text-lg mb-4">Timing</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                        <div class="form-control">
                            <label class="label"><span class="label-text">From</span></label>
                            <select id="time-from" name="timeFrom" class="select select-bordered bg-white time-select" onchange="updateToTimes()">
                                {% for time in times %}
                                    <option value="{{time.0}}" {% if schedule.timing_from == time.0 %}selected{% endif %}>{{time.1}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-control">
                            <label class="label"><span class="label-text">To</span></label>
                            <select id="time-to" name="timeTo" class="select select-bordered bg-white time-select">
                                {% if not schedule.timing_from %}
                                    <option value="10:00" selected>10:00 AM</option>
                                 {% endif %}    
                                {% for time in times %}
                                    {% if schedule.timing_from and time.0 > schedule.timing_from %}
                                        <option value="{{time.0}}" {% if schedule.timing_to == time.0 %}selected{% endif %}>{{time.1}}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Timezone</span></label>
                        <select id="timezone" name="timezone" class="select select-bordered bg-white timezone-select">
                            {% for tz in timezones %}
                                <option value="{{ tz.0 }}" {% if tz.0 == schedule.time_zone %}selected{% endif %}>{{ tz.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>



                <!-- Days Card -->
                <div class="card bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="font-bold text-gray-800 text-lg mb-4">Days</h3>
                    <div class="flex flex-wrap gap-x-6 gap-y-3">
                        {% for day in days %}
                            <label class="label cursor-pointer justify-start gap-2">
                                <input type="checkbox" name="days" value="{{ day.0 }}" {% if day.0 in schedule.days %}checked{% endif %} class="checkbox checkbox-primary" />
                                <span class="label-text">{{ day.1 }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fa-solid fa-save mr-2"></i>Save Schedule
                    </button>
                    <button type="button" class="btn btn-ghost" onclick="resetForm()">
                        <i class="fa-solid fa-undo mr-2"></i>Reset
                    </button>
                </div>
            </form>
          </div>
        </div>

        {% endif %}

<script>
function updateToTimes() {
    const fromSelect = document.getElementById('time-from');
    const toSelect = document.getElementById('time-to');
    const selectedFromTime = fromSelect.value;
    
    // Enable To select
    toSelect.disabled = false;
    
    // Clear existing options
    toSelect.innerHTML = '';
    
    // Add only times after the selected From time
    const times = [
        {% for time in times %}
            {value: "{{ time.0 }}", label: "{{ time.1 }}"},
        {% endfor %}
    ];
    
    times.forEach(time => {
        if (time.value > selectedFromTime) {
            const option = document.createElement('option');
            option.value = time.value;
            option.textContent = time.label;
            toSelect.appendChild(option);
        }
    });
    
    // If no valid options, disable the select
    if (toSelect.options.length === 0) {
        toSelect.disabled = true;
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    {% if schedule.timing_from %}
        updateToTimes();
    {% endif %}
});
// Schedule Management System
let activeScheduleId = 1;
let scheduleCounter = 1;
let schedules = {};

// Initialize with default schedule
schedules[1] = {
    id: 1,
    name: 'Business Hours',
    timeFrom: '09:00',
    timeTo: '18:00',
    timezone: 'America/New_York',
    days: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday']
};

// Schedule Management Functions
function selectSchedule(scheduleId) {
    // Save current schedule before switching
    saveCurrentSchedule();

    // Remove active class from all schedules
    document.querySelectorAll('.schedule-item').forEach(item => {
        item.classList.remove('active', 'border-2', 'border-primary');
        item.classList.add('border', 'border-gray-200');
        item.querySelector('.schedule-name').parentElement.classList.remove('text-gray-800', 'font-semibold');
        item.querySelector('.schedule-name').parentElement.classList.add('text-gray-600');
    });

    // Add active class to selected schedule
    const selectedItem = document.querySelector(`[data-schedule-id="${scheduleId}"]`);
    if (selectedItem) {
        selectedItem.classList.add('active', 'border-2', 'border-primary');
        selectedItem.classList.remove('border', 'border-gray-200');
        selectedItem.querySelector('.schedule-name').parentElement.classList.add('text-gray-800', 'font-semibold');
        selectedItem.querySelector('.schedule-name').parentElement.classList.remove('text-gray-600');
        activeScheduleId = scheduleId;

        // Load schedule data into form
        loadScheduleData(scheduleId);
    }
}

function loadScheduleData(scheduleId) {
    const schedule = schedules[scheduleId];
    if (!schedule) return;

    // Load form data
    document.getElementById('schedule-name').value = schedule.name;
    document.getElementById('time-from').value = schedule.timeFrom;
    document.getElementById('time-to').value = schedule.timeTo;
    document.getElementById('timezone').value = schedule.timezone;

    // Clear all day checkboxes
    document.querySelectorAll('input[name="days"]').forEach(checkbox => {
        checkbox.checked = false;
    });

    // Check selected days
    schedule.days.forEach(day => {
        const checkbox = document.querySelector(`input[name="days"][value="${day}"]`);
        if (checkbox) checkbox.checked = true;
    });
}

function saveCurrentSchedule() {
    if (!activeScheduleId) return;

    // Get form data
    const formData = new FormData(document.getElementById('schedule-form'));
    const scheduleData = {
        id: activeScheduleId,
        name: formData.get('name'),
        timeFrom: formData.get('timeFrom'),
        timeTo: formData.get('timeTo'),
        timezone: formData.get('timezone'),
        days: formData.getAll('days')
    };

    // Store in schedules object
    schedules[activeScheduleId] = scheduleData;

    // Update schedule name in list
    const scheduleItem = document.querySelector(`[data-schedule-id="${activeScheduleId}"]`);
    if (scheduleItem) {
        scheduleItem.querySelector('.schedule-name').textContent = scheduleData.name;
    }
}

function saveSchedule(event) {
    event.preventDefault();
    saveCurrentSchedule();
    window.ModalSystem.toast('Schedule saved successfully!');
}

function addSchedule() {
    // Save current schedule first
    saveCurrentSchedule();

    scheduleCounter++;
    const newScheduleId = scheduleCounter;

    // Create new schedule data
    const newSchedule = {
        id: newScheduleId,
        name: `New Schedule ${newScheduleId}`,
        timeFrom: '09:00',
        timeTo: '17:00',
        timezone: 'America/New_York',
        days: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday']
    };

    schedules[newScheduleId] = newSchedule;

    // Create new schedule HTML
    const newScheduleHTML = `
        <div class="bg-white border border-gray-200 rounded-lg p-3 flex items-center justify-between cursor-pointer schedule-item"
             data-schedule-id="${newScheduleId}" onclick="selectSchedule(${newScheduleId})">
            <div class="flex items-center gap-2 text-gray-600">
                <i class="fa-regular fa-calendar-days"></i>
                <span class="schedule-name">${newSchedule.name}</span>
            </div>
            <button class="btn btn-ghost btn-sm btn-square text-gray-400 delete-schedule-btn"
                    onclick="confirmDeleteSchedule(${newScheduleId})" title="Delete schedule">
                <i class="fa-solid fa-trash"></i>
            </button>
        </div>
    `;

    // Insert before the Add Schedule button
    const addButton = document.querySelector('.btn.btn-ghost.bg-white.border.border-gray-200');
    addButton.insertAdjacentHTML('beforebegin', newScheduleHTML);

    // Select the new schedule
    selectSchedule(newScheduleId);

    window.ModalSystem.toast('New schedule added successfully!');
}

function confirmDeleteSchedule(scheduleId) {
    if (Object.keys(schedules).length <= 1) {
        window.ModalSystem.error('Cannot delete the last remaining schedule.');
        return;
    }

    const schedule = schedules[scheduleId];
    window.ModalSystem.confirm({
        title: 'Delete Schedule',
        message: `Are you sure you want to delete "${schedule.name}"? This action cannot be undone.`,
        confirmText: 'Delete',
        confirmClass: 'btn-error',
        action: () => deleteSchedule(scheduleId)
    });
}

function deleteSchedule(scheduleId) {
    const scheduleItem = document.querySelector(`[data-schedule-id="${scheduleId}"]`);
    if (scheduleItem) {
        scheduleItem.remove();

        // Remove from schedules
        delete schedules[scheduleId];

        // Select first available schedule
        const firstSchedule = document.querySelector('.schedule-item');
        if (firstSchedule) {
            const firstScheduleId = parseInt(firstSchedule.getAttribute('data-schedule-id'));
            selectSchedule(firstScheduleId);
        }

        window.ModalSystem.toast('Schedule deleted successfully');
    }
}

function resetForm() {
    if (activeScheduleId && schedules[activeScheduleId]) {
        loadScheduleData(activeScheduleId);
        window.ModalSystem.toast('Form reset to saved values');
    }
}

function editCampaignStart() {
    window.ModalSystem.toast('Campaign start date editing coming soon!', 'info');
}

function editCampaignEnd() {
    window.ModalSystem.toast('Campaign end date editing coming soon!', 'info');
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Load initial schedule data
    loadScheduleData(1);

    // Auto-save on form changes
    document.addEventListener('input', function(e) {
        if (e.target.closest('#schedule-form')) {
            // Auto-save current schedule when user makes changes
            setTimeout(() => {
                saveCurrentSchedule();
            }, 500);
        }
    });

    // Update schedule name in real-time
    document.getElementById('schedule-name').addEventListener('input', function() {
        const scheduleItem = document.querySelector(`[data-schedule-id="${activeScheduleId}"]`);
        if (scheduleItem) {
            scheduleItem.querySelector('.schedule-name').textContent = this.value;
        }
    });
});
</script>

{% endblock %}