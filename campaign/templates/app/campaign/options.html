{% extends "app/campaign/campaign-base.html" %}

{% block title %}Campaign options{% endblock %}

{% block cmp-base-content %}

<style>
/* Custom styles for options page */
.option-card {
    transition: all 0.2s ease;
}

.option-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.toggle-group .btn {
    transition: all 0.2s ease;
}

.toggle-group .btn.active {
    transform: scale(1.02);
}

.form-control input:focus,
.form-control select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.save-indicator {
    opacity: 0;
    transition: opacity 0.3s ease;
}

.save-indicator.show {
    opacity: 1;
}

/* Add this to your styles */
#dropdownList {
    max-width: calc(100% - 2px); /* Adjust as needed */
}

/* Launch button animations */
#launch-btn {
    transition: all 0.3s ease;
}

#launch-btn:not(.btn-disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
}

#launch-btn.btn-disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Status indicators */
.animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: .5;
    }
}
</style>

        <!-- Options Container -->
        <div class="mt-6 w-full max-w-4xl mx-auto">
            <form id="options-form" class="space-y-4">
                <!-- Card: Accounts to use -->
                <div class="card bg-white p-6 rounded-lg shadow-sm flex-row items-center justify-between option-card">
                    <div>
                        <h3 class="font-bold text-gray-800 text-base">Accounts to use</h3>
                        <p class="text-sm text-gray-500 mt-1">Select one or more accounts to send emails from</p>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <div class="max-w-lg w-full mx-auto relative">
                            <label class="block text-sm font-medium mb-1">Select Sending Emails</label>

                            <!-- Selected Email Tags -->
                            <div id="selectedEmails" class="flex flex-wrap gap-2 mb-2">
                                {% if campaign_options %}
                                    {% for email in campaign_options.email_accounts.all %}
                                        <div class="badge badge-success badge-outline text-xs font-semibold">
                                            {{ email.email }}
                                            <button class="ml-2 text-error" onclick="removeEmail('{{ email.email }}')">Ã—</button>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>

                            <!-- Search Input -->
                            <input type="text" id="searchInput" placeholder="Search email..."
                                class="input input-bordered w-full mb-2" oninput="filterEmails()" onclick="showDropdown()" />

                            <!-- Dropdown List - Updated classes -->
                            <ul id="dropdownList" class="menu bg-white border rounded-box max-h-70 hidden shadow-md absolute top-full left-0 right-0 z-10 mt-1 w-full" 
                                style="overflow-y: auto;overflow-x: none;max-width: calc(100% - 2px);"></ul>
                        </div>

                        <button type="button" class="text-sm text-primary font-semibold hover:underline" onclick="connectNewAccount()">
                            Connect new email account
                        </button>
                    </div>
                </div>
                <!-- Card: Stop sending emails -->
                <div class="card bg-white p-6 rounded-lg shadow-sm flex-row items-center justify-between option-card">
                    <div>
                        <h3 class="font-bold text-gray-800 text-base">Stop sending emails on reply</h3>
                        <p class="text-sm text-gray-500 mt-1">Stop sending emails to a lead if a response has been received</p>
                    </div>
                    <div class="join rounded-lg toggle-group" data-option="stopOnReply">
                        <button type="button" class="join-item btn btn-sm {% if not campaign_options or not campaign_options.stop_on_reply %}bg-gray-100 border-gray-300 text-gray-500{% else %}btn-neutral text-white{% endif %}"
                                onclick="toggleOption('stopOnReply', false)" data-value="false">Disable</button>
                        <button type="button" class="join-item btn btn-sm {% if campaign_options and campaign_options.stop_on_reply %}btn-success text-white active{% else %}bg-gray-100 border-gray-300 text-gray-500{% endif %}"
                                onclick="toggleOption('stopOnReply', true)" data-value="true">Enable</button>
                    </div>
                </div>

                <!-- Card: Open Tracking -->
                <div class="card bg-white p-6 rounded-lg shadow-sm flex-row items-center justify-between option-card">
                    <div>
                        <h3 class="font-bold text-gray-800 text-base">Open Tracking</h3>
                        <p class="text-sm text-gray-500 mt-1">Track email opens</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <label class="label cursor-pointer gap-2">
                            <input type="checkbox" name="linkTracking" class="checkbox checkbox-primary" onchange="updateOption('linkTracking', this.checked)" {% if campaign_options and campaign_options.link_tracking_enabled %}checked{% elif not campaign_options %}checked{% endif %}/>
                            <span class="label-text">Link tracking</span>
                        </label>
                        <div class="join rounded-lg toggle-group" data-option="openTracking">
                            <button type="button" class="join-item btn btn-sm {% if not campaign_options or not campaign_options.open_tracking_enabled %}bg-gray-100 border-gray-300 text-gray-500{% else %}btn-neutral text-white{% endif %}" 
                                    onclick="toggleOption('openTracking', false)" data-value="false">Disable</button>
                            <button type="button" class="join-item btn btn-sm {% if campaign_options and campaign_options.open_tracking_enabled %}btn-success text-white active{% else %}bg-gray-100 border-gray-300 text-gray-500{% endif %}" 
                                    onclick="toggleOption('openTracking', true)" data-value="true">Enable</button>
                        </div>
                    </div>
                </div>
                <!-- Card: Delivery Optimization -->
                <!-- <div class="card bg-white p-6 rounded-lg shadow-sm flex-row items-center justify-between option-card">
                    <div>
                        <h3 class="font-bold text-gray-800 text-base flex items-center gap-2">
                            Delivery Optimization
                            <div class="badge badge-success badge-outline text-xs font-semibold">Recommended</div>
                        </h3>
                        <p class="text-sm text-gray-500 mt-1">Disables open tracking</p>
                    </div>
                    <div class="flex flex-col items-start gap-2">
                        <label class="label cursor-pointer justify-start gap-2">
                            <input type="checkbox" name="textOnly" class="checkbox checkbox-primary" onchange="updateOption('textOnly', this.checked)" {% if campaign_options and campaign_options.send_as_text_only %}checked{% endif %}/>
                            <span class="label-text text-sm">Send emails as text-only (no HTML)</span>
                        </label>
                        <label class="label cursor-pointer justify-start gap-2">
                            <input type="checkbox" name="firstEmailTextOnly" class="checkbox checkbox-primary" onchange="updateOption('firstEmailTextOnly', this.checked)" {% if not campaign_options or campaign_options.send_first_email_as_text_only %}checked{% endif %}/>
                            <span class="label-text text-sm flex items-center gap-2">
                                Send first email as text-only
                                <div class="badge badge-warning text-yellow-800 font-bold text-xs">Pro</div>
                            </span>
                        </label>
                    </div>
                </div> -->

                <!-- Card: Daily Limit -->
                <div class="card bg-white p-6 rounded-lg shadow-sm flex-row items-center justify-between option-card">
                    <div>
                        <h3 class="font-bold text-gray-800 text-base">Daily Limit</h3>
                        <p class="text-sm text-gray-500 mt-1">Max number of emails to send per day for this campaign.</p>
                        <p class="text-sm text-gray-500 mt-1">Each email can send arround 30 emails per day, without landing in spam/promotion folders</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number"
                               id="daily-limit"
                               name="dailyLimit"
                               value="{% if campaign_options %}{{ campaign_options.daily_limit }}{% else %}30{% endif %}"
                               min="1"
                               max="1000"
                               class="input input-bordered bg-white w-24 text-center"
                               onblur="updateOption('dailyLimit', this.value)" />
                    </div>
                </div>
            </form>

            <!-- Campaign Status Card (if campaign is active) -->
            {% if campaign.status == 'active' %}
            <div class="card bg-gradient-to-r from-green-50 to-green-100 border-green-200 p-6 rounded-lg shadow-sm mt-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <div>
                            <h3 class="font-bold text-green-800 text-base">Campaign is Active</h3>
                            <p class="text-sm text-green-600 mt-1">Your campaign is currently running and sending emails</p>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline btn-success" onclick="checkCampaignStatus()">
                        <i class="fas fa-chart-line mr-2"></i> View Progress
                    </button>
                </div>
            </div>
            {% endif %}

            <!-- Action Buttons -->
            <div class="flex justify-center mt-10 space-x-4">
                <button class="btn btn-outline btn-primary" onclick="saveOptions()">
                    <i class="fas fa-save mr-2"></i> Save Options
                </button>

                {% if campaign.status == 'active' %}
                    <button class="btn btn-success" onclick="window.location.href='/campaign/dashboard/{{ campaign_id }}'">
                        <i class="fas fa-chart-line mr-2"></i> View Dashboard
                    </button>
                {% else %}
                    <button class="btn btn-primary btn-lg" onclick="launchCampaign()" id="launch-btn">
                        <i class="fas fa-rocket mr-2"></i> Launch Campaign
                    </button>
                {% endif %}
            </div>

            <!-- Launch Requirements Info -->
            {% if campaign.status != 'active' %}
            <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h4 class="font-semibold text-blue-800 mb-2">
                    <i class="fas fa-info-circle mr-2"></i>Before launching your campaign:
                </h4>
                <ul class="text-sm text-blue-700 space-y-1">
                    <li class="flex items-center gap-2">
                        <i class="fas fa-check-circle text-green-500"></i>
                        Select at least one active email account
                    </li>
                    <li class="flex items-center gap-2">
                        <i class="fas fa-check-circle text-green-500"></i>
                        Configure your sending preferences
                    </li>
                    <li class="flex items-center gap-2">
                        <i class="fas fa-check-circle text-green-500"></i>
                        Set appropriate daily limits
                    </li>
                    <li class="flex items-center gap-2">
                        <i class="fas fa-info-circle text-blue-500"></i>
                        Make sure your campaign has message assignments and leads
                    </li>
                </ul>
            </div>
            {% endif %}
        </div>

<script>
    const allEmails = [
    {% for email in emails %}
        { email_id: {{email.email_id}}, email: "{{email.email}}", active: {% if email.active %}true{% else %}false{% endif %}, used: {% if email.used %}true{% else %}false{% endif %} },
    {% endfor %}
    ];

    // Initialize selected emails with current campaign options
    let selectedEmails = [
        {% if campaign_options %}
            {% for email in campaign_options.email_accounts.all %}
                { email_id: {{email.id}}, email: "{{email.email}}"},
            {% endfor %}
        {% endif %}
    ];

    const dropdown = document.getElementById("dropdownList");
    const searchInput = document.getElementById("searchInput");
    const selectedContainer = document.getElementById("selectedEmails");

    // Initialize campaign options with current values
    let campaignOptions = {
        emailAccounts: selectedEmails,
        stopOnReply: {% if campaign_options %}{{ campaign_options.stop_on_reply|lower }}{% else %}true{% endif %},
        openTracking: {% if campaign_options %}{{ campaign_options.open_tracking_enabled|lower }}{% else %}false{% endif %},
        linkTracking: {% if campaign_options %}{{ campaign_options.link_tracking_enabled|lower }}{% else %}true{% endif %},
        textOnly: {% if campaign_options %}{{ campaign_options.send_as_text_only|lower }}{% else %}false{% endif %},
        firstEmailTextOnly: {% if not campaign_options or campaign_options.send_first_email_as_text_only %}false{% else %}false{% endif %},
        dailyLimit: {% if campaign_options %}{{ campaign_options.daily_limit }}{% else %}30{% endif %}
    };

    function showDropdown() {
      dropdown.classList.remove("hidden");
      filterEmails();
    }

    document.addEventListener("click", function (e) {
      if (!dropdown.contains(e.target) && e.target !== searchInput) {
        dropdown.classList.add("hidden");
      }
    });

    function filterEmails() {
      const query = searchInput.value.toLowerCase();
      dropdown.innerHTML = "";

      const filtered = allEmails.filter(e =>
        e.email.toLowerCase().includes(query) &&
        !selectedEmails.some(selected => selected.email === e.email)
      );

      if (filtered.length === 0) {
        dropdown.innerHTML = `<li clascampaign_optionss="text-sm text-gray-500 px-4 py-2">No options</li>`;
        return;
      }

      filtered.forEach(email => {
        const li = document.createElement("li");
        li.className = "px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm flex justify-between items-center";
        li.innerHTML = `
          <span>${email.email}</span>
          ${!email.active ? '<span class="text-red-500 text-xs ml-2">Account not active</span>' : ''}
          ${email.used ? '<span class="text-red-400 text-xs ml-2">Account already used</span>' : ''}
        `;

        if (email.active && !email.used) {
          li.onclick = () => selectEmail(email.email);
        } else {
          li.classList.add("opacity-50", "cursor-not-allowed");
        }

        dropdown.appendChild(li);
      });
    }

    function selectEmail(email) {
      if (!selectedEmails.some(selected => selected.email === email)) {
        // Find the email object from allEmails to get the email_id
        const emailObj = allEmails.find(e => e.email === email);
        if (emailObj) {
          selectedEmails.push({ email_id: emailObj.email_id, email: email });
          campaignOptions.emailAccounts = selectedEmails;
          renderSelected();
          updateDailyLimit();
          validateCampaignReadiness();
          searchInput.value = "";
          filterEmails();
        }
      }
    }

    function removeEmail(email) {
      selectedEmails = selectedEmails.filter(e => e.email !== email);
      campaignOptions.emailAccounts = selectedEmails;
      renderSelected();
      updateDailyLimit();
      validateCampaignReadiness();
      filterEmails();
    }

    function renderSelected() {
      selectedContainer.innerHTML = "";
      selectedEmails.forEach(emailObj => {
        const badge = document.createElement("div");
        badge.className = "badge badge-success badge-outline text-xs font-semibold";
        badge.innerHTML = `
          ${emailObj.email}
          <button class="ml-2 text-error" onclick="removeEmail('${emailObj.email}')">Ã—</button>
        `;
        selectedContainer.appendChild(badge);
      });
    }

    // Toggle button functionality
    function toggleOption(optionName, value) {
        const toggleGroup = document.querySelector(`[data-option="${optionName}"]`);
        const buttons = toggleGroup.querySelectorAll('button');

        // Update button states
        buttons.forEach(btn => {
            const btnValue = btn.getAttribute('data-value') === 'true';
            if (btnValue === value) {
                btn.classList.add('active');
                if (value) {
                    btn.classList.add('btn-success', 'text-white');
                    btn.classList.remove('bg-gray-100', 'border-gray-300', 'text-gray-500', 'btn-neutral');
                } else {
                    btn.classList.add('btn-neutral', 'text-white');
                    btn.classList.remove('bg-gray-100', 'border-gray-300', 'text-gray-500', 'btn-success');
                }
            } else {
                btn.classList.remove('active', 'btn-success', 'btn-neutral', 'text-white');
                btn.classList.add('bg-gray-100', 'border-gray-300', 'text-gray-500');
            }
        });

        // Update option value
        campaignOptions[optionName] = value;
    }

    // Update checkbox options
    function updateOption(optionName, value) {
        if (optionName === 'dailyLimit') {
            const input = document.getElementById('daily-limit');
            // Ensure minimum of 2
            if (value < 2) {
                value = 2;
            }
            
            // Round to nearest even number
            if (value % 2 !== 0) {
                value = Math.round(value / 2) * 2;
                ModalSystem.toast('Adjusted to nearest even number: ' + value, 'info');
            }
            
            input.value = value;
            campaignOptions.dailyLimit = value;
            campaignOptions[optionName] = value;
        } else {
            campaignOptions[optionName] = value;
        }

        // Show save indicator for daily limit changes
        // if (optionName === 'dailyLimit') {
        //     const indicator = document.getElementById('daily-limit-saved');
        //     indicator.classList.add('show');
        //     setTimeout(() => indicator.classList.remove('show'), 2000);
        // }
    }

    function updateDailyLimit() {
        const accountCount = selectedEmails.length;
        const newLimit = accountCount * 30; // 30 emails per account
        document.getElementById('daily-limit').value = newLimit;
        document.getElementById('daily-limit').max = newLimit+accountCount*10;
        document.getElementById('daily-limit').min = newLimit-accountCount*20;
        campaignOptions.dailyLimit = newLimit;
    }

    function saveOptions() {
        campaignOptionsToSave = {
            campaign: {{ campaign_id }},
            email_accounts: campaignOptions.emailAccounts.map(email => email.email_id),
            stop_on_reply: campaignOptions.stopOnReply,
            open_tracking_enabled: campaignOptions.openTracking,  
            link_tracking_enabled: campaignOptions.linkTracking, 
            send_as_text_only: campaignOptions.textOnly, 
            send_first_email_as_text_only: campaignOptions.firstEmailTextOnly, 
            daily_limit: campaignOptions.dailyLimit 
        }

        if (campaignOptions.emailAccounts.length === 0) {
            ModalSystem.toast('Please select at least one email account before saving the options.', 'error');
            return;
        }
        
        fetch('{% if campaign_options %}/api/campaign-options/{{ campaign_options.id }}/{% else %}/api/campaign-options/{% endif %}', {
            method: {% if campaign_options %}'PUT'{% else %}'POST'{% endif %},
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(campaignOptionsToSave)
        })
        .then(response => {
            if (!response.ok) {
                ModalSystem.toast('Error saving options', 'error');
                return response.json().then(err => { throw err; });
            }
        })
        .then(data => {
            ModalSystem.toast('Campaign options saved successfully!', 'success');
        })
        .catch(error => {
            ModalSystem.toast('Failed to save options', 'error');
        });
    }

    // Launch campaign with real API integration
    function launchCampaign() {
        // Validate required fields
        if (campaignOptions.emailAccounts.length === 0) {
            ModalSystem.toast('Please select at least one email account before launching the campaign.', 'error');
            return;
        }

        // First save options before launching
        saveOptionsBeforeLaunch().then(() => {
            ModalSystem.confirm({
                title: 'Launch Campaign',
                message: `Are you sure you want to launch this campaign? This will start sending emails to all leads using ${campaignOptions.emailAccounts.length} email account(s).`,
                confirmText: 'Launch Campaign',
                confirmClass: 'btn-primary',
                action: () => {
                    performCampaignLaunch();
                }
            });
        }).catch(error => {
            ModalSystem.toast('Please save campaign options first before launching.', 'error');
        });
    }

    // Save options before launch (without showing success message)
    function saveOptionsBeforeLaunch() {
        return new Promise((resolve, reject) => {
            const campaignOptionsToSave = {
                campaign: {{ campaign_id }},
                email_accounts: campaignOptions.emailAccounts.map(email => email.email_id),
                stop_on_reply: campaignOptions.stopOnReply,
                open_tracking_enabled: campaignOptions.openTracking,
                link_tracking_enabled: campaignOptions.linkTracking,
                send_as_text_only: campaignOptions.textOnly,
                send_first_email_as_text_only: campaignOptions.firstEmailTextOnly,
                daily_limit: campaignOptions.dailyLimit
            };

            fetch('{% if campaign_options %}/api/campaign-options/{{ campaign_options.id }}/{% else %}/api/campaign-options/{% endif %}', {
                method: {% if campaign_options %}'PUT'{% else %}'POST'{% endif %},
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(campaignOptionsToSave)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to save options');
                }
                resolve();
            })
            .catch(error => {
                reject(error);
            });
        });
    }

    // Perform the actual campaign launch
    function performCampaignLaunch() {
        ModalSystem.loading('Launching campaign...');

        fetch('/api/campaigns/{{ campaign_id }}/launch/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            ModalSystem.hideLoading();

            if (data.success) {
                ModalSystem.success({
                    title: 'Campaign Launched Successfully!',
                    message: `Your campaign "${data.campaign_name}" has been launched! ${data.pending_emails} emails are being processed and will be sent according to your schedule.`,
                    action: () => {
                        // Redirect to dashboard to monitor progress
                        window.location.href = '/campaign/dashboard/{{ campaign_id }}';
                    }
                });
            } else {
                ModalSystem.error({
                    title: 'Launch Failed',
                    message: data.message || 'Failed to launch campaign. Please check your settings and try again.'
                });
            }
        })
        .catch(error => {
            ModalSystem.hideLoading();
            console.error('Launch error:', error);
            ModalSystem.error({
                title: 'Launch Error',
                message: 'An unexpected error occurred while launching the campaign. Please try again.'
            });
        });
    }

    // Add function to check campaign status (optional - for monitoring)
    function checkCampaignStatus() {
        fetch('/api/campaigns/{{ campaign_id }}/status/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Campaign Status:', data);

                // Show status modal with detailed information
                ModalSystem.info({
                    title: 'Campaign Status',
                    message: `
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span>Campaign:</span>
                                <span class="font-semibold">${data.campaign_name}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Status:</span>
                                <span class="badge badge-${data.campaign_status === 'active' ? 'success' : 'warning'}">${data.campaign_status}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Total Emails:</span>
                                <span class="font-semibold">${data.statistics.total_message_assignments}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Sent:</span>
                                <span class="font-semibold text-green-600">${data.statistics.sent_emails}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Pending:</span>
                                <span class="font-semibold text-blue-600">${data.statistics.pending_emails}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Progress:</span>
                                <span class="font-semibold">${data.statistics.completion_percentage}%</span>
                            </div>
                        </div>
                    `
                });

                return data;
            }
        })
        .catch(error => {
            console.error('Status check error:', error);
            ModalSystem.toast('Failed to fetch campaign status', 'error');
        });
    }

    // Validate campaign readiness for launch
    function validateCampaignReadiness() {
        const launchBtn = document.getElementById('launch-btn');
        const requirements = document.querySelectorAll('.requirement-item');

        if (!launchBtn) return; // Campaign is already active

        let isReady = true;

        // Check if email accounts are selected
        if (campaignOptions.emailAccounts.length === 0) {
            isReady = false;
        }

        // Update launch button state
        if (isReady) {
            launchBtn.disabled = false;
            launchBtn.classList.remove('btn-disabled');
            launchBtn.classList.add('btn-primary');
        } else {
            launchBtn.disabled = true;
            launchBtn.classList.add('btn-disabled');
            launchBtn.classList.remove('btn-primary');
        }
    }

    // Connect new email account function
    function connectNewAccount() {
        ModalSystem.info({
            title: 'Connect New Email Account',
            message: 'To connect a new email account, please go to the Email Accounts section in your dashboard and add a new account. Once added, it will appear in this list.',
            action: () => {
                // Redirect to email accounts page
                window.location.href = '/campaign/email-accounts/';
            }
        });
    }

    // Initialize the UI with current values
    document.addEventListener('DOMContentLoaded', function() {
        // Set initial toggle states
        toggleOption('stopOnReply', campaignOptions.stopOnReply);
        toggleOption('openTracking', campaignOptions.openTracking);

        // Render selected emails
        renderSelected();

        // Validate campaign readiness
        validateCampaignReadiness();
    });
</script>

{% endblock %}