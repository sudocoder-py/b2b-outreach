{% extends "base-app.html" %}

{% block title %}Email Accounts{% endblock %}

{% block content %}
<div class="flex-1 flex flex-col overflow-hidden bg-gray-50 p-6">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Email Accounts</h1>
                <p class="text-gray-600">Connect and manage your email accounts for campaigns</p>
            </div>
            <div class="flex gap-2">
                <select class="select select-bordered bg-white" id="status-filter">
                    <option value="">All statuses</option>
                    <option value="connected">Connected</option>
                    <option value="error">Error</option>
                    <option value="pending">Pending</option>
                </select>
                <button class="btn btn-primary" onclick="showAddAccountModal()">
                    <i class="fa-solid fa-plus mr-2"></i>
                    Add New
                </button>
            </div>
        </div>
    </div>

    <!-- Search -->
    <div class="mb-6">
        <div class="flex items-center gap-4">
            <div class="relative flex-1 max-w-md">
                <input type="text"
                       placeholder="Search..."
                       class="input input-bordered w-full bg-white pl-10"
                       id="search-accounts">
                <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
            <button onclick="clearAccountFilters()" class="btn btn-ghost">Clear</button>
            <div class="text-sm text-gray-500">
                <span id="account-count">{{ emails|length }} accounts</span>
            </div>
        </div>
    </div>

    <!-- Email Accounts Table -->
    <div class="flex-1 bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="table w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="text-left font-semibold text-gray-900">EMAIL</th>
                        <th class="text-left font-semibold text-gray-900">EMAILS SENT</th>
                        <th class="text-left font-semibold text-gray-900">STATUS</th>
                        <th class="text-left font-semibold text-gray-900">ACTIONS</th>
                    </tr>
                </thead>
                <tbody id="accounts-table-body">
                    {% for email in emails %}
                    <tr class="hover:bg-gray-50 account-row" 
                        onclick="openSidebar('{{ email.id }}')"
                        data-status="{{ email.status|lower }}"
                        data-email="{{ email.email|lower }}"
                        data-connection="{{ email.connection_type|lower }}">
                        <td>
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fa-solid fa-envelope text-blue-600 text-sm"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900">{{ email.email }}</div>
                                    <div class="text-sm text-gray-500">Connected via {{ email.connection_type }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="text-sm">
                                <div class="font-medium text-gray-900">{{ email.emails_sent }} of {{ email.daily_limit }}</div>
                                <div class="text-gray-500">Daily limit</div>
                            </div>
                        </td>      
                        <td>
                            <div class="text-sm">
                                {% if email.status == "connected" %}
                                    <span class="badge badge-success text-gray-100">{{ email.status }}</span>
                                {% elif email.status == "error" %}
                                    <span class="badge badge-error text-gray-100">{{ email.status }}</span>
                                {% else %}
                                    <span class="badge badge-warning text-gray-100">{{ email.status }}</span>
                                {% endif %}
                            </div>
                        </td>             
                        <td>
                            <div class="flex items-center gap-2">
                                <button class="btn btn-ghost btn-xs" onclick="event.stopPropagation(); editAccount('{{ email.id }}')" title="Edit">
                                    <i class="fa-solid fa-edit"></i>
                                </button>
                                <button class="btn btn-ghost btn-xs" onclick="event.stopPropagation(); testConnection('{{ email.id }}')" title="Test Connection">
                                    <i class="fa-solid fa-plug"></i>
                                </button>
                                <button class="btn btn-ghost btn-xs text-red-500" onclick="event.stopPropagation(); confirmDeleteAccount('{{ email.id }}')" title="Delete">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr id="no-accounts-row">
                        <td colspan="4" class="text-center py-16">
                            <div class="flex flex-col items-center justify-center">
                                <img src="https://raw.githubusercontent.com/Othunderlight/static/refs/heads/main/no-accounts.svg"
                                     alt="No accounts illustration"
                                     class="w-64 h-auto mx-auto">
                                <h3 class="text-lg font-semibold text-gray-800 mb-2 mt-4">
                                    ðŸ‘‹ Connect your first email account
                                </h3>
                                <p class="text-gray-500 mb-6">
                                    Get started by connecting an email account for your campaigns
                                </p>
                                <button class="btn btn-primary" onclick="showAddAccountModal()">
                                    <i class="fa-solid fa-plus mr-2"></i>
                                    Add Email Account
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>





<!-- Right Sidebar (Drawer) -->
    <div id="sidebar" class="fixed top-0 right-0 h-full w-full sm:w-3/4 md:w-2/3 lg:w-[60%] xl:max-w-4xl bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 flex flex-col">
        
        <!-- Drawer Header -->
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
            <h2 class="text-base font-semibold text-gray-800">fdudramo@gmail.com</h2>
            <div class="flex items-center space-x-3">
                <button class="btn btn-ghost btn-circle btn-sm" aria-label="Warmup status">
                    <svg class="h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 01-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                         <!-- A more fitting fire icon: -->
                         <path d="M10 2a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 2zM5.207 6.5a.75.75 0 00-1.06 1.06l1.06-1.06zM15.854 7.56a.75.75 0 00-1.06-1.06l1.06 1.06zM5.207 13.5a.75.75 0 001.06 1.06l-1.06-1.06zM15.854 12.44a.75.75 0 001.06-1.06l-1.06 1.06zM10 18a.75.75 0 01.75-.75h.01a.75.75 0 010 1.5H10a.75.75 0 01-.75-.75zM3.75 10a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM13.25 10a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM4.146 7.56a.75.75 0 001.06-1.06L4.146 7.56zM14.793 6.5a.75.75 0 001.06 1.06l-1.06-1.06zM4.146 12.44a.75.75 0 00-1.06 1.06l1.06-1.06zM14.793 13.5a.75.75 0 00-1.06-1.06l1.06 1.06z" />
                         <path fill-rule="evenodd" d="M9.661 1.734a.75.75 0 01.678 0 11.953 11.953 0 014.288 3.033.75.75 0 01-1.06 1.06 10.453 10.453 0 00-3.758-2.618.75.75 0 01-.148 0 10.453 10.453 0 00-3.758 2.618.75.75 0 11-1.06-1.06A11.952 11.952 0 019.66 1.734zM11.75 8a.75.75 0 01.75.75v3.475c0 1.29-1.04 2.36-2.332 2.52a.75.75 0 01-.168-.01L10 14.75l-.25.01a.75.75 0 01-.168.01C8.29 14.835 7.25 13.766 7.25 12.475V8.75A.75.75 0 018.75 8v3.682c0 .482.343.874.79.962a.75.75 0 01.92-.962C10.907 11.556 11.25 11.164 11.25 10.68V8.75a.75.75 0 01.5-.75z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button class="btn btn-sm bg-white border-gray-300 font-semibold text-gray-700 hover:bg-gray-50 normal-case">
                    <span class="h-2 w-2 bg-green-500 rounded-full mr-1.5"></span>
                    <svg class="h-4 w-4 mr-1" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M3.10386 1.48062C3.28355 1.38168 3.48615 1.33186 3.69124 1.3362C3.89632 1.34053 4.09664 1.39887 4.27199 1.50531L4.27388 1.50646L4.27388 1.50646L13.2762 7.01236C13.2768 7.01269 13.2773 7.01303 13.2779 7.01336C13.4472 7.11622 13.5872 7.26089 13.6845 7.43349C13.7821 7.60665 13.8334 7.80205 13.8334 8.00082C13.8334 8.19958 13.7821 8.39499 13.6845 8.56815C13.5872 8.74075 13.4472 8.88542 13.2779 8.98828C13.2773 8.98861 13.2768 8.98894 13.2762 8.98928L4.27388 14.4952L4.27199 14.4963C4.09664 14.6028 3.89632 14.6611 3.69124 14.6654C3.48615 14.6698 3.28355 14.62 3.10386 14.521C2.92416 14.4221 2.77374 14.2775 2.66774 14.1019C2.56174 13.9263 2.50392 13.7258 2.50011 13.5207L2.5 13.5083V2.49332L2.50011 2.48094C2.50392 2.27584 2.56174 2.07538 2.66774 1.89975C2.77374 1.72413 2.92416 1.57956 3.10386 1.48062ZM3.83333 2.79996L12.337 8.00082L3.83333 13.2017V2.79996Z"></path>
                    </svg>
                    Resume
                </button>
                <button onclick="closeSidebar()" class="btn btn-ghost btn-circle btn-sm -mr-2" aria-label="Close sidebar">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Drawer Content -->
        <div class="flex-grow overflow-y-auto">
            <div class="p-6">
                <!-- Tabs -->
                <div role="tablist" class="tabs tabs-bordered">
                    <a role="tab" class="tab h-12 tab-active font-medium text-sm">Warmup</a>
                    <a role="tab" class="tab h-12 text-gray-500 font-medium text-sm">Settings</a>
                    <a role="tab" class="tab h-12 text-gray-500 font-medium text-sm">Campaigns</a>
                </div>

                <!-- Empty state content for "Warmup" tab -->
                <div class="flex flex-col items-center justify-center text-center pt-20 pb-10">
                    <!-- Illustration -->
                    <div class="max-w-[250px] mb-8">
                         <img src="https://storage.googleapis.com/maker-logo/maker-logo.svg" alt="Data analysis illustration" />
                    </div>
                    <p class="text-gray-600 mb-8 max-w-sm">Enable warmup for this account to check its performance</p>
                    <div class="flex items-center space-x-3">
                        <button class="btn normal-case bg-gray-600 hover:bg-gray-700 text-white font-semibold">Disable</button>
                        <button class="btn normal-case btn-outline border-gray-300 text-gray-800 hover:bg-gray-100 hover:border-gray-400 font-semibold">Enable</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Overlay (hidden by default) -->
<div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>














<!-- Add Account Modal -->
<dialog id="add-account-modal" class="modal">
    <div class="modal-box max-w-md">
        <h3 class="font-bold text-lg mb-4">Connect existing accounts</h3>
        <div class="space-y-4 mb-6">
            <div class="flex items-center gap-3 text-sm text-gray-600">
                <i class="fa-solid fa-check text-green-500"></i>
                <span>Connect any IMAP or SMTP email provider</span>
            </div>
        </div>
        <div class="space-y-3">
            <button class="w-full p-4 border border-gray-200 rounded-lg hover:border-gray-300 hover:bg-gray-50 flex items-center gap-3"
                    onclick="selectProvider('google')">
                <div class="w-10 h-10 bg-white rounded-lg border border-gray-200 flex items-center justify-center">
                    <i class="fab fa-google text-red-500 text-lg"></i>
                </div>
                <div class="text-left">
                    <div class="font-medium text-gray-900">Google</div>
                    <div class="text-sm text-gray-500">Gmail / G-Suite</div>
                </div>
            </button>
            <button class="w-full p-4 border border-gray-200 rounded-lg hover:border-gray-300 hover:bg-gray-50 flex items-center gap-3"
                    onclick="selectProvider('microsoft')">
                <div class="w-10 h-10 bg-white rounded-lg border border-gray-200 flex items-center justify-center">
                    <i class="fab fa-microsoft text-blue-500 text-lg"></i>
                </div>
                <div class="text-left">
                    <div class="font-medium text-gray-900">Microsoft</div>
                    <div class="text-sm text-gray-500">Office 365 / Outlook</div>
                </div>
            </button>
            <button class="w-full p-4 border border-gray-200 rounded-lg hover:border-gray-300 hover:bg-gray-50 flex items-center gap-3"
                    onclick="selectProvider('imap')">
                <div class="w-10 h-10 bg-white rounded-lg border border-gray-200 flex items-center justify-center">
                    <i class="fa-solid fa-envelope text-gray-600 text-lg"></i>
                </div>
                <div class="text-left">
                    <div class="font-medium text-gray-900">Any Provider</div>
                    <div class="text-sm text-gray-500">IMAP / SMTP</div>
                </div>
            </button>
        </div>
        <div class="modal-action">
            <button class="btn btn-ghost" onclick="ModalSystem.close('add-account-modal')">Cancel</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Basic Info Modal -->
<dialog id="basic-info-modal" class="modal">
    <div class="modal-box max-w-md">
        <div class="flex items-center gap-2 mb-4">
            <button class="btn btn-ghost btn-sm" onclick="goBackToProviders()">
                <i class="fa-solid fa-arrow-left"></i>
                Back
            </button>
            <span class="text-sm text-gray-500">Select another provider</span>
        </div>
        <div class="text-center mb-6">
            <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                <i class="fa-solid fa-envelope text-gray-600 text-lg"></i>
            </div>
            <h3 class="font-bold text-lg">Connect Any Provider Account</h3>
            <p class="text-sm text-gray-500">IMAP / SMTP</p>
        </div>
        <form id="basic-info-form" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label">
                        <span class="label-text">First Name</span>
                    </label>
                    <input type="text" placeholder="First Name" class="input input-bordered w-full bg-white" id="first-name" required>
                </div>
                <div>
                    <label class="label">
                        <span class="label-text">Last Name</span>
                    </label>
                    <input type="text" placeholder="Last Name" class="input input-bordered w-full bg-white" id="last-name" required>
                </div>
            </div>
            <div>
                <label class="label">
                    <span class="label-text">Email *</span>
                </label>
                <input type="email" placeholder="Email address to connect" class="input input-bordered w-full bg-white" id="email-address" required>
            </div>
        </form>
        <div class="modal-action">
            <button class="btn btn-success w-full text-gray-100" onclick="proceedToImapSettings()">
                Next >
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- IMAP Settings Modal -->
<dialog id="imap-settings-modal" class="modal">
    <div class="modal-box max-w-md">
        <div class="flex items-center gap-2 mb-4">
            <button class="btn btn-ghost btn-sm" onclick="goBackToBasicInfo()">
                <i class="fa-solid fa-arrow-left"></i>
                Back
            </button>
            <span class="text-sm text-gray-500">Select another provider</span>
        </div>
        <div class="text-center mb-6">
            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                <i class="fa-solid fa-download text-blue-600 text-lg"></i>
            </div>
            <h3 class="font-bold text-lg">IMAP</h3>
            <p class="text-sm text-gray-500">IMAP Setup</p>
        </div>
        <form id="imap-settings-form" class="space-y-4">
            <div>
                <label class="label">
                    <span class="label-text">IMAP Username *</span>
                </label>
                <input type="text" placeholder="IMAP Username" class="input input-bordered w-full bg-white" id="imap-username" required>
            </div>
            <div>
                <label class="label">
                    <span class="label-text">IMAP Password *</span>
                </label>
                <input type="password" placeholder="IMAP Password" class="input input-bordered w-full bg-white" id="imap-password" required>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label">
                        <span class="label-text">IMAP Host *</span>
                    </label>
                    <input type="text" placeholder="imap.example.com" class="input input-bordered w-full bg-white" id="imap-host" required>
                </div>
                <div>
                    <label class="label">
                        <span class="label-text">IMAP Port *</span>
                    </label>
                    <input type="number" placeholder="993" class="input input-bordered w-full bg-white" id="imap-port" value="993" required>
                </div>
            </div>
        </form>
        <div class="modal-action flex gap-2">
            <button class="btn btn-ghost flex-1" onclick="goBackToBasicInfo()">
                < Back
            </button>
            <button class="btn btn-success flex-1 text-gray-100" onclick="testImapConnection()">
                Next >
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Loading Modal -->
<dialog id="loading-modal" class="modal">
    <div class="modal-box max-w-sm text-center">
        <div class="mb-6">
            <div class="loading loading-spinner loading-lg text-primary mx-auto"></div>
        </div>
        <h3 class="font-bold text-lg mb-2">Testing IMAP Connection</h3>
        <p class="text-gray-600">Please wait while we verify your email settings...</p>
    </div>
</dialog>

<!-- Success Modal -->
<dialog id="success-modal" class="modal">
    <div class="modal-box max-w-sm text-center">
        <div class="mb-6">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto">
                <i class="fa-solid fa-check text-green-600 text-2xl"></i>
            </div>
        </div>
        <h3 class="font-bold text-lg mb-2">Connection Successful!</h3>
        <p class="text-gray-600 mb-6">Your email account has been connected successfully and is ready to use.</p>
        <div class="modal-action">
            <button class="btn btn-primary w-full" onclick="closeSuccessModal()">
                Done
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>

// right side bar
function openSidebar(EmailID) {
    document.getElementById('sidebar').classList.remove('translate-x-full');
    document.getElementById('overlay').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeSidebar() {
    document.getElementById('sidebar').classList.add('translate-x-full');
    document.getElementById('overlay').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

// Close sidebar when clicking on overlay
document.getElementById('overlay').addEventListener('click', closeSidebar);


// Modal Management Functions
function showAddAccountModal() {
    document.getElementById('add-account-modal').showModal();
}

function selectProvider(provider) {
    document.getElementById('add-account-modal').close();
    if (provider === 'imap' || provider === 'google' || provider === 'microsoft') {
        document.getElementById('basic-info-modal').showModal();
    }
}

function goBackToProviders() {
    document.getElementById('basic-info-modal').close();
    document.getElementById('add-account-modal').showModal();
}

function proceedToImapSettings() {
    if (document.getElementById('basic-info-form').checkValidity()) {
        document.getElementById('basic-info-modal').close();
        document.getElementById('imap-settings-modal').showModal();
    } else {
        document.getElementById('basic-info-form').reportValidity();
    }
}

function goBackToBasicInfo() {
    document.getElementById('imap-settings-modal').close();
    document.getElementById('basic-info-modal').showModal();
}

function testImapConnection() {
    if (document.getElementById('imap-settings-form').checkValidity()) {
        document.getElementById('imap-settings-modal').close();
        document.getElementById('loading-modal').showModal();
        setTimeout(() => {
            document.getElementById('loading-modal').close();
            document.getElementById('success-modal').showModal();
        }, 2000);
    } else {
        document.getElementById('imap-settings-form').reportValidity();
    }
}

function closeSuccessModal() {
    document.getElementById('success-modal').close();
}

// Initialize modals when needed
document.addEventListener('DOMContentLoaded', function() {
    // Example: Show add account modal when a button is clicked
    document.querySelector('.btn-show-account-modal').addEventListener('click', showAddAccountModal);
});



// Account filtering functionality
function filterAccounts() {
    const searchTerm = document.getElementById('search-accounts').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value.toLowerCase();
    
    const rows = document.querySelectorAll('.account-row');
    let visibleCount = 0;

    rows.forEach(row => {
        const accountText = row.textContent.toLowerCase();
        const email = row.getAttribute('data-email').toLowerCase();
        const status = row.getAttribute('data-status').toLowerCase();
        const connection = row.getAttribute('data-connection').toLowerCase();
        
        const matchesSearch = searchTerm === '' || 
                            accountText.includes(searchTerm) || 
                            email.includes(searchTerm) ||
                            connection.includes(searchTerm);
        const matchesStatus = statusFilter === '' || status === statusFilter;

        if (matchesSearch && matchesStatus) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // Update empty state
    const noAccountsRow = document.getElementById('no-accounts-row');
    if (visibleCount === 0 && rows.length > 0) {
        if (noAccountsRow) noAccountsRow.style.display = '';
    } else {
        if (noAccountsRow) noAccountsRow.style.display = 'none';
    }

    // Update counter
    document.getElementById('account-count').textContent = `${visibleCount} account${visibleCount !== 1 ? 's' : ''}`;

}

function clearAccountFilters() {
    document.getElementById('search-accounts').value = '';
    document.getElementById('status-filter').value = '';
    filterAccounts();
}

// Action functions (only for table actions, not modal actions)
function editAccount(id) {
    ModalSystem.confirm({
        title: 'Edit Account',
        message: `You are about to edit the settings for account ${id}. Do you want to proceed?`,
        confirmText: 'Edit',
        action: () => {
            ModalSystem.toast(`Opening settings for account ${id}...`);
            // In a real app, you would redirect to an edit page:
            // window.location.href = `/accounts/${id}/edit`;
        }
    });
}

function testConnection(id) {
    ModalSystem.confirm({
        title: 'Test Connection',
        message: `This will test the IMAP and SMTP connection for account ${id}.`,
        confirmText: 'Test',
        action: () => {
            ModalSystem.toast(`Testing connection for account ${id}...`, 'info');
            // Here you would trigger the backend test
        }
    });
}

function confirmDeleteAccount(id) {
    ModalSystem.confirm({
        title: 'Delete Account',
        message: `Are you sure you want to delete account ${id}? This action cannot be undone.`,
        confirmText: 'Delete',
        confirmClass: 'btn-error',
        action: () => {
            fetch(`/accounts/${id}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the row from the table
                    const row = document.querySelector(`tr[data-id="${id}"]`);
                    if (row) row.remove();
                    
                    // Update counts
                    filterAccounts();
                    
                    ModalSystem.toast('Account deleted successfully!', 'success');
                } else {
                    ModalSystem.toast('Error deleting account', 'error');
                }
            })
            .catch(error => {
                ModalSystem.toast('Error deleting account', 'error');
            });
        }
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for filters
    document.getElementById('search-accounts').addEventListener('input', filterAccounts);
    document.getElementById('status-filter').addEventListener('change', filterAccounts);
    
    // Hide empty state if we have accounts
    const noAccountsRow = document.getElementById('no-accounts-row');
    if (noAccountsRow && document.querySelectorAll('.account-row').length > 0) {
        noAccountsRow.style.display = 'none';
    }
});
</script>
{% endblock %}
