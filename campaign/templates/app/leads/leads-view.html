{% extends "base-app.html" %}

{% block title %}Leads{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-8 mt-8">
    <h1 class="text-3xl text-gray-900 mb-2">{% for list in lead_lists %}{% if list.id == lead_list_id %}{{ list.title }}{% endif %}{% endfor %}
 List</h1>
    <div class="flex items-center gap-4">
        <a href="{% url 'show_all_leads' %}" tabindex="0" role="button" class="btn text-gray-900">
            <i class="fa-regular fa-eye"></i>
            View all leads
        </a>
        <button onclick="exportLeadsToCSV()" class="btn btn-outline text-gray-900 h-10 min-h-10 rounded-lg px-4 text-sm">
            <i class="fa-solid fa-download mr-2"></i>
            Export CSV
        </button>
    </div>
  </div>
        <!-- Toolbar -->
        <div class="flex items-center justify-between mt-8">
            <div class="flex items-center gap-4">
                <label class="input input-bordered flex items-center gap-2 h-10 w-64 bg-white">
                    <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
                    <input type="text"
                           name="search"
                           id="search-input"
                           class="grow text-sm"
                           placeholder="Search leads..." />
                </label>
                <div id="stats-container" class="flex items-center gap-4 text-gray-500 text-sm p-2 rounded-lg bg-gray-100">
                    <div class="flex items-center gap-1.5" title="Total Leads">
                        <i class="fa-solid fa-users"></i>
                        <span class="font-semibold">{{ stats.total_leads }}</span>
                    </div>
                    <div class="flex items-center gap-1.5" title="Cold Leads">
                        <i class="fa-solid fa-snowflake"></i>
                        <span class="font-semibold">{{ stats.cold }}</span>
                    </div>
                    <div class="flex items-center gap-1.5" title="Warm Leads">
                        <i class="fa-solid fa-fire"></i>
                        <span class="font-semibold">{{ stats.warm }}</span>
                    </div>
                    <div class="flex items-center gap-1.5" title="LinkedIn Source">
                        <i class="fa-brands fa-linkedin"></i>
                        <span class="font-semibold">{{ stats.linkedin_source }}</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="dropdown dropdown-end">
                    <div tabindex="0" role="button" class="btn bg-white text-gray-900 border border-base-300 h-10 min-h-10 rounded-lg px-4 text-sm">
                        <i class="fa-solid fa-filter mr-2 text-gray-500"></i>Filters
                    </div>
                    <div tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-white rounded-box w-52 border border-gray-200">
                        <div class="p-2">
                            <label class="label">
                                <span class="label-text font-medium">Lead Type</span>
                            </label>
                            <select name="lead_type"
                                    id="lead-type-filter"
                                    class="select select-bordered select-sm w-full bg-white">
                                <option value="">All Types</option>
                                <option value="cold">Cold</option>
                                <option value="warm">Warm</option>
                            </select>
                        </div>
                        <div class="p-2">
                            <label class="label">
                                <span class="label-text font-medium">Source</span>
                            </label>
                            <select name="source"
                                    id="source-filter"
                                    class="select select-bordered select-sm w-full bg-white">
                                <option value="">All Sources</option>
                                <option value="linkedin">LinkedIn</option>
                                <option value="manual">Manual</option>
                            </select>
                        </div>
                    </div>
                </div>
                <a href="{% url 'add_leads' lead_list_id %}" class="btn btn-outline btn-square h-10 w-10 min-h-10" title="Import Leads"><i class="fa-solid fa-file-import"></i></a>
                <a href="{% url 'add_leads' lead_list_id %}" class="btn btn-primary h-10 min-h-10 rounded-lg px-4 text-sm">Add Leads</a>
            </div>
        </div>

        <!-- Leads Container -->
        <div id="leads-container">
            <!-- Bulk Actions Bar -->
            <div id="bulk-actions" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 mt-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-blue-700">
                        <span id="selected-count">0</span> leads selected
                    </span>
                    <div class="flex items-center gap-2">
                        <button class="btn btn-sm btn-primary"
                                onclick="addToList()"
                                id="add-to-list-btn">
                            <i class="fa-solid fa-plus mr-1"></i>
                            Move to List
                        </button>
                        <button class="btn btn-sm btn-error"
                                onclick="deleteSelected()"
                                id="delete-selected-btn">
                            <i class="fa-solid fa-trash mr-1"></i>
                            Delete Selected
                        </button>
                        <button class="btn btn-sm btn-ghost" onclick="clearSelection()">
                            Clear Selection
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table Container -->
            <div class="mt-4 flex-grow overflow-x-auto rounded-lg border border-gray-200 bg-white">
                <table class="table-auto w-full custom-table">
                    <thead>
                        <tr>
                            <th class="w-12 text-center">
                                <input type="checkbox"
                                       class="checkbox checkbox-sm rounded"
                                       id="select-all-checkbox"
                                       onchange="toggleSelectAll()" />
                            </th>
                            <th class="w-16"></th> <!-- Index number column -->
                            <th class="text-left">Lead</th>
                            <th class="text-left">Company</th>
                            <th class="text-left">Position</th>
                            <th class="text-left">Location</th>
                            <th class="text-left">Type</th>
                            <th class="text-left">Source</th>
                            <th class="text-left">Created at</th>
                            <th class="w-12"></th> <!-- Actions column -->
                        </tr>
                    </thead>
                    <tbody id="leads-table-body">
                        {% for lead in leads %}
                        <tr class="hover:bg-gray-50 lead-row">
                            <td class="text-center">
                                <input type="checkbox"
                                    class="checkbox checkbox-sm rounded lead-checkbox"
                                    value="{{ lead.id }}"
                                    onchange="updateBulkActions()" />
                            </td>
                            <td class="text-gray-500 text-center">{{ forloop.counter }}</td>
                            <td class="font-medium text-gray-700">
                                <div class="flex flex-col">
                                    <span style="font-size:16px;">{{ lead.full_name }}</span>
                                    <span class="text-sm text-gray-500">{{ lead.email }}</span>
                                    {% if lead.linkedin_profile %}
                                    <span class="text-xs text-blue-500">
                                        <a href="{{ lead.linkedin_profile }}" target="_blank" class="hover:underline" style="font-size:14px;">
                                            <i class="fa-brands fa-linkedin mr-1"></i>LinkedIn
                                        </a>
                                    </span>
                                    {% elif lead.phone_number %}
                                    <span class="text-xs text-gray-400">ðŸ“ž {{ lead.phone_number|default:"N/A" }}</span>
                                    {% else %}
                                    <span class="text-xs text-gray-400">N/A: No contact info</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="text-gray-600">
                                <div class="flex flex-col">
                                    <span style="font-size:15px;">{{ lead.company_name }}</span>
                                    {% if lead.company_website %}
                                    <span class="text-sm text-blue-500">
                                        <a href="{{ lead.company_website }}" target="_blank" class="hover:underline" style="font-size:14px;">
                                            <i class="fa-solid fa-link mr-1"></i>Website
                                        </a>
                                    </span>
                                    {% else %}
                                    <span class="text-sm text-gray-400">No website</span>
                                    {% endif %}
                                    <span class="text-xs text-gray-400">{{ lead.industry }} â€¢ {{ lead.employee_count }} employees</span>
                                </div>
                            </td>
                            <td class="text-gray-600">{{ lead.position }}</td>
                            <td class="text-gray-600">{{ lead.location|default:"N/A" }}</td>
                            <td class="text-gray-600">
                                {% if lead.lead_type == 'cold' %}
                                    <span class="badge badge-ghost gap-1 font-medium py-2">
                                        <i class="fa-solid fa-snowflake"></i> {{ lead.lead_type }}
                                    </span>
                                {% elif lead.lead_type == 'warm' %}
                                    <span class="badge badge-warning gap-1 font-medium py-2">
                                        <i class="fa-solid fa-fire"></i> {{ lead.lead_type }}
                                    </span>
                                {% elif lead.lead_type == 'hot' %}
                                    <span class="badge badge-error gap-1 font-medium py-2">
                                        <i class="fa-solid fa-fire"></i> {{ lead.lead_type }}
                                    </span>   
                                {% elif lead.lead_type == 'customer' %}
                                    <span class="badge badge-success gap-1 font-medium py-2">
                                        <i class="fa-solid fa-true"></i> {{ lead.lead_type }}
                                    </span>   
                                {% endif %}      
                            </td>
                            <td class="text-gray-600">
                                <span class="badge badge-info gap-1 font-medium py-2">
                                    {% if lead.source == 'linkedin_scrape' %}
                                        <i class="fa-brands fa-linkedin"></i> {{ lead.source }}
                                    {% else %}
                                        <i class="fa-brands fa-google"></i> {{ lead.source }}    
                                    {% endif %}
                                </span>
                            </td>
                            <td class="text-gray-600">{{ lead.created_at }}</td>
                            <td class="text-center">
                                <div class="dropdown dropdown-end dropdown-top">
                                    <div tabindex="0" role="button" class="btn btn-ghost btn-sm">
                                        <i class="fa-solid fa-ellipsis-vertical"></i>
                                    </div>
                                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-white rounded-box w-40 border border-gray-200">
                                        <li><a onclick="copyLeadDetails({{ lead.id }})" class="text-blue-600"><i class="fa-solid fa-eye mr-2"></i>Copy</a></li>
                                        <li><a onclick="addLeadToList({{ lead.id }})" class="text-green-600"><i class="fa-solid fa-plus mr-2"></i>Add to list</a></li>
                                        <li><a onclick="deleteLead({{ lead.id }})" class="text-red-600"><i class="fa-solid fa-trash mr-2"></i>Delete</a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        
                        <!-- Empty state (always present but conditionally shown) -->
                        <tr id="no-leads-row" {% if leads %}class="hidden"{% endif %}>
                            <td colspan="10" class="text-center py-16">
                                <div class="flex flex-col items-center justify-center">
                                    <!-- SVG Illustration -->
                                    <div class="mb-6 opacity-90">
                                        <img src="https://raw.githubusercontent.com/Othunderlight/static/refs/heads/main/no-campaign-lead.svg"
                                            alt="No leads illustration"
                                            class="w-64 h-auto mx-auto">
                                    </div>
                                    <!-- Message -->
                                    <div class="text-center">
                                        <h3 class="text-lg font-semibold text-gray-800 mb-2">
                                            ðŸ‘‹ Add some leads to get started
                                        </h3>
                                        <p class="text-gray-500 mb-6">
                                            Upload your leads or add them manually to start your outreach
                                        </p>
                                        <!-- Add Leads Button -->
                                        <a href="{% url 'add_leads' lead_list_id %}" class="btn btn-primary h-10 min-h-10 rounded-lg px-4 text-sm">
                                            Add Leads
                                        </a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div> <!-- End leads-container -->

        <!-- Footer -->
        <div class="py-6 text-center">
            <hr class="mb-4">
            <div class="flex items-center justify-center gap-4">
                <span class="text-sm text-gray-400" id="search-status">Showing all leads</span>
                <button class="btn btn-sm bg-white border border-gray-300" disabled>No more to load</button>
            </div>
        </div>

    </div>
</div>









<!-- Right Sidebar (Drawer) -->
<div id="sidebar" class="fixed top-0 right-0 h-full w-full sm:w-3/4 md:w-2/3 lg:w-[30%] xl:max-w-4xl bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 flex flex-col">
    
    <!-- Drawer Header -->
    <div class="flex justify-between items-center p-6 border-b border-gray-200">
        <h2 class="text-base font-semibold text-gray-800" id="sidebar-email">fdudramo@gmail.com</h2>
        <button onclick="closeSidebar()" class="btn btn-ghost btn-circle btn-sm -mr-2" aria-label="Close sidebar">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>

    <!-- Drawer Content -->
    <div class="flex-grow overflow-y-auto">
        <div class="p-6">
            <!-- Tabs -->
            <div role="tablist" class="tabs tabs-bordered">
                <a role="tab" class="tab h-12 tab-active font-medium text-sm" onclick="switchTab('settings')">Settings</a>
                <a role="tab" class="tab h-12 text-gray-500 font-medium text-sm" onclick="switchTab('campaigns')">Campaigns</a>
            </div>

            <!-- Settings Tab Content -->
            <div id="settings-tab" class="mt-6 space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label">
                            <span class="label-text font-medium">First Name</span>
                        </label>
                        <input type="text" id="first-name" class="input input-bordered w-full bg-white" placeholder="First Name">
                    </div>
                    <div>
                        <label class="label">
                            <span class="label-text font-medium">Last Name</span>
                        </label>
                        <input type="text" id="last-name" class="input input-bordered w-full bg-white" placeholder="Last Name">
                    </div>
                </div>
                <div>
                    <label class="label">
                        <span class="label-text font-medium">Signature</span>
                    </label>
                    <textarea id="signature" class="textarea textarea-bordered w-full bg-white h-24" placeholder="Your email signature"></textarea>
                </div>
                <div>
                    <label class="label">
                        <span class="label-text font-medium">Daily campaign limit</span>
                    </label>
                    <div class="flex items-center">
                        <input type="number" id="daily-campaign-limit" class="input input-bordered bg-white" value="30">
                        <span class="ml-4">emails</span>
                    </div>
                </div>
                <div>
                    <label class="label">
                        <span class="label-text font-medium">Daily sending limit</span>
                    </label>
                    <div class="flex items-center">
                        <input type="number" id="daily-sending-limit" class="input input-bordered bg-white" value="30">
                        <span class="ml-4">emails</span>
                    </div>
                </div>
                <div>
                    <label class="label">
                        <span class="label-text font-medium">Minimum wait time</span>
                    </label>
                    <div class="flex items-center">
                        <input type="number" id="min-wait-time" class="input input-bordered bg-white" value="1">
                        <span class="ml-4">minute(s)</span>
                    </div>
                    <label class="label">
                        <span class="label-text-alt">When used with multiple campaigns</span>
                    </label>
                </div>
                <button class="btn btn-primary w-full" onclick="saveSettings()">Save Settings</button>
            </div>

            <!-- Campaigns Tab Content -->
            <div id="campaigns-tab" class="mt-6 hidden">
                <p class="text-gray-600">Campaigns content goes here.</p>
            </div>
        </div>
    </div>
</div>

<!-- Overlay (hidden by default) -->
<div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>












<script>
    // right side bar
function openSidebar(email) {
    document.getElementById('sidebar').classList.remove('translate-x-full');
    document.getElementById('overlay').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    document.getElementById('sidebar-email').textContent = email;
}

function closeSidebar() {
    document.getElementById('sidebar').classList.add('translate-x-full');
    document.getElementById('overlay').classList.add('hidden');
    document.body.style.overflow = 'auto';
}



// Bulk selection functionality
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const leadCheckboxes = document.querySelectorAll('.lead-checkbox');

    leadCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });

    updateBulkActions();
}

function updateBulkActions() {
    const leadCheckboxes = document.querySelectorAll('.lead-checkbox');
    const checkedBoxes = document.querySelectorAll('.lead-checkbox:checked');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const bulkActions = document.getElementById('bulk-actions');
    const selectedCount = document.getElementById('selected-count');

    // Update select all checkbox state
    if (checkedBoxes.length === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (checkedBoxes.length === leadCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
        selectAllCheckbox.checked = false;
    }

    // Show/hide bulk actions
    if (checkedBoxes.length > 0) {
        bulkActions.classList.remove('hidden');
        selectedCount.textContent = checkedBoxes.length;
    } else {
        bulkActions.classList.add('hidden');
    }
}

function clearSelection() {
    const leadCheckboxes = document.querySelectorAll('.lead-checkbox');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');

    leadCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;

    updateBulkActions();
}

function deleteSelected() {
    const checkedBoxes = document.querySelectorAll('.lead-checkbox:checked');
    const leadIds = Array.from(checkedBoxes).map(cb => cb.value);

    if (leadIds.length === 0) return;

    ModalSystem.confirm({
        title: 'Delete Selected Leads',
        message: `Are you sure you want to delete ${leadIds.length} selected lead(s)? This action cannot be undone.`,
        confirmText: 'Delete',
        confirmClass: 'btn-error',
        action: function() {
            ModalSystem.toast('Deleting leads...', 'info');

            fetch('/api/leads/bulk-delete/', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ ids: leadIds })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                // Remove rows from UI
                checkedBoxes.forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    row.remove();
                });

                clearSelection();

                ModalSystem.toast(data.message || `${leadIds.length} lead(s) deleted successfully!`, 'success');

                // Refresh UI/stats
                htmx.trigger('#search-input', 'keyup');
            })
            .catch(error => {
                ModalSystem.toast('Failed to delete lead(s). Try again.', 'error');
                console.error('Delete error:', error);
            });
        }
    });
}


function deleteLead(leadId) {
    ModalSystem.confirm({
        title: 'Delete Lead',
        message: 'Are you sure you want to delete this lead? This action cannot be undone.',
        confirmText: 'Delete',
        confirmClass: 'btn-error',
        action: function() {
            ModalSystem.toast('Deleting lead...', 'info');

            fetch(`/api/leads/${leadId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                // No content expected on successful DELETE
                return null;
            })
            .then(() => {
                // Remove the row from the DOM
                const checkbox = document.querySelector(`input[value="${leadId}"]`);
                if (checkbox) {
                    const row = checkbox.closest('tr');
                    row.remove();
                }

                updateBulkActions();

                ModalSystem.toast('Lead deleted successfully!', 'success');

                htmx.trigger('#search-input', 'keyup');
            })
            .catch(error => {
                ModalSystem.toast('Failed to delete lead. Please try again.', 'error');
                console.error('Delete error:', error);
            });
        }
    });
}

function addLeadToList(leadId) {
    // Build the select options dynamically from the available lists
    let selectOptions = '<option value="">Select a list</option>';
    {% for list in lead_lists_assign %}
        selectOptions += '<option value="{{ list.id }}">{{ list.title|escapejs }}</option>';
    {% endfor %}

    ModalSystem.confirm({
        title: 'Add to List',
        message: `Select a list to add this lead to:`,
        confirmText: 'Add',
        confirmClass: 'btn-primary',
        html: true,  // Enable HTML rendering
        customContent: `
            <select id="list-select" class="select select-bordered w-full mt-2">
                ${selectOptions}
            </select>
        `,
        action: function() {
            const listId = document.getElementById('list-select').value;

            if (!listId) {
                ModalSystem.toast('Please select a list', 'error');
                return;
            }

            fetch('/api/leads/move-to-list/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    lead_ids: [leadId],
                    target_list_id: listId
                })
            })
            .then(response => {
                if (!response.ok) return response.json().then(err => { throw err; });
                return response.json();
            })
            .then(data => {
                ModalSystem.toast(`${data.moved_count} lead(s) moved successfully!`, 'success');
                // Remove the row from the DOM
                const checkbox = document.querySelector(`input[value="${leadId}"]`);
                if (checkbox) {
                    const row = checkbox.closest('tr');
                    row.remove();
                };
                htmx.trigger('#search-input', 'keyup'); // Refresh table/stats
            })
            .catch(error => {
                ModalSystem.toast('Failed to move lead. Please try again.', 'error');
                console.error('Move error:', error);
            });
        }
    });
}



function addToList() {
    const checkedBoxes = document.querySelectorAll('.lead-checkbox:checked');
    const leadIds = Array.from(checkedBoxes).map(cb => cb.value);

    if (leadIds.length === 0) return;

    // Build the select options dynamically from the available lists
    let selectOptions = '<option value="">Select a list</option>';
    {% for list in lead_lists_assign %}
        selectOptions += '<option value="{{ list.id }}">{{ list.title|escapejs }}</option>';
    {% endfor %}

    ModalSystem.confirm({
        title: 'Add to List',
        message: `Select a list to add ${leadIds.length} lead(s) to:`,
        confirmText: 'Add',
        confirmClass: 'btn-primary',
        html: true,  // Enable HTML rendering
        customContent: `
            <select id="list-select" class="select select-bordered w-full mt-2">
                ${selectOptions}
            </select>
        `,
        action: function() {
            const listId = document.getElementById('list-select').value;
            if (!listId) {
                ModalSystem.toast('Please select a list', 'error');
                return;
            }

            fetch('/api/leads/move-to-list/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    lead_ids: leadIds,
                    target_list_id: listId
                })
            })
            .then(response => {
                if (!response.ok) return response.json().then(err => { throw err; });
                return response.json();
            })
            .then(data => {
                ModalSystem.toast(`${data.moved_count} lead(s) moved successfully! ${data.skipped_count} lead(s) already in the target list.`, 'success');
                clearSelection();
                // Remove the row from the DOM
                leadIds.forEach(leadId => {
                const checkbox = document.querySelector(`input[value="${leadId}"]`);
                if (checkbox) {
                    const row = checkbox.closest('tr');
                    if (row) row.remove();
                    }
                });

                htmx.trigger('#search-input', 'keyup'); // Refresh table/stats
            })
            .catch(error => {
                ModalSystem.toast('Failed to move leads. Please try again.', 'error');
                console.error('Move error:', error);
            });
        }
    });
}


function clearFilters() {
    document.getElementById('search-input').value = '';
    document.getElementById('lead-type-filter').value = '';
    document.getElementById('source-filter').value = '';
    filterLeads();
}

// Filter functionality
function filterLeads() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const leadTypeFilter = document.getElementById('lead-type-filter').value.toLowerCase();
    const sourceFilter = document.getElementById('source-filter').value.toLowerCase();

    const rows = document.querySelectorAll('.lead-row');
    let visibleCount = 0;

    rows.forEach(row => {
        const leadText = row.textContent.toLowerCase();

        // Get lead type from badge
        const typeBadge = row.querySelector('.badge');
        const leadType = typeBadge ? typeBadge.textContent.toLowerCase() : '';

        // Get source from second badge
        const badges = row.querySelectorAll('.badge');
        const source = badges.length > 1 ? badges[1].textContent.toLowerCase() : '';

        const matchesSearch = searchTerm === '' || leadText.includes(searchTerm);
        const matchesType = leadTypeFilter === '' || leadType.includes(leadTypeFilter);
        const matchesSource = sourceFilter === '' || source.includes(sourceFilter);

        if (matchesSearch && matchesType && matchesSource) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // Show/hide empty state
    const noLeadsRow = document.getElementById('no-leads-row');
    if (visibleCount === 0) {
        noLeadsRow.classList.remove('hidden');
    } else {
        noLeadsRow.classList.add('hidden');
    }

    // Update search status
    const searchStatus = document.getElementById('search-status');
    if (searchStatus) {
        if (searchTerm || leadTypeFilter || sourceFilter) {
            searchStatus.textContent = `Showing ${visibleCount} of {{ stats.total_leads }} leads`;
        } else {
            searchStatus.textContent = 'Showing all leads';
        }
    }
}



function copyLeadDetails(leadId) {
    // Find the lead row
    const row = document.querySelector(`input[value="${leadId}"]`).closest('tr');
    
    if (!row) {
        ModalSystem.toast('Lead not found', 'error');
        return;
    }
    
    // Extract lead information from the row
    const nameElement = row.querySelector('td:nth-child(3) span');
    const emailElement = row.querySelector('td:nth-child(3) span.text-sm');
    const linkedinElement = row.querySelector('td:nth-child(3) a[href*="linkedin"]');
    const phoneElement = Array.from(row.querySelectorAll('td:nth-child(3) span')).find(el => el.textContent.includes('ðŸ“ž'));
    
    const companyElement = row.querySelector('td:nth-child(4) span');
    const websiteElement = row.querySelector('td:nth-child(4) a[href]');
    const industryElement = row.querySelector('td:nth-child(4) span.text-xs');
    
    const positionElement = row.querySelector('td:nth-child(5)');
    const locationElement = row.querySelector('td:nth-child(6)');
    const typeElement = row.querySelector('td:nth-child(7) .badge');
    const sourceElement = row.querySelector('td:nth-child(8) .badge');
    const createdElement = row.querySelector('td:nth-child(9)');
    
    // Format the lead details
    const leadDetails = `
        Name: ${nameElement ? nameElement.textContent.trim() : 'N/A'}
        Email: ${emailElement ? emailElement.textContent.trim() : 'N/A'}
        ${linkedinElement ? `LinkedIn: ${linkedinElement.href}` : ''}
        ${phoneElement ? `Phone: ${phoneElement.textContent.replace('ðŸ“ž ', '').trim()}` : ''}

        Company: ${companyElement ? companyElement.textContent.trim() : 'N/A'}
        ${websiteElement ? `Website: ${websiteElement.href}` : ''}
        ${industryElement ? `Industry & Size: ${industryElement.textContent.trim()}` : ''}

        Position: ${positionElement ? positionElement.textContent.trim() : 'N/A'}
        Location: ${locationElement ? locationElement.textContent.trim() : 'N/A'}
        Lead Type: ${typeElement ? typeElement.textContent.trim() : 'N/A'}
        Source: ${sourceElement ? sourceElement.textContent.trim() : 'N/A'}
        Created: ${createdElement ? createdElement.textContent.trim() : 'N/A'}
    `.trim();
    
    // Copy to clipboard
    navigator.clipboard.writeText(leadDetails)
        .then(() => {
            ModalSystem.toast('Lead details copied to clipboard!', 'success');
        })
        .catch(err => {
            console.error('Failed to copy lead details: ', err);
            ModalSystem.toast('Failed to copy lead details', 'error');
        });
}


function exportLeadsToCSV() {
    // Get all visible leads (after filtering)
    const visibleRows = Array.from(document.querySelectorAll('.lead-row')).filter(row => {
        return window.getComputedStyle(row).display !== 'none';
    });
    
    if (visibleRows.length === 0) {
        ModalSystem.toast('No leads to export', 'warning');
        return;
    }
    
    // Create CSV header
    let csvContent = "Name,Email,LinkedIn,Phone,Company,Website,Industry,Employee Count,Position,Location,Lead Type,Source,Created At\n";
    
    // Add data for each visible lead
    visibleRows.forEach(row => {
        // Extract data from each cell
        const nameElement = row.querySelector('td:nth-child(3) span');
        const emailElement = row.querySelector('td:nth-child(3) span.text-sm');
        const linkedinElement = row.querySelector('td:nth-child(3) a[href*="linkedin"]');
        const phoneElement = Array.from(row.querySelectorAll('td:nth-child(3) span')).find(el => el.textContent.includes('ðŸ“ž'));
        
        const companyElement = row.querySelector('td:nth-child(4) span');
        const websiteElement = row.querySelector('td:nth-child(4) a[href]');
        const industryElement = row.querySelector('td:nth-child(4) span.text-xs');
        
        const positionElement = row.querySelector('td:nth-child(5)');
        const locationElement = row.querySelector('td:nth-child(6)');
        const typeElement = row.querySelector('td:nth-child(7) .badge');
        const sourceElement = row.querySelector('td:nth-child(8) .badge');
        const createdElement = row.querySelector('td:nth-child(9)');
        
        // Parse industry and employee count
        let industry = '';
        let employeeCount = '';
        if (industryElement) {
            const industryText = industryElement.textContent.trim();
            const parts = industryText.split(' â€¢ ');
            industry = parts[0] || '';
            employeeCount = parts.length > 1 ? parts[1].replace(' employees', '').trim() : '';
        }
        
        // Parse phone number
        let phone = '';
        if (phoneElement) {
            phone = phoneElement.textContent.replace('ðŸ“ž ', '').trim();
        }
        
        // Parse lead type (remove icon)
        let leadType = '';
        if (typeElement) {
            leadType = typeElement.textContent.trim();
        }
        
        // Parse source (remove icon)
        let source = '';
        if (sourceElement) {
            source = sourceElement.textContent.trim();
        }
        
        // Add row to CSV (escape commas and quotes)
        const name = nameElement ? `"${nameElement.textContent.trim().replace(/"/g, '""')}"` : 'N/A';
        const email = emailElement ? `"${emailElement.textContent.trim().replace(/"/g, '""')}"` : 'N/A';
        const linkedin = linkedinElement ? `"${linkedinElement.href.replace(/"/g, '""')}"` : 'N/A';
        const company = companyElement ? `"${companyElement.textContent.trim().replace(/"/g, '""')}"` : 'N/A';
        const website = websiteElement ? `"${websiteElement.href.replace(/"/g, '""')}"` : 'N/A';
        const position = positionElement ? `"${positionElement.textContent.trim().replace(/"/g, '""')}"` : 'N/A';
        const location = locationElement ? `"${locationElement.textContent.trim().replace(/"/g, '""')}"` : 'N/A';
        const created = createdElement ? `"${createdElement.textContent.trim().replace(/"/g, '""')}"` : 'N/A';
        
        csvContent += `${name},${email},${linkedin},"${phone}",${company},${website},"${industry}","${employeeCount}",${position},${location},"${leadType}","${source}",${created}\n`;
    });
    
    // Create download link
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    
    // Get list name for filename
    let listName = "leads";
    const listTitleElement = document.querySelector('h1');
    if (listTitleElement) {
        listName = listTitleElement.textContent.replace(' List', '').trim().toLowerCase().replace(/\s+/g, '_');
    }
    
    link.setAttribute('download', `${listName}_export_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    ModalSystem.toast(`Exported ${visibleRows.length} leads to CSV`, 'success');
}



// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateBulkActions();

    // Add event listeners for filters
    document.getElementById('search-input').addEventListener('input', filterLeads);
    document.getElementById('lead-type-filter').addEventListener('change', filterLeads);
    document.getElementById('source-filter').addEventListener('change', filterLeads);
});
</script>
{% endblock %}
