{% load static %}

<style>
        /* Custom transition for the chat widget */
        #chat-widget {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        /* Hide scrollbar for the main content area but keep it scrollable */
        #chat-log, main {
            scrollbar-width: none;  /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        #chat-log::-webkit-scrollbar, main::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
    </style>



    <!-- Container for the entire chat component, fixed to the bottom right -->
    <div id="chat-container" class="fixed bottom-5 right-5 z-50">

        <!-- The Chat Widget Window (themed) -->
        <div id="chat-widget" class="w-[400px] h-[700px] max-h-[calc(100vh-100px)] flex flex-col bg-base-100 rounded-2xl shadow-2xl overflow-hidden hidden opacity-0 transform translate-y-4 scale-95 absolute bottom-[80px] right-0">
            
            <!-- Header section: dynamically populated by JavaScript -->
            <div id="chat-header"></div>
            
            <!-- Main content area for pages -->
            <main class="flex-grow overflow-y-auto relative">
                
                <!-- Page 1: Home (Content and Formatting REVISED) -->
                <div id="page-home" class="page-content">
                    <div class="pt-6 pb-8 px-4 text-primary-content bg-primary">
                        <div class="flex justify-end items-center mb-4">
                            <div class="flex -space-x-3">
                                <img class="inline-block h-9 w-9 rounded-full ring-2 ring-base-100" src="{% static 'imgs/ahmad-avatar-linkedin.jpeg' %}"/>
                                <img class="inline-block h-9 w-9 rounded-full ring-2 ring-base-100" src="{% static 'imgs/my-avatar-linkedin.jpeg' %}"/>
                            </div>
                        </div> 
                        <h1 class="text-3xl font-bold">Hi {{ user.first_name }} ðŸ‘‹</h1>
                        <h2 class="text-3xl font-bold mt-1">How can we help? ðŸš€</h2>
                    </div>
                    <div class="p-4 space-y-3 mt-0">
                        <div id="action-send-message-home" class="bg-base-200 p-4 rounded-xl shadow-md flex justify-between items-center cursor-pointer hover:bg-base-300">
                            <div>
                                <p class="font-semibold text-base-content">Send us a message</p>
                                <p class="text-sm text-base-content/70">We typically reply in a few hours</p>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                            </svg>
                        </div>
                        
                        <!-- REWRITTEN AND REFORMATTED Informational Card -->
                        <div class="bg-base-100 p-4 rounded-xl shadow-md">
                            <ul class="space-y-4">
                                <li class="flex items-start gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-info shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                    </svg>
                                    <span class="text-m text-base-content/80">
                                        <b>For the fastest help,</b> please be as descriptive as possible. Screenshots are always welcome!
                                    </span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-success shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                                    </svg>
                                    <span class="text-m text-base-content/80">
                                        Our team typically responds via chat, telegram, and email <i>as soon as possible</i>.
                                    </span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-success shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.269.655 4.516 1.905 6.462l-1.299 4.745 4.833-1.276z"/>
                                    </svg>
                                    <span class="text-m text-base-content/80">
                                        For urgent issues, you can reach me (the founder) directly on 
                                        <a href="https://wa.me/+963939676801" target="_blank" rel="noopener noreferrer" class="link link-success font-semibold">WhatsApp</a>.
                                    </span>
                                </li>
                            </ul>
                        </div>

                        <div class="mt-4">
                            <!-- Optional: A subtle heading for the section -->
                            <h3 class="text-xs font-semibold text-base-content/50 uppercase tracking-wider text-center mb-2">Quick Links</h3>

                            <div class="grid grid-cols-2 gap-3">

                                <!-- Email Us Link Card -->
                                <a href="mailto:ahmad@gatara.org" 
                                class="group flex flex-col items-center justify-center p-4 rounded-xl shadow-sm bg-base-200 hover:bg-base-300 transition-colors cursor-pointer text-center">
                                    
                                    <!-- Themed Icon Wrapper -->
                                    <div class="w-10 h-10 rounded-full bg-accent/20 text-accent flex items-center justify-center mb-2 transition-transform group-hover:scale-110">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                        </svg>
                                    </div>
                                    
                                    <p class="font-semibold text-sm text-base-content">Email</p>
                                    <!-- <p class="text-xs text-base-content/60">For general questions</p> -->
                                </a>

                                <!-- Telegram Link Card (UPDATED) -->
                                <a href="https://t.me/Omar_Gatara"
                                    target="_blank" rel="noopener noreferrer" 
                                    class="group flex flex-col items-center justify-center p-4 rounded-xl shadow-sm bg-base-200 hover:bg-base-300 transition-colors cursor-pointer text-center">

                                    <!-- Themed Icon Wrapper (UPDATED to use 'info' color for blue) -->
                                    <div class="w-10 h-10 rounded-full bg-info/20 text-info flex items-center justify-center mb-2 transition-transform group-hover:scale-110">
                                        <!-- UPDATED SVG Icon for Telegram -->
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 512 512">
                                            <path d="M477,43.86,13.32,223.29a5.86,5.86,0,0,0-.8.38c-3.76,2.13-30,18.18,7,32.57l.38.14,110.41,35.67a6.08,6.08,0,0,0,5.09-.62L409.25,120.57a6,6,0,0,1,2.2-.83c3.81-.63,14.78-1.81,7.84,7-7.85,10-194.9,177.62-215.66,196.21a6.3,6.3,0,0,0-2.07,4.17l-9.06,108a7.08,7.08,0,0,0,2.83,5.67,6.88,6.88,0,0,0,8.17-.62l65.6-58.63a6.09,6.09,0,0,1,7.63-.39l114.45,83.1.37.25c2.77,1.71,32.69,19.12,41.33-19.76l79-375.65c.11-1.19,1.18-14.27-8.17-22-9.82-8.08-23.72-4-25.81-3.56A6,6,0,0,0,477,43.86Z"/>
                                        </svg>
                                    </div>
                                    
                                    <p class="font-semibold text-sm text-base-content">Telegram</p>
                                    <!-- <p class="text-xs text-base-content/60">For urgent issues</p> -->
                                </a>


                            </div>
                        </div>

                    </div>
                </div>
                
                <!-- Page 2: Messages (themed) -->
                <div id="page-messages" class="page-content hidden h-full bg-base-100">
                     <div class="px-4">
                        <div class="flex items-start py-4 cursor-pointer border-t border-base-200">
                           <img class="w-10 h-10 rounded-full mr-4 mt-1" src="{% static 'vibereach-logo.png' %}" alt="Reio avatar">
                            <div class="flex-grow">
                                <div class="flex justify-between items-center mb-1">
                                    <p class="font-semibold text-base-content">Reio</p>
                                    <p class="text-sm text-base-content/60">8w ago</p>
                                </div>
                                <p class="text-base-content/80">Want to learn how to use and set up In...</p>
                            </div>
                        </div>
                    </div>
                     <div class="absolute bottom-[70px] left-0 right-0 p-4 bg-base-100">
                        <button id="action-send-message-messages" class="btn btn-primary w-full text-base">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            Start New Conversation
                        </button>
                    </div>
                </div>
                
                <!-- Page 4: Chat (themed and corrected) -->
                <div id="page-chat" class="page-content hidden flex flex-col h-full bg-base-100">
                    <div id="chat-log" class="flex-grow p-4 space-y-4 overflow-y-auto">
                        <div class="text-center text-xs text-base-content/60 my-2">Thanks for reaching out to us!</div>
                        <div class="flex justify-start"><div class="bg-base-200 text-base-content p-3 rounded-2xl rounded-bl-none max-w-[80%]"><p>Hi fdud! This is a bot speaking. I'm here to answer your questions, but you'll always have the option to talk to our team.</p></div></div>
                        <div class="flex justify-start"><div class="bg-base-200 text-base-content p-3 rounded-2xl rounded-bl-none max-w-[80%]"><p>So what brings you here today? I can assist you better if you provide as many details as possible about your needs.</p><p class="text-xs text-base-content/60 mt-1">Fin Bot â€¢ Just now</p></div></div>
                         <!-- CORRECTED USER CHAT BUBBLE -->
                         <div class="flex justify-end"><div class="bg-primary text-primary-content p-3 rounded-2xl rounded-br-none max-w-[80%]">hi</div></div>
                    </div>
                    <div class="p-3 bg-base-100 border-t border-base-200"><div class="p-2"><textarea id="chat-input" placeholder="Message..." class="w-full border-base-300 rounded-lg focus:ring-0 focus:border-primary p-2 resize-none placeholder-base-content/50" rows="1"></textarea>
                        <div class="flex justify-between items-center mt-2">
                            <div class="flex items-center space-x-3 text-base-content/50">
                                <!-- <svg id="file-btn" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 cursor-pointer hover:text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg> -->
                            </div>
                            <!-- CORRECTED SEND BUTTON: Uses btn-primary when active -->
                           
                            <button id="send-btn" 
                            class="bg-gray-200 w-9 h-9 rounded-full flex items-center justify-center cursor-not-allowed transition-colors">
                            <svg class="h-5 w-5 text-white transform rotate-90" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                            </button></div></div></div>
                </div>
            </main>

            <!-- Bottom Navigation (themed and corrected) -->
            <nav id="bottom-nav" class="border-t border-base-200 bg-base-100 flex justify-around">
                <!-- CORRECTED ACTIVE TAB COLOR -->
                <button data-page="home" class="nav-tab flex-1 flex flex-col items-center py-2.5 text-primary"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg><span class="text-xs font-semibold">Home</span></button>
                <button id="chat-msg-tab" data-page="messages" class="nav-tab flex-1 flex flex-col items-center py-2.5 text-base-content/60 hover:text-primary"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg><span class="text-xs">Messages</span></button>
            </nav>
        </div>

        <!-- Master Toggle Button (themed and corrected) -->
        <button id="chat-toggle-button" class="btn btn-primary btn-circle btn-lg w-16 h-16 rounded-full shadow-lg flex items-center justify-center transition-transform duration-300">
            <svg id="open-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
            <svg id="close-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
        </button>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const toggleButton = document.getElementById('chat-toggle-button');
    const openIcon = document.getElementById('open-icon');
    const closeIcon = document.getElementById('close-icon');
    const chatWidget = document.getElementById('chat-widget');
    const navTabs = document.querySelectorAll('.nav-tab');
    const pages = document.querySelectorAll('.page-content');
    const chatHeader = document.getElementById('chat-header');
    const bottomNav = document.getElementById('bottom-nav');
    const sendMessageHomeBtn = document.getElementById('action-send-message-home');
    const sendMessageMessagesBtn = document.getElementById('action-send-message-messages');
    const chatLog = document.getElementById('chat-log');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    
    // Support Chat State
    let currentSessionId = null;
    let isLoading = false;
    let lastMessageCount = 0;
    let lastMessageTimestamp = null;
    let isChatFocused = false;
    let focusPollingInterval = null;
    let processedMessageIds = new Set(); // Track processed messages to avoid duplicates
    
    // API Configuration
    const API_BASE = '/support/api';
    
    // CSRF Token Helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // API Helper Functions
    async function apiRequest(url, options = {}) {
        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            credentials: 'same-origin'
        };
        const response = await fetch(url, { ...defaultOptions, ...options });
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    }
    
    // Support API Functions
    async function sendSupportMessage(content, sessionId = null) {
        const data = {
            content: content,
            message_type: 'text',
            page_url: window.location.href,
            subject: 'Support Request'
        };
        if (sessionId) {
            data.session_id = sessionId;
        }
        return await apiRequest(`${API_BASE}/messages/`, {
            method: 'POST',
            body: JSON.stringify(data)
        });
    }
    
    async function getSessionMessages(sessionId) {
        return await apiRequest(`${API_BASE}/sessions/${sessionId}/messages/`);
    }
    
    async function getUserSessions() {
        return await apiRequest(`${API_BASE}/sessions/`);
    }
    
    // UI Helper Functions
    function showLoading() {
        isLoading = true;
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>';
    }
    
    function hideLoading() {
        isLoading = false;
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<svg class="h-5 w-5 text-white transform -rotate-90" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>';
    }
    
    function addMessageToChat(message, isUser = false) {
        // Check if we've already processed this message to avoid duplicates
        const messageId = message.id || `${message.content}-${message.created_at}-${isUser}`;
        if (processedMessageIds.has(messageId)) {
            return;
        }
        
        // Mark this message as processed
        processedMessageIds.add(messageId);
        
        const messageElement = document.createElement('div');
        const timestamp = new Date(message.created_at || Date.now()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        if (isUser) {
            messageElement.className = 'flex justify-end opacity-0 transition-opacity duration-300';
            messageElement.innerHTML = `
                <div class="bg-primary text-primary-content p-3 rounded-2xl rounded-br-none max-w-[80%]">
                    ${message.content.replace(/\n/g, "<br>")}
                    <p class="text-xs text-primary-200 mt-1">${timestamp}</p>
                </div>
            `;
        } else {
            messageElement.className = 'flex justify-start opacity-0 transition-opacity duration-300';
            const agentName = message.support_agent_name || 'Support Team';
            messageElement.innerHTML = `
                <div class="bg-gray-100 text-gray-800 p-3 rounded-2xl rounded-bl-none max-w-[80%]">
                    ${message.content.replace(/\n/g, "<br>")}
                    <p class="text-xs text-gray-500 mt-1">${agentName} â€¢ ${timestamp}</p>
                </div>
            `;
        }
        
        chatLog.appendChild(messageElement);
        
        // Trigger fade-in animation
        setTimeout(() => {
            messageElement.classList.remove('opacity-0');
            messageElement.classList.add('opacity-100');
        }, 10);
        
        chatLog.scrollTop = chatLog.scrollHeight;
    }
    
    function clearChatLog() {
        chatLog.innerHTML = '<div class="text-center text-xs text-gray-500 my-2">Thanks for reaching out to us!</div>';
        processedMessageIds.clear(); // Clear processed messages when starting a new chat
    }
    
    // Focus-based polling functions
    function startFocusPolling() {
        if (focusPollingInterval || !currentSessionId) return;
        
        focusPollingInterval = setInterval(async () => {
            if (!isChatFocused || !currentSessionId) return;
            
            try {
                const messages = await getSessionMessages(currentSessionId);
                
                // Check if there are new messages
                if (messages.length > lastMessageCount) {
                    // Only load new messages to avoid UI flicker
                    const newMessages = messages.slice(lastMessageCount);
                    newMessages.forEach(message => {
                        // Only add messages that aren't from the current user
                        // This prevents duplicating user messages
                        if (message.sender !== 'user') {
                            addMessageToChat(message, false);
                        }
                    });
                    
                    lastMessageCount = messages.length;
                    
                    // Update the timestamp of the last message
                    if (messages.length > 0) {
                        const lastMessage = messages[messages.length - 1];
                        lastMessageTimestamp = new Date(lastMessage.created_at);
                    }
                    
                    // Show a notification for new messages if tab is not visible
                    if (document.hidden) {
                        showNewMessageNotification();
                    }
                }
            } catch (error) {
                console.error('Error polling messages:', error);
            }
        }, 10000); // Poll every 10 seconds (10,000ms)
    }
    
    function stopFocusPolling() {
        if (focusPollingInterval) {
            clearInterval(focusPollingInterval);
            focusPollingInterval = null;
        }
        isChatFocused = false;
    }
    
    // Setup chat focus detection
    function setupChatFocusDetection() {
        const chatWidget = document.getElementById('chat-widget');
        const chatInput = document.getElementById('chat-input');
        
        // Focus detection for the entire chat widget
        chatWidget.addEventListener('mouseenter', () => {
            if (!isChatFocused && currentSessionId) {
                isChatFocused = true;
                startFocusPolling();
            }
        });
        
        chatWidget.addEventListener('mouseleave', () => {
            // Add a small delay before stopping polling to avoid rapid toggling
            setTimeout(() => {
                if (!chatWidget.matches(':hover') && !chatInput.matches(':focus')) {
                    isChatFocused = false;
                }
            }, 1000);
        });
        
        // Focus detection for the chat input
        chatInput.addEventListener('focus', () => {
            if (!isChatFocused && currentSessionId) {
                isChatFocused = true;
                startFocusPolling();
            }
        });
        
        chatInput.addEventListener('blur', () => {
            // Add a small delay before stopping polling
            setTimeout(() => {
                if (!chatWidget.matches(':hover') && !chatInput.matches(':focus')) {
                    isChatFocused = false;
                }
            }, 1000);
        });
        
        // Also check when the window gains focus
        window.addEventListener('focus', () => {
            if (currentSessionId && chatWidget.classList.contains('hidden') === false) {
                isChatFocused = true;
                startFocusPolling();
            }
        });
        
        window.addEventListener('blur', () => {
            isChatFocused = false;
        });
    }
    
    // Show notification for new messages
    function showNewMessageNotification() {
        // Only show if the browser supports notifications and permission is granted
        if ("Notification" in window && Notification.permission === "granted") {
            new Notification("New Support Message", {
                body: "You have a new message from the support team",
                icon: "{% static 'vibereach-logo.png' %}"
            });
        }
    }
    
    // Request notification permission
    function requestNotificationPermission() {
        if ("Notification" in window && Notification.permission === "default") {
            Notification.requestPermission();
        }
    }
    
    function showErrorMessage(message) {
        const errorElement = document.createElement('div');
        errorElement.className = 'flex justify-center my-2 opacity-0 transition-opacity duration-300';
        errorElement.innerHTML = `
            <div class="bg-red-100 text-red-800 px-3 py-2 rounded-lg text-sm">
                ${message}
            </div>
        `;
        chatLog.appendChild(errorElement);
        
        // Trigger fade-in animation
        setTimeout(() => {
            errorElement.classList.remove('opacity-0');
            errorElement.classList.add('opacity-100');
        }, 10);
        
        chatLog.scrollTop = chatLog.scrollHeight;
    }
    
    // Load chat messages for a session
    async function loadChatMessages(sessionId) {
        try {
            const messages = await getSessionMessages(sessionId);
            clearChatLog();
            lastMessageCount = messages.length;
            
            // Store the timestamp of the last message
            if (messages.length > 0) {
                const lastMessage = messages[messages.length - 1];
                lastMessageTimestamp = new Date(lastMessage.created_at);
            }
            
            messages.forEach(message => {
                addMessageToChat(message, message.sender === 'user');
            });
        } catch (error) {
            console.error('Error loading messages:', error);
            showErrorMessage('Failed to load messages. Please try again.');
        }
    }
    
    // Load user sessions for messages page
    async function loadUserSessions() {
        try {
            const sessions = await getUserSessions();
            const messagesContainer = document.querySelector('#page-messages .px-4');
            if (sessions.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-500">No conversations yet</p>
                        <p class="text-sm text-gray-400 mt-2">Start a conversation to see it here</p>
                    </div>
                `;
                return;
            }
            messagesContainer.innerHTML = sessions.map(session => {
                const lastMessage = session.messages && session.messages.length > 0
                    ? session.messages[session.messages.length - 1]
                    : null;
                const timeAgo = new Date(session.updated_at).toLocaleDateString();
                return `
                    <div class="flex items-start py-4 cursor-pointer border-t border-gray-200 hover:bg-gray-50"
                         onclick="openChatSession('${session.id}')">
                        <img class="w-10 h-10 rounded-full mr-4 mt-1"
                             src="{% static 'vibereach-logo.png' %}" alt="Session avatar">
                        <div class="flex-grow">
                            <div class="flex justify-between items-center mb-1">
                                <p class="font-semibold text-gray-900">${session.subject || 'Support Chat'}</p>
                                <p class="text-sm text-gray-500">${timeAgo}</p>
                            </div>
                            <p class="text-gray-600 truncate">
                                ${lastMessage ? lastMessage.content.substring(0, 50) + '...' : 'No messages yet'}
                            </p>
                            <div class="flex items-center mt-1">
                                <span class="text-xs px-2 py-1 rounded-full ${session.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}">
                                    ${session.is_active ? 'Active' : 'Closed'}
                                </span>
                                <span class="text-xs text-gray-500 ml-2">${session.message_count} messages</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading sessions:', error);
        }
    }
    
    // Open existing chat session
    window.openChatSession = async function(sessionId) {
        currentSessionId = sessionId;
        showPage('chat');
        await loadChatMessages(sessionId);
        // Don't start polling here, wait for focus
    };
    
    function addWelcomeMessage() {
        const welcomeElement = document.createElement('div');
        welcomeElement.className = 'flex justify-start opacity-0 transition-opacity duration-300';
        welcomeElement.innerHTML = `
            <div class="bg-gray-100 text-gray-800 p-3 rounded-2xl rounded-bl-none max-w-[80%]">
                <p>Hi! ðŸ‘‹ Welcome to our support chat.</p>
                <p class="mt-2">How can we help you today? Please describe your issue in detail so we can assist you better.</p>
                <p class="text-xs text-gray-500 mt-1">Support Team â€¢ Just now</p>
            </div>
        `;
        chatLog.appendChild(welcomeElement);
        
        // Trigger fade-in animation
        setTimeout(() => {
            welcomeElement.classList.remove('opacity-0');
            welcomeElement.classList.add('opacity-100');
        }, 10);
        
        chatLog.scrollTop = chatLog.scrollHeight;
    }
    
    // Page Headers
    const headers = {
        home: '',
        messages: `<div class="flex items-center justify-center p-4 border-b bg-white"><h2 class="text-xl font-bold text-gray-800">Messages</h2></div>`,
        help: `<div class="flex items-center justify-center p-4 border-b bg-white"><h2 class="text-xl font-bold text-gray-800">Help</h2></div>`,
        chat: `<div class="flex items-center justify-between p-3 border-b bg-white shadow-sm"><button id="back-to-home-btn" class="text-gray-600 p-1 rounded-full hover:bg-gray-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button><div class="flex items-center space-x-2"><img class="w-8 h-8 rounded-full" src="{% static 'vibereach-logo.png' %}" alt="Support Avatar"><p class="font-bold text-gray-800">Support Team</p></div><button class="text-gray-600 p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" /></svg></button></div>`
    };
    
    // Widget Toggle
    const toggleWidget = () => {
        const isHidden = chatWidget.classList.contains('hidden');
        if (isHidden) {
            chatWidget.classList.remove('hidden');
            setTimeout(() => chatWidget.classList.remove('opacity-0', 'translate-y-4', 'scale-95'), 10);
            openIcon.classList.add('hidden');
            closeIcon.classList.remove('hidden');
            
            // Check if we should start polling when opening the widget
            if (currentSessionId) {
                isChatFocused = true;
                startFocusPolling();
            }
        } else {
            chatWidget.classList.add('opacity-0', 'translate-y-4', 'scale-95');
            setTimeout(() => {
                chatWidget.classList.add('hidden');
                stopFocusPolling(); // Stop polling when widget is closed
            }, 300);
            openIcon.classList.remove('hidden');
            closeIcon.classList.add('hidden');
        }
    };
    
    // Page Navigation
    const showPage = (pageId) => {
        pages.forEach(page => page.classList.add('hidden'));
        document.getElementById(`page-${pageId}`).classList.remove('hidden');
        navTabs.forEach(tab => {
            const isActive = tab.dataset.page === pageId;
            tab.classList.toggle('text-primary-600', isActive);
            tab.classList.toggle('text-gray-500', !isActive);
            tab.querySelector('span').classList.toggle('font-semibold', isActive);
        });
        chatHeader.innerHTML = headers[pageId] || '';
        bottomNav.classList.toggle('hidden', pageId === 'chat');
        
        // Page-specific actions
        if (pageId === 'chat') {
            // Add back button listener
            setTimeout(() => {
                const backBtn = document.getElementById('back-to-home-btn');
                if (backBtn) {
                    backBtn.addEventListener('click', () => {
                        showPage('home');
                        stopFocusPolling();
                        currentSessionId = null;
                    });
                }
            }, 100);
            
            // Set up focus detection for chat
            setupChatFocusDetection();
            
            // Request notification permission
            requestNotificationPermission();
            
            // Start new chat if no session
            if (!currentSessionId) {
                clearChatLog();
                addWelcomeMessage();
            }
            
            // Check if widget is already focused
            const chatWidget = document.getElementById('chat-widget');
            if (chatWidget.matches(':hover') || document.getElementById('chat-input').matches(':focus')) {
                isChatFocused = true;
                startFocusPolling();
            }
        } else if (pageId === 'messages') {
            loadUserSessions();
            stopFocusPolling();
        }
    };
    
    // Message Handling
    const handleSendMessage = async () => {
        const messageText = chatInput.value.trim();
        if (messageText === '' || isLoading) return;
        
        // Add user message to UI immediately
        const userMessage = {
            content: messageText,
            created_at: new Date().toISOString(),
            id: `user-${Date.now()}` // Temporary ID for user messages
        };
        addMessageToChat(userMessage, true);
        
        // Clear input and show loading
        chatInput.value = '';
        chatInput.dispatchEvent(new Event('input'));
        showLoading();
        
        try {
            // Send message to backend
            const response = await sendSupportMessage(messageText, currentSessionId);
            
            // Set session ID if this is a new chat
            if (!currentSessionId) {
                currentSessionId = response.session_id;
                startFocusPolling(); // Start polling for replies
            }
            
            console.log('Message sent successfully:', response);
        } catch (error) {
            console.error('Error sending message:', error);
            showErrorMessage('Failed to send message. Please try again.');
        } finally {
            hideLoading();
        }
    };
    
    // Input Handling
    chatInput.addEventListener('input', () => {
        chatInput.style.height = 'auto';
        chatInput.style.height = `${chatInput.scrollHeight}px`;
        if (chatInput.value.trim() !== '' && !isLoading) {
            sendBtn.classList.remove('bg-gray-200', 'cursor-not-allowed');
            sendBtn.classList.add('bg-primary', 'cursor-pointer');
        } else {
            sendBtn.classList.add('bg-gray-200', 'cursor-not-allowed');
            sendBtn.classList.remove('bg-primary', 'cursor-pointer');
        }
    });
    
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSendMessage();
        }
    });
    
    // Event Listeners
    sendBtn.addEventListener('click', handleSendMessage);
    toggleButton.addEventListener('click', toggleWidget);
    navTabs.forEach(tab => tab.addEventListener('click', () => showPage(tab.dataset.page)));
    sendMessageHomeBtn.addEventListener('click', () => showPage('chat'));
    sendMessageMessagesBtn.addEventListener('click', () => {
        // Start new conversation
        currentSessionId = null;
        stopFocusPolling();
        showPage('chat');
    });
    
    // Initialize
    showPage('home');
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        stopFocusPolling();
    });
});
</script>