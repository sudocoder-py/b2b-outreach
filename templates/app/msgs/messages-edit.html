{% extends "base-app.html" %}
{% block title %}Edit Messages{% endblock %}
{% block content %}
<style>
/* Custom styles for messages */
.message-row {
    cursor: pointer;
    transition: all 0.2s ease;
}
.message-row:hover {
    background-color: #f8fafc;
}
.message-row.active-message {
    background-color: #faf9f5;
    border-left: 4px solid #3d3d3a;
}
#message-preview {
    display: none;
    padding: 2rem;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    line-height: 1.6;
    color: #333;
}
#message-preview h1,
#message-preview h2,
#message-preview h3 {
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    font-weight: 600;
}
#message-preview p {
    margin-bottom: 1rem;
}
#message-preview a {
    text-decoration: underline;
}
#message-preview .btn {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    text-decoration: none;
    margin: 1rem 0;
}
#message-preview .signature {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #e5e7eb;
}
#edit-preview-btn {
    position: absolute;
    top: 1rem;
    right: 1rem;
}
/* Search and filter styles */
#search-messages {
    transition: all 0.3s ease;
}
#search-messages:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
#filter-type {
    min-width: 120px;
}

/* ADD THIS NEW CSS CLASS TO YOUR <style> TAG */
.text-editor-style {
    font-family: 'Product Sans' !important;
    font-size: 1rem; /* 16px */
    line-height: 1.6;
    padding: 0.5rem 0.75rem;
    border-width: 1px;
    box-sizing: border-box;
}
</style>
<div class="flex-1 flex flex-col overflow-hidden bg-gray-50 p-6">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-4">
                <button class="btn btn-ghost btn-sm" onclick="window.history.back()">
                    <i class="fa-solid fa-arrow-left mr-2"></i>
                    Back to Messages
                </button> 
            </div>
            <button class="btn btn-primary" onclick="addNewMessage()">
                <i class="fa-solid fa-plus mr-2"></i>
                New Message
            </button>
        </div>
    </div>
    <!-- Two-column layout -->
    <div class="flex-1 flex gap-6 overflow-hidden">
        <!-- Left Column: Messages Table -->
        <div class="w-full max-w-lg flex-shrink-0 flex flex-col bg-white border border-base-200 rounded-lg overflow-hidden">
            <!-- Table Header -->
            <div class="p-4 border-b border-base-200 bg-gray-50">
                <div class="flex justify-between items-center">
                    <h3 class="font-semibold text-gray-900">Message Templates</h3>
                    <span class="text-sm text-gray-500" id="message-count">
                        {% if messages %}
                            {{ messages|length }} message{{ messages|length|pluralize }}
                        {% else %}
                            No messages
                        {% endif %}
                    </span>
                </div>
            </div>
            <!-- Search and Filter -->
            <div class="p-4 border-b border-base-200">
                <div class="flex gap-2">
                    <input type="text" 
                           placeholder="Search messages..." 
                           class="input input-bordered input-sm flex-1 bg-white"
                           id="search-messages"
                           oninput="filterMessages()">
                    <select class="select select-bordered select-sm bg-white" id="filter-product" onchange="filterMessages()">
                        <option value="">All Products</option>
                        {% for product in products %}
                        <option value="{{ product.id }}">{{ product.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <!-- Messages Table -->
            <div class="flex-1 overflow-y-auto" id="messages-container">
                {% if messages %}
                    {% for message in messages %}
                    <div class="message-row p-4 border-b border-base-200 {% if message.id == message_id %}active-message
                                {% elif not message_id and forloop.first %}active-message
                                {% endif %}" 
                         data-message="{{ message.id }}"
                         data-product="{{ message.product.id }}"
                         onclick="selectMessage({{ message.id }}, true)">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 min-w-0">
                                <h3 class="font-medium text-gray-900">{{ message.subject }}</h4>
                                <p class="text-sm text-gray-500 mt-1 line-clamp-2">
                                    {{ message.intro|truncatechars:40 }}
                                </p>
                                <div class="flex items-center gap-4 mt-2">
                                    <span class="text-xs text-gray-400">{{ message.product.name }}</span>
                                    <span class="text-xs text-gray-400">Updated: {{ message.updated_at|timesince }} ago</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 ml-2">
                                <button class="btn btn-ghost btn-xs" onclick="event.stopPropagation(); duplicateMessage({{ message.id }})" title="Duplicate">
                                    <i class="fa-solid fa-copy"></i>
                                </button>
                                <button class="btn btn-ghost btn-xs text-red-500" onclick="event.stopPropagation(); confirmDeleteMessage({{ message.id }})" title="Delete">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="p-8 text-center">
                        <div class="text-gray-400 mb-4">
                            <i class="fas fa-envelope-open-text fa-3x"></i>
                        </div>
                        <h3 class="text-lg font-medium mb-2">No messages found</h3>
                        <p class="text-gray-500 mb-4" style="font-family: 'Product Sans' !important;">Create your first message template to get started</p>
                        <button class="btn btn-primary" onclick="addNewMessage()">
                            <i class="fa-solid fa-plus mr-2"></i> Create Message
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
        <!-- Right Column: Message Editor/Preview -->
        <div class="flex-1 flex flex-col bg-white border border-base-200 rounded-lg h-[calc(100vh-180px)] relative">
            {% if messages %}
                <!-- Show preview by default if messages exist -->
                <div id="message-preview" class="flex-1 overflow-y-auto">
                    <button id="edit-preview-btn" class="btn btn-outline" onclick="showEditor()">
                        <i class="fa-solid fa-edit mr-2"></i>Edit
                    </button>
                    {% for message in messages %}
                    <div id="preview-content-{{ message.id }}" class="message-preview-content" style="display: {% if message.id == message_id %}block{% elif not message_id and forloop.first %}block{% else %}none{% endif %}">
                        {{ message.full_content|safe }}
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
            <!-- Message Form -->
            <div id="message-form-container" class="flex-grow overflow-y-auto" style="display: {% if messages %}none{% else %}block{% endif %}">
                <form id="message-form" class="p-4 space-y-4">
                    <!-- Header -->
                    <div class="flex justify-between items-center pb-4 border-b border-base-200">
                        <div class="text-sm">
                            <span class="font-bold text-gray-800 text-base">Subject</span>
                            <span class="text-gray-500 ml-2 text-base" id="subject-display">
                                {% if messages %}{{ messages.0.subject }}{% else %}New Message{% endif %}
                            </span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="preview-msg-btn-driver" type="button" class="btn btn-sm bg-white border border-base-300 text-gray-900" onclick="previewMessage()">
                                <i class="fa-regular fa-eye mr-2"></i>Preview
                            </button>
                        </div>
                    </div>
                    <!-- Product -->
                    <div id="product-selection-form-driver">
                        <label class="label">
                            <span class="label-text font-medium">Product <span class="text-gray-400">*(Required)</span></span>
                        </label>
                        <select class="select select-bordered w-full bg-white text-base" id="message-product" name="product">
                            {% for product in products %}
                            <option value="{{ product.id }}" {% if messages and messages.0.product.id == product.id %}selected{% endif %}>
                                {{ product.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Subject -->
                    <div id="subject-form-driver">
                        <label class="label">
                            <span class="label-text font-medium">Subject <span class="text-gray-500">*(Required)</span></span>
                        </label>
                        <input type="text"
                               placeholder="Your subject"
                               class="input input-bordered w-full bg-white text-base text-editor-style"
                               id="message-subject"
                               name="subject"
                               value="{% if messages %}{{ messages.0.subject }}{% endif %}">
                    </div>
                    <!-- Intro -->
                    <div id="msg-intro-form-driver">
                        <label class="label">
                            <span class="label-text font-medium ">Intro</span>
                        </label>
                        <textarea class="textarea textarea-bordered w-full bg-white text-base text-editor-style"
                                  rows="3"
                                  placeholder="Start typing here..."
                                  id="message-intro"
                                  name="intro">{% if messages %}{{ messages.0.intro }}{% endif %}</textarea>
                    </div>
                    <!-- Content -->
                    <div id="msg-content-form-driver">
                        <label class="label">
                            <span class="label-text font-medium">Content <span class="text-gray-500">*(Required)</span></span>
                        </label>
                        <textarea class="textarea textarea-bordered w-full bg-white text-base text-editor-style"
                                  rows="6"
                                  placeholder="Start typing here..."
                                  id="message-content"
                                  name="content">{% if messages %}{{ messages.0.content }}{% endif %}</textarea>
                    </div>
                    <!-- CTA -->
                    <div id="msg-cta-form-driver">
                        <label class="label">
                            <span class="label-text font-medium">Call to Action</span>
                        </label>
                        <input type="text"
                               placeholder="Your call to action"
                               class="input input-bordered w-full bg-white text-base text-editor-style"
                               id="message-cta"
                               name="cta"
                               value="{% if messages %}{{ messages.0.cta }}{% endif %}">
                    </div>
                    <!-- P.S -->
                    <div id="msg-ps-form-driver">
                        <label class="label">
                            <span class="label-text font-medium">P.S</span>
                        </label>
                        <textarea class="textarea textarea-bordered w-full bg-white text-base text-editor-style"
                                  rows="2"
                                  placeholder="P.S. message..."
                                  id="message-ps"
                                  name="ps">{% if messages %}{{ messages.0.ps }}{% endif %}</textarea>
                    </div>
                    <!-- P.P.S -->
                    <div id="msg-pps-form-driver">
                        <label class="label">
                            <span class="label-text font-medium">P.P.S</span>
                        </label>
                        <textarea class="textarea textarea-bordered w-full bg-white text-base text-editor-style"
                                  rows="2"
                                  placeholder="P.P.S. message..."
                                  id="message-pps"
                                  name="pps">{% if messages %}{{ messages.0.pps }}{% endif %}</textarea>
                    </div>
                    <!-- End/Signature -->
                    <div id="email-signature-form-driver">
                        <label class="label">
                            <span class="label-text font-medium">Signature</span>
                        </label>
                        <textarea class="textarea textarea-bordered w-full bg-white text-base text-editor-style"
                                  rows="3"
                                  placeholder="Best regards,&#10;Your name"
                                  id="message-end"
                                  name="end">{% if messages %}{{ messages.0.end }}{% endif %}</textarea>
                    </div>
                </form>
            </div>
            <!-- Bottom Toolbar -->
            <div class="p-4 border-t border-base-200">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <button id="save-btn-driver" class="btn btn-sm btn-primary" onclick="saveMessage(activeMessage)">
                            Save
                        </button>
                        <button class="btn btn-sm btn-ghost" onclick="showTemplates()">
                            <i class="fa-solid fa-file-text mr-2"></i>Templates
                        </button>
                        <!-- UPDATED: Variables button is now a dropdown -->
                        <div class="dropdown dropdown-top">
                            <label id="var-dropdown-btn-driver" tabindex="0" class="btn btn-sm btn-ghost">
                                <i class="fa-solid fa-code mr-2"></i>Variables
                            </label>
                            <!-- This is the updated line -->
                            <ul id="variables-dropdown" tabindex="0" id="variables-dropdown" class="dropdown-content z-[1] flex flex-col gap-2 p-2 shadow bg-base-100 rounded-boxmax-h-60  max-h-60 overflow-y-auto">
                                <!-- JS will populate this -->
                                <li><a>Loading...</a></li>
                            </ul>
                        </div>
                        <button class="btn btn-sm btn-ghost" onclick="showAI()">
                            <i class="fa-solid fa-magic mr-2"></i>AI
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="btn btn-sm btn-ghost" onclick="copyMessage()">
                            <i class="fa-solid fa-copy mr-2"></i>Copy
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div id="inline-variables-popup" 
     class="hidden absolute z-50 w-64 bg-base-100 border border-gray-200 rounded-lg shadow-xl"
>
    <ul id="inline-variables-list" class="p-2 max-h-60 overflow-y-auto">
        <!-- JS will populate this list -->
    </ul>
</div>


<!-- ADD THIS DIV AT THE END OF YOUR FILE -->
<div id="cursor-mirror" 
     style="position: absolute; top: -9999px; left: -9999px; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; visibility: hidden;">
</div>

<script>  
// Message Management System
let activeMessage = {% if message_id %}{{ message_id }}{% elif messages %}{{ messages.0.id }}{% else %}null{% endif %};
let messages = {};
let lastFocusedInput = null;
let leadFields = [];

let inlinePopup = null;
let inlinePopupList = null;
let activeInlineInput = null;
let triggerStartPosition = -1;
let highlightedIndex = -1;
// Initialize messages from Django template if they exist
{% if messages %}
    {% for message in messages %}
    messages[{{ message.id }}] = {
        id: {{ message.id }},
        product_id: {{ message.product.id }},
        product_name: "{{ message.product.name|escapejs }}",
        subject: "{{ message.subject|escapejs }}",
        intro: "{{ message.intro|escapejs }}",
        content: "{{ message.content|escapejs }}",
        cta: "{{ message.cta|escapejs }}",
        ps: "{{ message.ps|escapejs }}",
        pps: "{{ message.pps|escapejs }}",
        end: "{{ message.end|escapejs }}",
        full_content: `{{ message.full_content|safe|escapejs }}`,
        updated_at: "{{ message.updated_at|date:'Y-m-d' }}"
    };
    {% endfor %}
{% endif %}
function selectMessage(messageId, scrollIntoView = false) {
    // Remove active class from all messages
    document.querySelectorAll('.message-row').forEach(row => {
        row.classList.remove('active-message');
    });
    
    // Add active class to selected message
    const selectedRow = document.querySelector(`[data-message="${messageId}"]`);
    if (selectedRow) {
        selectedRow.classList.add('active-message');
        if (scrollIntoView) {
            selectedRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        activeMessage = messageId;
        
        // Load message content
        loadMessageContent(messageId);
        
        // Show the corresponding preview content
        document.querySelectorAll('.message-preview-content').forEach(preview => {
            preview.style.display = 'none';
        });
        
        const previewContent = document.getElementById(`preview-content-${messageId}`);
        if (previewContent) {
            previewContent.style.display = 'block';
        }
        previewMessage();
        
        // Check if this is an unsaved message
        const message = messages[messageId];
        if (message && message.isUnsaved) {
            // Show editor for unsaved messages
            showEditor();
            showSaveIndicator();
            
            // Hide action buttons for unsaved messages
            const actionButtons = document.getElementById(`action-buttons-${messageId}`);
            if (actionButtons) {
                actionButtons.innerHTML = '';
            }
        } else {
            // Remove save indicator if it exists
            const saveIndicator = document.getElementById('save-indicator');
            if (saveIndicator) {
                saveIndicator.remove();
            }
        }
    }
}
function loadMessageContent(messageId) {
    const message = messages[messageId] || {};
    // Load message data into form
    document.getElementById('message-product').value = message.product_id || '';
    document.getElementById('message-subject').value = message.subject || '';
    document.getElementById('message-intro').value = message.intro || '';
    document.getElementById('message-content').value = message.content || '';
    document.getElementById('message-cta').value = message.cta || '';
    document.getElementById('message-ps').value = message.ps || '';
    document.getElementById('message-pps').value = message.pps || '';
    document.getElementById('message-end').value = message.end || '';
    // Update subject display
    document.getElementById('subject-display').textContent = message.subject || 'New Message';
}
function saveCurrentMessage(messageId) {
    if (!messageId) return saveNewMessage();
    // Get current values from the form
    const currentValues = {
        product: document.getElementById('message-product').value,
        subject: document.getElementById('message-subject').value,
        intro: document.getElementById('message-intro').value,
        content: document.getElementById('message-content').value,
        cta: document.getElementById('message-cta').value,
        ps: document.getElementById('message-ps').value,
        pps: document.getElementById('message-pps').value,
        end: document.getElementById('message-end').value,
    };
    // Get original values
    const originalValues = messages[activeMessage] || {};
    // Determine changed fields
    const changedFields = {};
    let changedCount = 0;
    for (const key in currentValues) {
        if (currentValues[key] !== originalValues[key]) {
            changedFields[key] = currentValues[key];
            changedCount++;
        }
    }
    if (changedCount === 0) {
        return ModalSystem.toast("No changes detected", "warning");
    }
    // BEST PRACTICE IMPLEMENTATION:
    const isCompleteUpdate = changedCount === Object.keys(currentValues).length;
    const method = isCompleteUpdate ? 'PUT' : 'PATCH';
    const dataToSend = isCompleteUpdate ? currentValues : changedFields;
    fetch(`/api/messages/${messageId}/`, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify(dataToSend),
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to save message');
        return response.json();
    })
    .then(data => {
        // Update local state
        messages[messageId] = {
            ...messages[messageId],
            ...currentValues,
            product_id: currentValues.product,
            product_name: document.getElementById('message-product').options[document.getElementById('message-product').selectedIndex].text,
            updated_at: new Date().toISOString()
        };
        
        updateMessageRow(messageId, messages[messageId]);
        ModalSystem.toast(`Message saved (via ${method})`, 'success');
    })
    .catch(error => {
        console.error('Error saving message:', error);
        ModalSystem.toast('Error saving message', 'error');
    });
}
function saveNewMessage() {
    // Get values from the form
    const newMessage = {
        product: document.getElementById('message-product').value,
        subject: document.getElementById('message-subject').value,
        intro: document.getElementById('message-intro').value,
        content: document.getElementById('message-content').value,
        cta: document.getElementById('message-cta').value,
        ps: document.getElementById('message-ps').value,
        pps: document.getElementById('message-pps').value,
        end: document.getElementById('message-end').value,
    };
    
    // Make the API request to create new message
    fetch('/api/messages/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify(newMessage),
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to create message');
        return response.json();
    })
    .then(data => {
        // Check if we're replacing a temporary message
        let tempMessageId = null;
        if (activeMessage && messages[activeMessage] && messages[activeMessage].isUnsaved) {
            tempMessageId = activeMessage;
            
            // Remove the temporary message from the UI
            const tempRow = document.querySelector(`[data-message="${tempMessageId}"]`);
            if (tempRow) tempRow.remove();
        }
        
        // Add the new message to local storage
        messages[data.id] = {
            id: data.id,
            product_id: data.product.id,
            product_name: data.product.name,
            subject: data.subject,
            intro: data.intro,
            content: data.content,
            cta: data.cta,
            ps: data.ps,
            pps: data.pps,
            end: data.end,
            full_content: data.full_content,
            updated_at: data.updated_at,
            isUnsaved: false // Make sure this is set to false
        };
        
        // Create the new message row in the UI
        const newMessageHTML = `
            <div id="new-msg-saved-driver" class="message-row p-4 border-b border-base-200 active-message" 
                 data-message="${data.id}" 
                 data-product="${data.product.id}"
                 onclick="selectMessage(${data.id}, true)">
                <div class="flex justify-between items-start">
                    <div class="flex-1 min-w-0">
                        <h4 class="font-medium text-gray-900 truncate">${data.subject}</h4>
                        <p class="text-sm text-gray-500 mt-1 line-clamp-2">${data.intro.substring(0, 60)}${data.intro.length > 60 ? '...' : ''}</p>
                        <div class="flex items-center gap-4 mt-2">
                            <span class="text-xs text-gray-400">${data.product.name}</span>
                            <span class="text-xs text-gray-400">Updated: Just now</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 ml-2">
                        <button class="btn btn-ghost btn-xs" onclick="event.stopPropagation(); duplicateMessage(${data.id})" title="Duplicate">
                            <i class="fa-solid fa-copy"></i>
                        </button>
                        <button class="btn btn-ghost btn-xs text-red-500" onclick="event.stopPropagation(); confirmDeleteMessage(${data.id})" title="Delete">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Add to the UI and select it
        const messagesContainer = document.getElementById('messages-container');
        messagesContainer.insertAdjacentHTML('afterbegin', newMessageHTML);
        
        // Update message count
        const messageCount = Object.keys(messages).length;
        document.getElementById('message-count').textContent = `${messageCount} message${messageCount !== 1 ? 's' : ''}`;
        
        // Remove the save indicator
        const saveIndicator = document.getElementById('save-indicator');
        if (saveIndicator) {
            saveIndicator.remove();
        }
        
        // Select the new message
        selectMessage(data.id);
        ModalSystem.toast('New message created successfully!', 'success');
    })
    .catch(error => {
        console.error('Error creating message:', error);
        ModalSystem.toast('Error creating message', 'error');
    });
}
function updateMessageRow(messageId, messageData) {
    const messageRow = document.querySelector(`[data-message="${messageId}"]`);
    if (messageRow) {
        // Update the data-product attribute
        messageRow.setAttribute('data-product', messageData.product_id);
        
        // Update the visible content
        const titleElement = messageRow.querySelector('h4');
        const descElement = messageRow.querySelector('p');
        const productElement = messageRow.querySelector('.text-xs:first-child');
        const dateElement = messageRow.querySelector('.text-xs:last-child');
        
        if (titleElement) titleElement.textContent = messageData.subject || 'Untitled Message';
        if (descElement) descElement.textContent = messageData.intro?.substring(0, 60) + (messageData.intro?.length > 60 ? '...' : '') || 'No content';
        if (productElement) productElement.textContent = messageData.product_name || 'No product';
        if (dateElement) dateElement.textContent = `Updated: ${timeSince(new Date(messageData.updated_at))} ago`;
    }
}
function timeSince(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    let interval = Math.floor(seconds / 31536000);
    
    if (interval >= 1) return interval + " year" + (interval === 1 ? "" : "s");
    interval = Math.floor(seconds / 2592000);
    if (interval >= 1) return interval + " month" + (interval === 1 ? "" : "s");
    interval = Math.floor(seconds / 86400);
    if (interval >= 1) return interval + " day" + (interval === 1 ? "" : "s");
    interval = Math.floor(seconds / 3600);
    if (interval >= 1) return interval + " hour" + (interval === 1 ? "" : "s");
    interval = Math.floor(seconds / 60);
    if (interval >= 1) return interval + " minute" + (interval === 1 ? "" : "s");
    return Math.floor(seconds) + " second" + (seconds === 1 ? "" : "s");
}
function showPreview() {
    const formEl = document.getElementById('message-form-container');
    if (formEl) {
        formEl.style.display = 'none';
    }
    
    const previewEl = document.getElementById('message-preview');
    if (previewEl) {
        previewEl.style.display = 'block';
    }
}
function showEditor() {
    const previewEl = document.getElementById('message-preview');
    if (previewEl) {
        previewEl.style.display = 'none';
    }

    const formEl = document.getElementById('message-form-container');
    if (formEl) {
        formEl.style.display = 'block';
    }
}
function previewMessage() {
    // Generate HTML preview content from the form
    const message = {
        subject: document.getElementById('message-subject').value,
        intro: document.getElementById('message-intro').value,
        content: document.getElementById('message-content').value,
        cta: document.getElementById('message-cta').value,
        ps: document.getElementById('message-ps').value,
        pps: document.getElementById('message-pps').value,
        end: document.getElementById('message-end').value
    };
    
    const previewContentHTML = `
        <h3>${message.subject || 'No subject'}</h3>
        ${message.intro ? `<p>${message.intro.replace(/\n/g, '<br>')}</p>` : ''}
        ${message.content ? `<p>${message.content.replace(/\n/g, '<br>')}</p>` : ''}
        ${message.cta ? `<p>${message.cta}</p>` : ''}
        ${message.ps ? `<p>P.S. ${message.ps.replace(/\n/g, '<br>')}</p>` : ''}
        ${message.pps ? `<p>P.P.S. ${message.pps.replace(/\n/g, '<br>')}</p>` : ''}
        ${message.end ? `<div class="signature">${message.end.replace(/\n/g, '<br>')}</div>` : ''}
    `;

    // --- START OF FIX ---

    // Find the main preview container
    let previewContainer = document.getElementById('message-preview');

    // If the main container doesn't exist (because there were no messages initially), create it.
    if (!previewContainer) {
        const editorContainer = document.querySelector('.flex-1.flex.flex-col.bg-white'); // Find the parent card
        if (!editorContainer) return; // Failsafe

        previewContainer = document.createElement('div');
        previewContainer.id = 'message-preview';
        previewContainer.className = 'flex-1 overflow-y-auto';
        previewContainer.innerHTML = `
            <button id="edit-preview-btn" class="btn btn-outline" onclick="showEditor()">
                <i class="fa-solid fa-edit mr-2"></i>Edit
            </button>
        `;
        // Insert it before the form container
        editorContainer.insertBefore(previewContainer, document.getElementById('message-form-container'));
    }
    
    // Find or create the specific div for this message's preview content
    let previewDiv = document.getElementById(`preview-content-${activeMessage || 'new'}`);
    if (!previewDiv) {
        previewDiv = document.createElement('div');
        previewDiv.id = `preview-content-${activeMessage || 'new'}`;
        previewDiv.className = 'message-preview-content';
        previewContainer.appendChild(previewDiv); // Append to the (now guaranteed to exist) container
    }
    
    // Update the content and show the preview
    previewDiv.innerHTML = previewContentHTML;
    showPreview();
    // --- END OF FIX ---
}
function filterMessages() {
    const searchTerm = document.getElementById('search-messages').value.toLowerCase();
    const productFilter = document.getElementById('filter-product').value;
    
    document.querySelectorAll('.message-row').forEach(row => {
        const messageId = row.getAttribute('data-message');
        const message = messages[messageId];
        const matchesSearch = searchTerm === '' || 
            (message.subject && message.subject.toLowerCase().includes(searchTerm)) ||
            (message.intro && message.intro.toLowerCase().includes(searchTerm)) ||
            (message.content && message.content.toLowerCase().includes(searchTerm));
        
        const matchesProduct = productFilter === '' || 
            (message.product_id && message.product_id.toString() === productFilter);
        
        if (matchesSearch && matchesProduct) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update message count display
    const visibleCount = document.querySelectorAll('.message-row:not([style*="display: none"])').length;
    document.getElementById('message-count').textContent = `${visibleCount} message${visibleCount !== 1 ? 's' : ''}`;
}
function addNewMessage() {
    const productFilterSelect = document.getElementById('filter-product');
    let productId = productFilterSelect?.value || '';
    let productName = productFilterSelect?.options[productFilterSelect.selectedIndex]?.text || 'Unknown Product';

    // --- START OF FIX ---
    // If the filter is on "All Products", grab the first available product 
    // from the form's dropdown as a default.
    if (!productId) {
        const productFormSelect = document.getElementById('message-product');
        if (productFormSelect && productFormSelect.options.length > 0) {
            const firstOption = productFormSelect.options[0];
            if (firstOption.value) { // Make sure the first option isn't a blank placeholder
                productId = firstOption.value;
                productName = firstOption.text;
            }
        }
    }
    // --- END OF FIX ---
    
    // Generate a temporary ID for the new message
    const tempId = 'temp_new_' + Date.now();
    
    // Add a temporary message to the messages object
    messages[tempId] = {
        id: tempId,
        product_id: productId, // Now uses the corrected productId
        product_name: productName, // And the corrected productName
        subject: 'New Message Template',
        intro: '',
        content: '',
        cta: '',
        ps: '',
        pps: '',
        end: '',
        isUnsaved: true
    };
    
    // Create a new message row in the UI
    const newMessageHTML = `
        <div id="unsaved-message-on-add-new-driver" class="message-row p-4 border-b border-base-200 active-message" 
             data-message="${tempId}" 
             data-product="${productId}"
             onclick="selectMessage('${tempId}', true)">
            <div class="flex justify-between items-start">
                <div class="flex-1 min-w-0">
                    <h4 class="font-medium text-gray-900 truncate">New Message Template</h4>
                    <p class="text-sm text-gray-500 mt-1 line-clamp-2">Start typing your message content here...</p>
                    <div class="flex items-center gap-4 mt-2">
                        <span class="text-xs text-gray-400">${productName}</span>
                        <span class="text-xs text-gray-400">Updated: Just now</span>
                        <span class="badge badge-warning badge-xs">Unsaved</span>
                    </div>
                </div>
                <div class="flex items-center gap-2 ml-2" id="action-buttons-${tempId}"></div>
            </div>
        </div>
    `;
    
    const messagesContainer = document.getElementById('messages-container');
    const noMessagesPlaceholder = messagesContainer.querySelector('.text-center');
    if (noMessagesPlaceholder) {
        noMessagesPlaceholder.remove();
    }
    messagesContainer.insertAdjacentHTML('afterbegin', newMessageHTML);
    
    const messageCount = document.querySelectorAll('.message-row').length;
    document.getElementById('message-count').textContent = `${messageCount} message${messageCount !== 1 ? 's' : ''}`;
    
    // Clear the form and reset it for the new message
    document.getElementById('message-subject').value = 'New Message Template';
    document.getElementById('message-intro').value = '';
    document.getElementById('message-content').value = '';
    document.getElementById('message-cta').value = '';
    document.getElementById('message-ps').value = '';
    document.getElementById('message-pps').value = '';
    document.getElementById('message-end').value = '';
    document.getElementById('subject-display').textContent = 'New Message Template';
    
    // Now, set the product dropdown with our guaranteed productId
    if (productId) {
        document.getElementById('message-product').value = productId;
    }
    
    showEditor();
    
    activeMessage = tempId;
    
    document.querySelectorAll('.message-row').forEach(row => {
        row.classList.remove('active-message');
    });
    
    const newRow = document.querySelector(`[data-message="${tempId}"]`);
    if (newRow) {
        newRow.classList.add('active-message');
    }
    
    showSaveIndicator();
    messagesContainer.scrollTop = 0;
}
function duplicateMessage(messageId) {
    const message = messages[messageId];
    if (!message) return;
    
    // Generate a temporary ID with a prefix to make it recognizable
    const newMessageId = 'temp_' + Date.now(); // Temporary ID with prefix
    
    messages[newMessageId] = {
        ...message,
        id: newMessageId,
        subject: `Copy of ${message.subject}`,
        updated_at: new Date().toISOString().split('T')[0],
        isUnsaved: true // Flag to indicate this is an unsaved duplicate
    };
    
    // Add to the UI
    const newMessageHTML = `
        <div class="message-row p-4 border-b border-base-200" 
             data-message="${newMessageId}" 
             data-product="${message.product_id}"
             onclick="selectMessage(${newMessageId}, true)">
            <div class="flex justify-between items-start">
                <div class="flex-1 min-w-0">
                    <h4 class="font-medium text-gray-900 truncate">Copy of ${message.subject}</h4>
                    <p class="text-sm text-gray-500 mt-1 line-clamp-2">${message.intro?.substring(0, 60) || 'No content'}${message.intro?.length > 60 ? '...' : ''}</p>
                    <div class="flex items-center gap-4 mt-2">
                        <span class="text-xs text-gray-400">${message.product_name}</span>
                        <span class="text-xs text-gray-400">Updated: Just now</span>
                        <span class="badge badge-warning badge-xs">Unsaved</span>
                    </div>
                </div>
                <div class="flex items-center gap-2 ml-2" id="action-buttons-${newMessageId}">
                    <!-- Action buttons will be hidden for unsaved duplicates -->
                </div>
            </div>
        </div>
    `;
    
    const messagesContainer = document.getElementById('messages-container');
    messagesContainer.insertAdjacentHTML('afterbegin', newMessageHTML);
    
    // Select the new message and show editor
    selectMessage(newMessageId);
    showEditor(); // Show the editor view directly
    
    // Show save indicator
    showSaveIndicator();
    
    window.ModalSystem.toast('Message duplicated! Please save to make permanent.');
}
// Add this function to show the save indicator
function showSaveIndicator() {
    // Check if indicator already exists
    if (document.getElementById('save-indicator')) return;
    
    // Create save indicator
    const indicator = document.createElement('div');
    indicator.id = 'save-indicator';
    indicator.className = 'alert alert-warning mb-4';
    indicator.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <span>This is an unsaved message. Click "Save" to make it permanent.</span>
    `;
    
    // Insert at the top of the form container
    const formContainer = document.getElementById('message-form-container');
    formContainer.insertBefore(indicator, formContainer.firstChild);
}
function confirmDeleteMessage(messageId) {
    window.ModalSystem.confirm({
        title: 'Delete Message',
        message: 'Are you sure you want to delete this message template? This action cannot be undone.',
        confirmText: 'Delete',
        confirmClass: 'btn-error',
        action: function() {
            fetch(`/api/messages/${messageId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    ModalSystem.toast('Error deleting message', 'error');
                    throw new Error('Failed to delete message');
                }
            
                // Remove from UI
                const messageRow = document.querySelector(`[data-message="${messageId}"]`);
                if (messageRow) {
                    messageRow.remove();
                    
                    // Update message count
                    const remainingCount = document.querySelectorAll('.message-row').length;
                    document.getElementById('message-count').textContent = `${remainingCount} message${remainingCount !== 1 ? 's' : ''}`;
                    
                    if (activeMessage === messageId) {
                        // Select another message if available
                        const firstMessageRow = document.querySelector('.message-row');
                        if (firstMessageRow) {
                            selectMessage(parseInt(firstMessageRow.getAttribute('data-message')));
                        } else {
                            // No messages left
                            activeMessage = null;
                            document.getElementById('message-form-container').style.display = 'block';
                            document.getElementById('message-preview').style.display = 'none';
                        }
                    }
                }
                
                ModalSystem.toast('Message deleted successfully!');
            });
        }
    });
}
function saveMessage(messageId) {
    // Check if this is an unsaved message (has the isUnsaved flag)
    if (messageId && messages[messageId] && messages[messageId].isUnsaved) {
        // This is an unsaved duplicate, use saveNewMessage instead
        saveNewMessage();
        return;
    }
    
    if (messageId) {
        saveCurrentMessage(messageId);
    } else {
        saveNewMessage();
    }
}
// NEW: Helper function to insert text at the cursor position
function insertTextAtCursor(element, text) {
    if (!element) return;
    const start = element.selectionStart;
    const end = element.selectionEnd;
    const value = element.value;
    element.value = value.substring(0, start) + text + value.substring(end);
    element.selectionStart = element.selectionEnd = start + text.length;
    // Trigger an input event so any frameworks/listeners react
    element.dispatchEvent(new Event('input', { bubbles: true }));
}
// NEW: Populates the variables dropdown with clickable items
/**
 * Populates the main variables dropdown button with clickable items.
 * Reuses the createVariableListItem helper for consistency.
 */
function populateVariablesDropdown() {
    const dropdown = document.getElementById('variables-dropdown');
    if (!dropdown) return;
    
    dropdown.innerHTML = ''; // Clear loading/error message
    
    if (leadFields.length === 0) {
        dropdown.innerHTML = '<li><a>No variables found.</a></li>';
        return;
    }

    leadFields.forEach(field => {
        // Define the onClick behavior for the button's dropdown
        const clickHandler = (variableText) => {
            if (lastFocusedInput) {
                insertTextAtCursor(lastFocusedInput, variableText);
                lastFocusedInput.focus();
            } else {
                ModalSystem.toast('Please click on a text field first.', 'info');
            }
            // Close the dropdown
            if (document.activeElement) {
                document.activeElement.blur();
            }
        };

        // Reuse our existing styled list item creator
        const listItem = createVariableListItem(field, clickHandler);
        dropdown.appendChild(listItem);
    });
}
// NEW: Fetches the variable fields from the API and populates the dropdown
async function fetchAndPopulateVariables() {
    try {
        const response = await fetch('/api/lead/fields/');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        leadFields = data; // Cache the fields
        populateVariablesDropdown();
    } catch (error) {
        console.error('Failed to fetch lead fields:', error);
        const dropdown = document.getElementById('variables-dropdown');
        if(dropdown) {
            dropdown.innerHTML = '<li><a>Error loading variables.</a></li>';
        }
    }
}

// NEW: Helper function to insert text at the cursor position in the input
/**
 * Creates a styled list item for the variables popup.
 * Matches the style from the screenshot.
 */
function createVariableListItem(field, onClickHandler) {
    const variableText = `{${field}}`;
    
    // Create the main list item
    const listItem = document.createElement('li');
    
    // Create the clickable link/div inside
    const link = document.createElement('a');
    link.className = 'block w-full px-0 py-2 text-left rounded-md hover:bg-base-200 cursor-pointer';
    link.href = '#';

    // Create the human-readable name part (e.g., "Company Name")
    const nameSpan = document.createElement('span');
    nameSpan.className = 'font-semibold text-gray-800';
    // Simple conversion from snake_case to Title Case
    nameSpan.textContent = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

    // Create the variable part (e.g., "{{company_name}}")
    const variableSpan = document.createElement('span');
    variableSpan.className = 'text-gray-400 text-sm';
    variableSpan.textContent = variableText;
    
    link.appendChild(nameSpan);
    link.appendChild(variableSpan);
    link.onclick = (e) => {
        e.preventDefault();
        onClickHandler(variableText);
    };

    listItem.appendChild(link);
    return listItem;
}


/**
 * Filters and updates the inline variables popup based on user input.
 */
function updateInlinePopup(searchTerm) {
    inlinePopupList.innerHTML = ''; // Clear previous results

    const filteredFields = leadFields.filter(field =>
        field.toLowerCase().includes(searchTerm.toLowerCase())
    );

    if (filteredFields.length === 0) {
        hideInlinePopup();
        return;
    }

    // --- START OF CHANGES ---
    highlightedIndex = 0; // Reset and highlight the first item
    // --- END OF CHANGES ---

    filteredFields.forEach(field => {
        const listItem = createVariableListItem(field, (variableText) => {
            insertInlineVariable(variableText);
        });
        inlinePopupList.appendChild(listItem);
    });

    positionAndShowInlinePopup();
    
    // --- ADD THIS LINE ---
    updateHighlight(); // Apply the initial highlight
}



/**
 * Inserts the selected variable into the text, replacing the trigger text.
 */
function insertInlineVariable(variableText) {
    if (!activeInlineInput) return;

    const currentValue = activeInlineInput.value;
    const cursorPosition = activeInlineInput.selectionStart;
    
    const textBefore = currentValue.substring(0, triggerStartPosition);
    const textAfter = currentValue.substring(cursorPosition);

    activeInlineInput.value = textBefore + variableText + textAfter;
    
    // Move cursor to the end of the inserted variable
    const newCursorPosition = (textBefore + variableText).length;
    activeInlineInput.focus();
    activeInlineInput.setSelectionRange(newCursorPosition, newCursorPosition);

    // --- START OF FIX ---
    // Dispatch the event BEFORE we hide the popup (which nullifies activeInlineInput)
    activeInlineInput.dispatchEvent(new Event('input', { bubbles: true }));
    hideInlinePopup();
    // --- END OF FIX ---
}


/**
 * Calculates the (x, y) coordinates of the cursor inside an input/textarea.
 * Uses the "mirror div" technique.
 */
function getCursorCoordinates(inputElement, cursorPosition) {
    const mirror = document.getElementById('cursor-mirror');
    if (!mirror) return { top: 0, left: 0 };

    // Get the computed styles from the actual input element
    const computedStyle = window.getComputedStyle(inputElement);

    // Apply ALL critical styles from the input to the mirror
    [
        'width', 'fontFamily', 'fontSize', 'fontWeight', 'fontStyle', 
        'lineHeight', 'letterSpacing', 'textTransform', 'wordSpacing',
        'paddingTop', 'paddingRight', 'paddingBottom', 'paddingLeft',
        'borderTopWidth', 'borderRightWidth', 'borderBottomWidth', 'borderLeftWidth',
        'boxSizing'
    ].forEach(prop => {
        mirror.style[prop] = computedStyle[prop];
    });

    // Get text up to the cursor, replacing spaces and newlines for accurate measurement
    const textUpToCursor = inputElement.value.substring(0, cursorPosition)
        .replace(/\n/g, '<br/>')
        .replace(/ /g, '&nbsp;');

    // Add a span at the end to measure its position
    mirror.innerHTML = textUpToCursor + '<span id="cursor-span"></span>';
    
    const span = document.getElementById('cursor-span');
    const inputRect = inputElement.getBoundingClientRect();
    
    // Calculate final coordinates
    // Position of input + position of span inside mirror - scroll position of input
    const top = inputRect.top + span.offsetTop - inputElement.scrollTop;
    const left = inputRect.left + span.offsetLeft - inputElement.scrollLeft;

    // We also need the line height to position the popup below the current line
    const lineHeight = parseFloat(computedStyle.lineHeight);

    return { top, left, lineHeight };
}


/**
 * Calculates the position using the helper and shows the inline popup.
 */
function positionAndShowInlinePopup() {
    if (!activeInlineInput) return;

    // Use our new helper to get the precise cursor coordinates
    const coords = getCursorCoordinates(activeInlineInput, triggerStartPosition);
    
    // Position the popup below the line of text where the cursor is
    inlinePopup.style.left = `${coords.left}px`;
    inlinePopup.style.top = `${coords.top + coords.lineHeight}px`;
    
    inlinePopup.classList.remove('hidden');
}

/**
 * Hides the inline popup and resets its state.
 */
function hideInlinePopup() {
    if (inlinePopup) {
        inlinePopup.classList.add('hidden');
    }
    activeInlineInput = null;
    triggerStartPosition = -1;
    // --- ADD THIS LINE ---
    highlightedIndex = -1; // Reset the highlight index
}


/**
 * Main handler for the input event to check for the '{' trigger.
 */
function handleInputForVariables(event) {
    const input = event.target;
    const value = input.value;
    const cursorPosition = input.selectionStart;

    const lastBraceIndex = value.lastIndexOf('{', cursorPosition - 1);

    // Check if we are in a valid trigger state
    if (lastBraceIndex !== -1) {
        const textSinceBrace = value.substring(lastBraceIndex + 1, cursorPosition);
        // Avoid triggering if there's a space or another brace
        if (!textSinceBrace.includes(' ') && !textSinceBrace.includes('{')) {
            activeInlineInput = input;
            triggerStartPosition = lastBraceIndex;
            updateInlinePopup(textSinceBrace);
            return;
        }
    }
    
    // If not in a trigger state, hide the popup
    hideInlinePopup();
}

/**
 * Updates the visual highlight in the inline popup list.
 */
function updateHighlight() {
    const items = inlinePopupList.querySelectorAll('li > a');
    if (items.length === 0) return;

    items.forEach((item, index) => {
        if (index === highlightedIndex) {
            item.classList.add('bg-base-200'); // This is our highlight class
            // Ensure the highlighted item is visible if the list is scrollable
            item.scrollIntoView({ block: 'nearest' });
        } else {
            item.classList.remove('bg-base-200');
        }
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    {% if messages %}
        selectMessage({{ message_id|default:messages.0.id }});
        showPreview();
    {% endif %}
    
    // Check URL param to auto-add new message
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('add_new') === 'true') {
        addNewMessage();
        urlParams.delete('add_new'); // Clean up the URL
        window.history.replaceState({}, document.title, `${window.location.pathname}?${urlParams.toString()}`);
    }
    
    // Update subject display when typing in subject field
    document.getElementById('message-subject').addEventListener('input', function() {
        document.getElementById('subject-display').textContent = this.value || 'New Message';
    });
    
    // Standard Variables button functionality
    fetchAndPopulateVariables();
    
    // Track last focused input for the button-based variable insertion
    const formInputs = document.querySelectorAll('#message-form input[type="text"], #message-form textarea');
    formInputs.forEach(input => {
        input.addEventListener('focus', function() {
            lastFocusedInput = this;
        });
    });

    // --- START OF NEW INLINE VARIABLES LOGIC ---

    // Get references to the popup elements
    inlinePopup = document.getElementById('inline-variables-popup');
    inlinePopupList = document.getElementById('inline-variables-list');

    // Add input listeners to all form fields for the '{' trigger
    formInputs.forEach(input => {
        input.addEventListener('input', handleInputForVariables);
        input.addEventListener('blur', () => {
             // Use a small timeout to allow click events on the popup to register first
            setTimeout(hideInlinePopup, 150);
        });
    });
    
    // Add keydown listener to handle Escape key and navigation
    // In your `DOMContentLoaded` function at the end of the script...

    // ... (previous code inside the function)

    // --- FIND AND REPLACE THE ENTIRE KEYDOWN LISTENER ---
    // Add keydown listener to handle Escape, Arrows, and Enter
    document.addEventListener('keydown', (e) => {
        // Only act if the inline popup is active
        if (!activeInlineInput || inlinePopup.classList.contains('hidden')) {
            return;
        }

        const items = inlinePopupList.querySelectorAll('li');
        if (items.length === 0) return;

        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault(); // Prevent cursor from moving in the input
                highlightedIndex = (highlightedIndex + 1) % items.length;
                updateHighlight();
                break;

            case 'ArrowUp':
                e.preventDefault(); // Prevent cursor from moving in the input
                highlightedIndex = (highlightedIndex - 1 + items.length) % items.length;
                updateHighlight();
                break;

            case 'Enter':
                e.preventDefault(); // Prevent form submission
                if (highlightedIndex > -1) {
                    // Find the clickable 'a' tag inside the highlighted list item and click it
                    const selectedLink = items[highlightedIndex].querySelector('a');
                    if (selectedLink) {
                        selectedLink.click();
                    }
                }
                break;

            case 'Escape':
                hideInlinePopup();
                break;
        }
    });
// --- END OF REPLACEMENT ---
    // --- END OF NEW INLINE VARIABLES LOGIC ---
});

// Placeholder functions for unimplemented features
function showTemplates() {
    ModalSystem.toast('Templates feature coming soon!', 'info');
}
function showAI() {
    ModalSystem.toast('AI feature coming soon!', 'info');
}
function copyMessage() {
    // Get the current message content
    let messageContent = '';
    
    // If we have an active message, use its data
    if (activeMessage && messages[activeMessage]) {
        const message = messages[activeMessage];
        
        // Build the message content with proper formatting
        if (message.subject) {
            messageContent += `Subject: ${message.subject}\n\n`;
        }
        
        if (message.intro) {
            messageContent += `${message.intro}\n\n`;
        }
        
        if (message.content) {
            messageContent += `${message.content}\n\n`;
        }
        
        if (message.cta) {
            messageContent += `${message.cta}\n\n`;
        }
        
        if (message.ps) {
            messageContent += `P.S. ${message.ps}\n\n`;
        }
        
        if (message.pps) {
            messageContent += `P.P.S. ${message.pps}\n\n`;
        }
        
        if (message.end) {
            messageContent += `${message.end}`;
        }
    } else {
        // If no active message, get content from form fields
        const subject = document.getElementById('message-subject').value;
        const intro = document.getElementById('message-intro').value;
        const content = document.getElementById('message-content').value;
        const cta = document.getElementById('message-cta').value;
        const ps = document.getElementById('message-ps').value;
        const pps = document.getElementById('message-pps').value;
        const end = document.getElementById('message-end').value;
        
        // Build the message content with proper formatting
        if (subject) {
            messageContent += `Subject: ${subject}\n\n`;
        }
        
        if (intro) {
            messageContent += `${intro}\n\n`;
        }
        
        if (content) {
            messageContent += `${content}\n\n`;
        }
        
        if (cta) {
            messageContent += `${cta}\n\n`;
        }
        
        if (ps) {
            messageContent += `P.S. ${ps}\n\n`;
        }
        
        if (pps) {
            messageContent += `P.P.S. ${pps}\n\n`;
        }
        
        if (end) {
            messageContent += `${end}`;
        }
    }
    
    // Copy to clipboard
    navigator.clipboard.writeText(messageContent)
        .then(() => {
            ModalSystem.toast('Message copied to clipboard!', 'success');
        })
        .catch(err => {
            console.error('Failed to copy message: ', err);
            ModalSystem.toast('Failed to copy message', 'error');
        });
}
function exportMessage() {
    ModalSystem.toast('Export feature coming soon!', 'info');
}
{% if not request.user.onboarding_completed %}
document.addEventListener("DOMContentLoaded", () => {
    const step = localStorage.getItem("onboardingStep");
    if (step === "imported_first_leads") {
        const driver = window.driver.js.driver;
        const driverObj = driver({
            animate: true,
            overlayOpacity: 0.5,
            stagePadding: 10,
            allowClose: false,
            allowKeyboardControl: false,
            steps: [
                {
                    element: "#unsaved-message-on-add-new-driver",
                    popover: {
                        title: "Create Your First Message!",
                        description: "Great! Now that you have leads, let's create a reusable message template. We've started one for you here.",
                        position: "right"
                    }
                },
                {
                    element: "#product-selection-form-driver",
                    popover: {
                        title: "Assign a Product",
                        description: "First, link this message to a product to stay organized. This field is required.",
                        position: "left"
                    }
                },
                {
                    element: "#subject-form-driver",
                    popover: {
                        title: "Craft a Great Subject",
                        description: "Next, write a compelling subject line to grab your prospect's attention. This is also required.",
                        position: "left"
                    }
                },
                {
                    element: "#msg-intro-form-driver",
                    popover: {
                        title: "Write Your Intro",
                        description: "Now for the opening line. Let's do something cool here to make it personal Just type a left brace `{` to bring up the variables list directly inside the editor!...",
                        position: "left"
                    }
                },
                {
                    element: "#msg-content-form-driver",
                    popover: {
                        title: "The Main Content",
                        description: "Now for the body of your message. similary use `{` to bring up the variables list directly inside the editor!...",
                        position: "left"
                    }
                },
                {
                    element: "#msg-cta-form-driver",
                    popover: {
                        title: "Add a Call to Action",
                        description: "What do you want the prospect to do next? Ask a question or suggest a meeting.",
                        position: "left"
                    }
                },
                {
                    element: "#msg-ps-form-driver",
                    popover: {
                        title: "Add a P.S. (Optional)",
                        description: "A P.S. is a great way to add a final, high-impact point.",
                        position: "left"
                    }
                },
                {
                    element: "#msg-pps-form-driver",
                    popover: {
                        title: "Add a P.P.S. (Optional)",
                        description: "Use this for an extra call to action or a final piece of value.",
                        position: "left"
                    }
                },
                {
                    element: "#email-signature-form-driver",
                    popover: {
                        title: "Your Signature",
                        description: "Finally, add your signature. This will be automatically appended to your messages.",
                        position: "left"
                    },
                    onHighlightStarted: (element) => {
                        // Find the scrollable parent container
                        const formContainer = document.getElementById('message-form-container');
                        if (formContainer) {
                            // Get the position of the signature element relative to the container
                            const elementTop = element.offsetTop;
                            // Scroll the container so the element is positioned 100px from the top
                            // This provides enough space to clear the bottom toolbar.
                            formContainer.scrollTo({ top: elementTop - 100, behavior: 'smooth' });
                        }
                    }
                },
                {
                    element: "#save-btn-driver",
                    popover: {
                        title: "Save Your Template",
                        description: "Looking good! Click 'Save' to store this message template for future use.",
                        position: "left"
                    }
                },
                {
                    element: "#new-msg-saved-driver",
                    popover: {
                        title: "Your Message is now saved!",
                        description: "",
                        position: "top"
                    }
                },
                {
                    element: "#preview-msg-btn-driver",
                    popover: {
                        title: "Preview Your Message",
                        description: "You can always click 'Preview' to see how your message will look. When you're done, you're ready for your first campaign!",
                        position: "left"
                    }
                },
                {
                    element: "#message-preview",
                    popover: {
                        title: "Here is your Preview",
                        description: "You can always edit it later.",
                        position: "right"
                    }
                },
                {
                    element: "#campaigns-tab",
                    popover: {
                        title: "Well Done!",
                        description: "you're ready for your first campaign!",
                        position: "right"
                    }
                },
                
            ]
        });
        driverObj.drive();
        // This part seems to target a button that doesn't exist.
        document.querySelector("#campaigns-tab").addEventListener("click", () => {
            localStorage.setItem("onboardingStep", "created_first_msg");
            driverObj.destroy();
        });
    }
});
{% endif %}
</script>
{% endblock %}