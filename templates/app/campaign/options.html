{% extends "app/campaign/campaign-base.html" %}
{% load static %}

{% block title %}Campaign options{% endblock %}

{% block cmp-base-content %}

<style>
/* Custom styles for options page */
.option-card {
    transition: all 0.2s ease;
}

.option-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.toggle-group .btn {
    transition: all 0.2s ease;
}

.toggle-group .btn.active {
    transform: scale(1.02);
}

.form-control input:focus,
.form-control select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.save-indicator {
    opacity: 0;
    transition: opacity 0.3s ease;
}

.save-indicator.show {
    opacity: 1;
}

/* Add this to your styles */
#dropdownList {
    max-width: calc(100% - 2px); /* Adjust as needed */
}

/* Launch button animations */
#launch-btn {
    transition: all 0.3s ease;
}

#launch-btn:not(.btn-disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
}

#launch-btn.btn-disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Status indicators */
.animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: .5;
    }
}

/* Add this to your <style> block at the top of the file */
.toggle-group .btn[data-value="false"].active {
    background-color: #3d4451 !important; /* DaisyUI 'neutral' color */
    border-color: #3d4451 !important;
    color: white !important;
}
</style>
        <!-- Options Container -->
        <div id="options-container" class="mt-6 w-full max-w-4xl mx-auto">
            <form id="options-form" class="space-y-4">


            <div id="email-selector-driver">
                <!-- Card: Accounts to use -->
                <div id="account-to-use-card-driver" class="card bg-white p-6 rounded-lg shadow-sm flex-row items-center justify-between option-card">
                    <div>
                        <h3 class="font-bold text-gray-800 text-base">Accounts to use</h3>
                        <p class="text-sm text-gray-500 mt-1">Select one or more accounts to send emails from</p>
                    </div>
                
                    <div class="flex flex-col items-end gap-2">
                        <div class="max-w-lg w-full mx-auto relative">
                            <label class="block text-sm font-medium mb-1">Select Sending Emails</label>

                            <!-- Selected Email Tags -->
                            <div id="selectedEmails" class="flex flex-wrap gap-2 mb-2">
                                {% if campaign_options %}
                                    {% for email in campaign_options.email_accounts.all %}
                                        <div class="badge badge-success badge-outline text-xs font-semibold">
                                            {{ email.email }}
                                            <button class="ml-2 text-error" onclick="removeEmail('{{ email.email }}')">Ã—</button>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>

                            <!-- Search Input -->
                            <input type="text" id="searchInput" placeholder="Search email..."
                                class="input input-bordered w-full mb-2" oninput="filterEmails()" onclick="showDropdown()" />

                            <!-- Dropdown List - Updated classes -->
                            <ul id="dropdownList" class="menu bg-white border rounded-box max-h-70 hidden shadow-md absolute top-full left-0 right-0 z-10 mt-1 w-full" 
                                style="overflow-y: auto;overflow-x: none;max-width: calc(100% - 2px);"></ul>
                        </div>

                        <!-- <button type="button" class="text-sm text-primary font-semibold hover:underline" onclick="connectNewAccount()">
                            Connect new email account
                        </button> -->
                    </div>
                </div>
                <!-- Card: Stop sending emails -->
                <div id="stop-on-reply-card-driver" class="card bg-white p-6 rounded-lg shadow-sm flex-row items-center justify-between option-card">
                    <div>
                        <h3 class="font-bold text-gray-800 text-base">Stop sending emails on reply</h3>
                        <p class="text-sm text-gray-500 mt-1">Stop sending emails to a lead if a response has been received</p>
                        <p class="text-sm mt-1 text-info">Notice that you need to set each replied lead individualy when yhe lead responds to your email</p>
                    </div>
                    <div id="stop-on-reply-card-driver-toggle-group" class="join rounded-lg toggle-group" data-option="stopOnReply">
                        <button type="button" class="join-item btn btn-sm {% if not campaign_options or not campaign_options.stop_on_reply %}bg-gray-100 border-gray-300 text-gray-500{% else %}btn-neutral text-white{% endif %}"
                                onclick="toggleOption('stopOnReply', false)" data-value="false">Disable</button>
                        <button type="button" class="join-item btn btn-sm {% if campaign_options and campaign_options.stop_on_reply %}btn-success text-white active{% else %}bg-gray-100 border-gray-300 text-gray-500{% endif %}"
                                onclick="toggleOption('stopOnReply', true)" data-value="true">Enable</button>
                    </div>
                </div>
            
            
            </div>

                <!-- Card: Open Tracking -->
                <div id="open-tracking-card-driver" class="card bg-white p-6 rounded-lg shadow-sm flex-row items-center justify-between option-card">
                    <div>
                        <h3 class="font-bold text-gray-800 text-base">Open Tracking</h3>
                        <p class="text-sm text-gray-500 mt-1">Track email opens</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <label id="link-tracking-checkbox-driver" class="label cursor-pointer gap-2">
                            <input type="checkbox" name="linkTracking" class="checkbox checkbox-primary" onchange="updateOption('linkTracking', this.checked)" {% if campaign_options and campaign_options.link_tracking_enabled %}checked{% elif not campaign_options %}checked{% endif %}/>
                            <span class="label-text">Link tracking</span>
                        </label>
                        <div id="open-tracking-card-driver-toggle-group" class="join rounded-lg toggle-group" data-option="openTracking">
                            <button type="button" class="join-item btn btn-sm {% if not campaign_options or not campaign_options.open_tracking_enabled %}bg-gray-100 border-gray-300 text-gray-500{% else %}btn-neutral text-white{% endif %}" 
                                    onclick="toggleOption('openTracking', false)" data-value="false">Disable</button>
                            <button type="button" class="join-item btn btn-sm {% if campaign_options and campaign_options.open_tracking_enabled %}btn-success text-white active{% else %}bg-gray-100 border-gray-300 text-gray-500{% endif %}" 
                                    onclick="toggleOption('openTracking', true)" data-value="true">Enable</button>
                        </div>
                    </div>
                </div>
                <!-- Card: Delivery Optimization -->
                <!-- <div class="card bg-white p-6 rounded-lg shadow-sm flex-row items-center justify-between option-card">
                    <div>
                        <h3 class="font-bold text-gray-800 text-base flex items-center gap-2">
                            Delivery Optimization
                            <div class="badge badge-success badge-outline text-xs font-semibold">Recommended</div>
                        </h3>
                        <p class="text-sm text-gray-500 mt-1">Disables open tracking</p>
                    </div>
                    <div class="flex flex-col items-start gap-2">
                        <label class="label cursor-pointer justify-start gap-2">
                            <input type="checkbox" name="textOnly" class="checkbox checkbox-primary" onchange="updateOption('textOnly', this.checked)" {% if campaign_options and campaign_options.send_as_text_only %}checked{% endif %}/>
                            <span class="label-text text-sm">Send emails as text-only (no HTML)</span>
                        </label>
                        <label class="label cursor-pointer justify-start gap-2">
                            <input type="checkbox" name="firstEmailTextOnly" class="checkbox checkbox-primary" onchange="updateOption('firstEmailTextOnly', this.checked)" {% if not campaign_options or campaign_options.send_first_email_as_text_only %}checked{% endif %}/>
                            <span class="label-text text-sm flex items-center gap-2">
                                Send first email as text-only
                                <div class="badge badge-warning text-yellow-800 font-bold text-xs">Pro</div>
                            </span>
                        </label>
                    </div>
                </div> -->

                <!-- Card: Daily Limit -->
                <div id="daily-limit-card-driver" class="card bg-white p-6 rounded-lg shadow-sm flex-row items-center justify-between option-card">
                    <div>
                        <h3 class="font-bold text-gray-800 text-base">Daily Limit</h3>
                        <p class="text-sm text-gray-500 mt-1">Max number of emails to send per day for this campaign.</p>
                        <p class="text-sm text-gray-500 mt-1">Each email can send arround 30 emails per day, without landing in spam/promotion folders</p>
                    </div>
                    <div id="daily-limit-input-driver" class="flex items-center gap-2">
                        <input type="number"
                               id="daily-limit"
                               name="dailyLimit"
                               value="{% if campaign_options %}{{ campaign_options.daily_limit }}{% else %}30{% endif %}"
                               min="1"
                               max="1000"
                               class="input input-bordered bg-white w-24 text-center"
                               onblur="updateOption('dailyLimit', this.value)" />
                    </div>
                </div>
            </form>

            <!-- Campaign Status Card (if campaign is active or completed) -->
            {% if campaign.status == 'active' or campaign.status == 'completed' %}
            <div class="card bg-gradient-to-r from-{% if campaign.status == 'active' %}green{% else %}blue{% endif %}-50 to-{% if campaign.status == 'active' %}green{% else %}blue{% endif %}-100 border-{% if campaign.status == 'active' %}green{% else %}blue{% endif %}-200 p-6 rounded-lg shadow-sm mt-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 bg-{% if campaign.status == 'active' %}green{% else %}blue{% endif %}-500 rounded-full {% if campaign.status == 'active' %}animate-pulse{% endif %}"></div>
                        <div>
                            <h3 class="font-bold text-{% if campaign.status == 'active' %}green{% else %}blue{% endif %}-800 text-base">
                                Campaign is {% if campaign.status == 'active' %}Active{% else %}Completed{% endif %}
                            </h3>
                            <p class="text-sm text-{% if campaign.status == 'active' %}green{% else %}blue{% endif %}-600 mt-1">
                                {% if campaign.status == 'active' %}
                                    Your campaign is currently running and sending emails. Editing is disabled.
                                {% else %}
                                    Your campaign has been completed. Editing is disabled.
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline btn-{% if campaign.status == 'active' %}success{% else %}info{% endif %}" onclick="checkCampaignStatus()">
                        <i class="fas fa-chart-line mr-2"></i> View Progress
                    </button>
                </div>
            </div>
            {% endif %}

            <!-- Action Buttons -->
            <div class="flex justify-center mt-10 space-x-4">
                {% if campaign.status == 'active' or campaign.status == 'completed' %}
                    <button class="btn btn-outline btn-disabled" disabled>
                        <i class="fas fa-lock mr-2"></i> Editing Disabled
                    </button>
                    <button class="btn btn-{% if campaign.status == 'active' %}success{% else %}info{% endif %}" onclick="window.location.href='/campaign/dashboard/{{ campaign_id }}'">
                        <i class="fas fa-chart-line mr-2"></i> View Dashboard
                    </button>
                {% else %}
                    <button id="save-options-btn-driver" class="btn btn-outline" onclick="saveOptions()">
                        <i class="fas fa-save mr-2"></i> Save Options
                    </button>
                    <!-- Find and update this button -->
                    {% if allowed_to_launch.allowed == False %}

                    <div class="group/btn relative">
                    <a href="#"
                        class="absolute hidden group-hover/btn:flex bottom-full left-1/2 -translate-x-1/2 mb-4">
                        <div class="tooltip-container">
                        <div class="bg-error/90 text-base-100 p-2 rounded-[10px] shadow-md shadow-gray-200 hover:bg-error w-max">
                            <span class="sr-only">error</span>
                            {{allowed_to_launch.message}}
                        </div>
                        </div>
                        <div class="absolute w-full bg-transparent z-50 h-6 -bottom-4"></div>
                    </a>

                    <div class=" group-hover/btn:scale-110 group-hover/btn:-translate-y-1">
                        <button class="btn btn-primary btn-lg" onclick="fixLaucnhError()">
                        Please fix the error
                        </button>
                    </div>
                    </div>
                    {% else %} 
                    <button id="launch-campaign-btn-driver" class="btn btn-primary btn-lg" onclick="launchCampaign()">
                        <i class="fas fa-rocket mr-2"></i> Launch Campaign
                    </button>
                    {% endif %} 
                {% endif %}
            </div>

            <!-- Launch Requirements Info -->
            {% if campaign.status != 'active' %}
            <div id="launch-requirements-card-driver" class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h4 class="font-semibold text-blue-800 mb-2">
                    <i class="fas fa-info-circle mr-2"></i>Before launching your campaign:
                </h4>
                <ul class="text-sm text-blue-700 space-y-1">
                    <li class="flex items-center gap-2">
                        <i class="fas fa-check-circle text-green-500"></i>
                        Select at least one active email account
                    </li>
                    <li class="flex items-center gap-2">
                        <i class="fas fa-check-circle text-green-500"></i>
                        Configure your sending preferences
                    </li>
                    <li class="flex items-center gap-2">
                        <i class="fas fa-check-circle text-green-500"></i>
                        Set appropriate daily limits
                    </li>
                    <li class="flex items-center gap-2">
                        <i class="fas fa-info-circle text-blue-500"></i>
                        Make sure your campaign has message assignments and leads
                    </li>
                </ul>
            </div>
            {% endif %}
        </div>

<script src="{% static 'js/block-interactions.js' %}"></script> 
<script>
    {% if view_only %}
        blockInteractions('#options-container');
    {% endif %}

    // --- (UNCHANGED CODE from original script) ---
    const allEmails = [
    {% for email in emails %}
        { email_id: {{email.email_id}}, email: "{{email.email}}", active: {% if email.active %}true{% else %}false{% endif %}, used: {% if email.used %}true{% else %}false{% endif %} },
    {% endfor %}
    ];
    let selectedEmails = [
        {% if campaign_options %}
            {% for email in campaign_options.email_accounts.all %}
                { email_id: {{email.id}}, email: "{{email.email}}"},
            {% endfor %}
        {% endif %}
    ];
    const dropdown = document.getElementById("dropdownList");
    const searchInput = document.getElementById("searchInput");
    const selectedContainer = document.getElementById("selectedEmails");
    let campaignOptions = {
        emailAccounts: selectedEmails,
        stopOnReply: {% if campaign_options %}{{ campaign_options.stop_on_reply|lower }}{% else %}true{% endif %},
        openTracking: {% if campaign_options %}{{ campaign_options.open_tracking_enabled|lower }}{% else %}false{% endif %},
        linkTracking: {% if campaign_options %}{{ campaign_options.link_tracking_enabled|lower }}{% else %}true{% endif %},
        textOnly: {% if campaign_options %}{{ campaign_options.send_as_text_only|lower }}{% else %}false{% endif %},
        firstEmailTextOnly: {% if not campaign_options or campaign_options.send_first_email_as_text_only %}false{% else %}false{% endif %},
        dailyLimit: {% if campaign_options %}{{ campaign_options.daily_limit }}{% else %}30{% endif %}
    };
    function showDropdown() {
      dropdown.classList.remove("hidden");
      filterEmails();
    }
    document.addEventListener("click", function (e) {
      if (!dropdown.contains(e.target) && e.target !== searchInput) {
        dropdown.classList.add("hidden");
      }
    });
    function filterEmails() {
      const query = searchInput.value.toLowerCase();
      dropdown.innerHTML = "";
      const filtered = allEmails.filter(e =>
        e.email.toLowerCase().includes(query) &&
        !selectedEmails.some(selected => selected.email === e.email)
      );
      if (filtered.length === 0) {
        dropdown.innerHTML = `<li class="text-sm text-gray-500 px-4 py-2">No options</li>`;
        return;
      }
      filtered.forEach(email => {
        const li = document.createElement("li");
        li.className = "px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm flex justify-between items-center";
        li.innerHTML = `
          <span>${email.email}</span>
          ${!email.active ? '<span class="text-red-500 text-xs ml-2">Account not active</span>' : ''}
          ${email.used ? '<span class="text-red-400 text-xs ml-2">Account already used</span>' : ''}
        `;
        if (email.active && !email.used) {
          li.onclick = () => selectEmail(email.email);
        } else {
          li.classList.add("opacity-50", "cursor-not-allowed");
        }
        dropdown.appendChild(li);
      });
    }

    // *** MODIFICATION 3: Added call to setFormDirtyState()
    function selectEmail(email) {
      if (!selectedEmails.some(selected => selected.email === email)) {
        const emailObj = allEmails.find(e => e.email === email);
        if (emailObj) {
          selectedEmails.push({ email_id: emailObj.email_id, email: email });
          campaignOptions.emailAccounts = selectedEmails;
          renderSelected();
          updateDailyLimit();
          validateCampaignReadiness();
          searchInput.value = "";
          filterEmails();
          setFormDirtyState(); // Mark form as changed
        }
      }
    }

    // *** MODIFICATION 3: Added call to setFormDirtyState()
    function removeEmail(email) {
      selectedEmails = selectedEmails.filter(e => e.email !== email);
      campaignOptions.emailAccounts = selectedEmails;
      renderSelected();
      updateDailyLimit();
      validateCampaignReadiness();
      filterEmails();
      setFormDirtyState(); // Mark form as changed
    }
    
    function renderSelected() {
      selectedContainer.innerHTML = "";
      selectedEmails.forEach(emailObj => {
        const badge = document.createElement("div");
        badge.className = "badge badge-success badge-outline text-xs font-semibold";
        badge.innerHTML = `
          ${emailObj.email}
          <button class="ml-2 text-error" onclick="removeEmail('${emailObj.email}')">Ã—</button>
        `;
        selectedContainer.appendChild(badge);
      });
    }

    // *** MODIFICATION 4: Rewritten for robust class management
    // *** MODIFICATION 3: Added call to setFormDirtyState()
    function toggleOption(optionName, value) {
        setFormDirtyState(); // Mark form as changed
        const toggleGroup = document.querySelector(`[data-option="${optionName}"]`);
        const buttons = toggleGroup.querySelectorAll('button');

        buttons.forEach(btn => {
            const btnValue = btn.getAttribute('data-value') === 'true';
            
            // Reset all style classes first
            btn.classList.remove('active', 'btn-success', 'btn-neutral', 'text-white', 'bg-gray-100', 'border-gray-300', 'text-gray-500');

            if (btnValue === value) {
                // This is the active button
                btn.classList.add('active', 'text-white');
                if (value) { // 'Enable' is true
                    btn.classList.add('btn-success');
                } else { // 'Disable' is false
                    btn.classList.add('btn-neutral');
                }
            } else {
                // This is the inactive button
                btn.classList.add('bg-gray-100', 'border-gray-300', 'text-gray-500');
            }
        });

        campaignOptions[optionName] = value;
    }
    
    // *** MODIFICATION 3: Added call to setFormDirtyState()
    function updateOption(optionName, value) {
        setFormDirtyState(); // Mark form as changed
        if (optionName === 'dailyLimit') {
            const input = document.getElementById('daily-limit');
            if (value < 2) value = 2;
            if (value % 2 !== 0) {
                value = Math.round(value / 2) * 2;
                ModalSystem.toast('Adjusted to nearest even number: ' + value, 'info');
            }
            input.value = value;
        }
        campaignOptions[optionName] = value;
    }

    // --- (UNCHANGED CODE from original script, but functions are now referenced by the new logic) ---
    function updateDailyLimit() {
        const accountCount = selectedEmails.length;
        const newLimit = accountCount * 30; // 30 emails per account
        document.getElementById('daily-limit').value = newLimit;
        campaignOptions.dailyLimit = newLimit;
    }

    // *** MODIFICATION 3: Added logic to enable launch button on success
    function saveOptions() {
        const campaignOptionsToSave = {
            campaign: {{ campaign_id }},
            email_accounts: campaignOptions.emailAccounts.map(email => email.email_id),
            stop_on_reply: campaignOptions.stopOnReply,
            open_tracking_enabled: campaignOptions.openTracking,  
            link_tracking_enabled: campaignOptions.linkTracking, 
            send_as_text_only: campaignOptions.textOnly, 
            send_first_email_as_text_only: campaignOptions.firstEmailTextOnly, 
            daily_limit: campaignOptions.dailyLimit 
        };

        if (campaignOptions.emailAccounts.length === 0) {
            ModalSystem.toast('Please select at least one email account.', 'error');
            return;
        }
        
        fetch('{% if campaign_options %}/api/campaign-options/{{ campaign_options.id }}/{% else %}/api/campaign-options/{% endif %}', {
            method: {% if campaign_options %}'PUT'{% else %}'POST'{% endif %},
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify(campaignOptionsToSave)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw err; });
            }
            return response.json();
        })
        .then(data => {
            ModalSystem.toast('Campaign options saved!', 'success');
            // Enable the launch button on successful save
            // const launchBtn = document.getElementById('launch-campaign-btn-driver');
            // launchBtn.disabled = false;
            // launchBtn.classList.remove('btn-disabled');
            {% if allowed_to_launch.error == "campaign_options_error" %}
            window.location.reload();
            {% endif %}
        })
        .catch(error => {
            ModalSystem.toast('Failed to save options', 'error');
        });
    }

    // *** MODIFICATION 3: New function to manage button state
    function setFormDirtyState() {
        // const launchBtn = document.getElementById('launch-campaign-btn-driver');
        // if (launchBtn) {
        //     launchBtn.disabled = true;
        //     launchBtn.classList.add('btn-disabled');
        // }
    }
    
    // --- (UNCHANGED CODE from original script, functions below this point are fine) ---
    function launchCampaign() { if (document.getElementById('launch-campaign-btn-driver').disabled) { ModalSystem.toast('Please save your changes before launching.', 'warning'); return; } if (campaignOptions.emailAccounts.length === 0) { ModalSystem.toast('Please select at least one email account.', 'error'); return; } saveOptionsBeforeLaunch().then(() => { ModalSystem.confirm({ title: 'Launch Campaign', message: `Launch this campaign with ${campaignOptions.emailAccounts.length} email account(s)?`, confirmText: 'Launch Campaign', confirmClass: 'btn-primary', action: () => { performCampaignLaunch(); } }); }).catch(error => { ModalSystem.toast('Failed to save options before launching. Please try again.', 'error'); }); }
    function saveOptionsBeforeLaunch() { return new Promise((resolve, reject) => { const campaignOptionsToSave = { campaign: {{ campaign_id }}, email_accounts: campaignOptions.emailAccounts.map(email => email.email_id), stop_on_reply: campaignOptions.stopOnReply, open_tracking_enabled: campaignOptions.openTracking, link_tracking_enabled: campaignOptions.linkTracking, send_as_text_only: campaignOptions.textOnly, send_first_email_as_text_only: campaignOptions.firstEmailTextOnly, daily_limit: campaignOptions.dailyLimit }; fetch('{% if campaign_options %}/api/campaign-options/{{ campaign_options.id }}/{% else %}/api/campaign-options/{% endif %}', { method: {% if campaign_options %}'PUT'{% else %}'POST'{% endif %}, headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' }, body: JSON.stringify(campaignOptionsToSave) }).then(response => { if (!response.ok) { throw new Error('Failed to save'); } resolve(); }).catch(error => { reject(error); }); }); }
    // Replace your existing performCampaignLaunch function with this one
    function performCampaignLaunch() {
        ModalSystem.loading('Launching campaign...');

        fetch('/api/campaigns/{{ campaign_id }}/launch/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(async (response) => {
            // This block now handles all non-successful HTTP statuses
            if (!response.ok) {
                let errorData;
                try {
                    // We TRY to parse the response as JSON first, as it may contain a detailed error message.
                    errorData = await response.json();
                } catch (e) {
                    // If parsing fails (e.g., it's an HTML error page), we create a fallback error object.
                    errorData = { 
                        message: `Server responded with status ${response.status}: ${response.statusText}` 
                    };
                }
                // We throw the structured error object to be caught by the .catch block.
                throw errorData;
            }
            // If the response was successful (2xx), we parse the JSON and proceed.
            return response.json();
        })
        .then(data => {
            ModalSystem.hideLoading();

            // --- SUCCESS MESSAGE HANDLING ---
            // This is where the proper success message is shown.
            // The 'data' object from your API contains the details.
            if (data.success) {
                ModalSystem.success({
                    title: 'Campaign Launched Successfully!',
                    message: `Your campaign "${data.campaign_name}" has been launched! ${data.pending_emails} emails are being processed.`,
                });
                {% if not request.user.onboarding_completed %}
                const step = localStorage.getItem("onboardingStep");
                if (step === "created_campaign_schedule") {
                    localStorage.setItem("onboardingStep", "campaign_launched_successfully");
                };
                window.location.href = '{% url 'campaign_dashboard' campaign_id %}';
                {% endif %}
            } else {
                // This handles cases where the server responds 200 OK but with success:false
                console.error('Launch failed with success:false response:', data);
                ModalSystem.error({
                    title: 'Launch Failed',
                    message: getErrorMessage(data) // Use our helper to get the message
                });
            }
        })
        .catch(error => {
            ModalSystem.hideLoading();
            
            // This logs the actual error object to the console for debugging.
            console.error('Launch error:', error); 
            
            // This now shows a proper, human-readable message to the user.
            ModalSystem.error({
                title: 'Launch Error',
                message: getErrorMessage(error)
            });
        });
    }
    function validateCampaignReadiness() { /* This function is now superseded by the dirty state logic, but can be kept for other validation if needed */ }
    const campaignLocked = {% if campaign.status == 'active' or campaign.status == 'completed' %}true{% else %}false{% endif %};
    function disableFormInputs() { if (campaignLocked) { const inputs = document.querySelectorAll('#options-form input, #options-form select, #options-form button'); inputs.forEach(input => { input.disabled = true; input.classList.add('opacity-50', 'cursor-not-allowed'); }); } }
    document.addEventListener('DOMContentLoaded', function() { toggleOption('stopOnReply', campaignOptions.stopOnReply); toggleOption('openTracking', campaignOptions.openTracking); renderSelected(); validateCampaignReadiness(); disableFormInputs(); setFormDirtyState(); /* Ensure button is disabled on load */ });



    // Add this helper function near the top of your <script> block
    function getErrorMessage(error) {
        //console.log("Parsing error:", error); // Add this for debugging

        // 1. If the error is already a simple string, return it.
        if (typeof error === 'string') {
            return error;
        }

        // 2. Check for common API error message properties.
        if (error && typeof error.message === 'string' && error.message) {
            return error.message;
        }
        // Django REST Framework often uses 'detail' for non-field errors.
        if (error && typeof error.detail === 'string' && error.detail) {
            return error.detail;
        }
        // Some APIs use a top-level 'error' key
        if (error && typeof error.error === 'string' && error.error) {
            return error.error;
        }

        // 3. Handle Django REST Framework field errors (e.g., { email: ["Invalid email."] })
        if (error && typeof error === 'object' && !Array.isArray(error)) {
            const keys = Object.keys(error);
            if (keys.length > 0) {
                const firstErrorKey = keys[0];
                const firstErrorMessage = Array.isArray(error[firstErrorKey]) ? error[firstErrorKey][0] : error[firstErrorKey];
                // Don't show generic keys like 'success' or 'campaign_id' as the error source
                if (firstErrorKey !== 'success' && firstErrorKey !== 'campaign_id') {
                    return `${firstErrorKey}: ${firstErrorMessage}`;
                }
            }
        }

        // 4. Final fallback message.
        return 'An unknown error occurred. Please check the browser console for details.';
    }
    

    function fixLaucnhError() {
        {% if allowed_to_launch.error == "campaign_leads_error" %}
        window.location.href = '{% url 'campaign_leads' campaign_id %}';
        {% elif allowed_to_launch.error == "email_accounts_error" %}
        supportChatBtn= document.getElementById("chat-toggle-button");
        chatMessageBtn= document.getElementById("chat-msg-tab");
        startNewChatBtn= document.getElementById("action-send-message-messages");
        
        supportChatBtn.click();
        chatMessageBtn.click();
        startNewChatBtn.click();
        let newChatInput= document.getElementById("chat-input");
        let message = "my email account is not active, please help me out";
        let i = 0;

        newChatInput.focus();

        function typeChar() {
        if (i < message.length) {
            newChatInput.value += message.charAt(i);
            newChatInput.dispatchEvent(new Event("input", { bubbles: true }));
            i++;
            setTimeout(typeChar, 50); // 50ms per character
        }
        }
        if (newChatInput.value.trim() === "") {
            typeChar();
        };    

        {% elif allowed_to_launch.error == "message_assignments_error" %}
        window.location.href = '{% url 'campaign_sequence' campaign_id %}';
        {% endif %}
    }

    // onboarding
    {% if not request.user.onboarding_completed %}
    function higightEmailAccountSelection() {
        const inputEmailAccount = document.getElementById("searchInput");

        // Focus it (safe in case triggered from somewhere else)
        inputEmailAccount.focus();

        // Add inline highlight style
        inputEmailAccount.style.backgroundColor = "#e0f7ff";  
        inputEmailAccount.style.outline = "2px solid #00aaff";  

        let popup = document.getElementById("popupMsg");
        if (!popup) {
            popup = document.createElement("div");
            popup.id = "popupMsg";
            popup.innerText = "ðŸ‘‹ Click me!";
            document.body.appendChild(popup);

            // Inline styles (no global CSS)
            popup.style.position = "absolute";
            popup.style.background = "#333";
            popup.style.color = "#fff";
            popup.style.padding = "6px 10px";
            popup.style.borderRadius = "6px";
            popup.style.fontSize = "14px";
            popup.style.boxShadow = "0 2px 6px rgba(0,0,0,0.3)";
            popup.style.zIndex = "1000";
        }

        // Position popup under the input
        const rect = inputEmailAccount.getBoundingClientRect();
        popup.style.left = rect.left + window.scrollX + "px";
        popup.style.top = rect.bottom + window.scrollY + 5 + "px";

        // Auto remove popup after 2 seconds
        setTimeout(() => popup.remove(), 2000);    
    }

    document.addEventListener("DOMContentLoaded", () => {
      const step = localStorage.getItem("onboardingStep");
      if (step === "created_campaign_schedule") {
        const driver = window.driver.js.driver;
        const driverObj = driver({
          animate: true,
          overlayOpacity: 0.7,
          stagePadding: 10,
          allowClose: false,
          steps: [
            // *** MODIFICATION 2: All steps below are updated
            {
              element: "#options-form",
              popover: {
                title: "here is your campaign settings",
                description: "",
                position: "bottom"
              },
            },
            {
              element: "#email-selector-driver",
              popover: {
                title: "Select Sending Accounts",
                description: "First, choose which of your connected email accounts will send messages for this campaign.",
                position: "bottom"
              },
            // *** MODIFICATION 1: Add hooks to show/hide the dropdown
              onHighlightStarted: () => {
                higightEmailAccountSelection();
              },
            },
            {
              element: "#stop-on-reply-card-driver",
              popover: {
                title: "Stop on Reply",
                description: "This crucial feature prevents sending follow-ups after a lead has replied. Notice that you need to set each replied lead individualy when yhe lead responds to your email.",
                position: "right"
              }
            },
            {
              element: "#open-tracking-card-driver",
              popover: {
                title: "Tracking Options",
                description: "Here you can enable or disable tracking for email opens and link clicks.",
                position: "right"
              }
            },
            {
              element: "#link-tracking-checkbox-driver",
              popover: {
                title: "Link Tracking",
                description: "if you included any link in your email, it will track who clicked it and when.",
                position: "bottom"
              }
            },
            {
              element: "#daily-limit-card-driver",
              popover: {
                title: "Set Your Daily Sending Limit",
                description: "Control the maximum number of emails this campaign sends per day to maintain good sender reputation. It adjusts automatically when you add accounts.",
                position: "top"
              }
            },
            {
              element: "#save-options-btn-driver",
              popover: {
                title: "Save Your Changes",
                description: "After configuring your options, click here to save them. This is required before you can launch.",
                position: "top"
              }
            },
            {
              element: "#launch-campaign-btn-driver",
              popover: {
                title: "Launch Your Campaign!",
                description: "Once your options are saved, this button will activate. Click it to start your campaign!",
                position: "top"
              }
            },
          ]
        });
        driverObj.drive();

        document.querySelector("#launch-campaign-btn-driver").addEventListener("click", () => {
            driverObj.destroy();  // hides the overlay
        // Now redirect to campaigns
        });
      }
    });
    {% endif %}
</script>

{% endblock %}


