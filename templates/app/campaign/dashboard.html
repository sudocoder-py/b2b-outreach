{% extends "app/campaign/campaign-base.html" %}
{% load static %}
{% csrf_token %}

{% block title %}Campaign Dashboard{% endblock %}

{% block js %}
<script src="{% static 'cdn/chart.js' %}"></script>
{% endblock %}



{% block cmp-base-content %}

<style>
/* Custom styles for dashboard */
.stat-card {
    transition: all 0.2s ease;
}

.stat-card:hover {
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.progress-ring {
    transition: stroke-dasharray 0.5s ease;
}

.dropdown-content {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.tab-content {
    opacity: 0;
    transition: opacity 0.3s ease;
}

.tab-content.active {
    opacity: 1;
}

.activity-item {
    transition: all 0.2s ease;
}

.activity-item:hover {
    background-color: #f9fafb;
}
</style>

        <!-- Status & Filters -->
        <div class="flex items-center justify-between mt-8">
            <div id="campaign-status-header-driver" class="flex items-center gap-3">
                <span class="text-sm font-medium text-gray-500">Status:</span>
                    {% if campaign_status == "active" %}
                        <span class="badge badge-success text-white font-medium py-2">Active</span>
                    {% elif campaign_status == "paused" %}
                        <span class="badge badge-warning text-white font-medium py-2">Paused</span>
                    {% elif campaign_status == "draft" %}
                        <span class="badge badge-neutral text-white font-medium py-2">Draft</span>
                    {% elif campaign_status == "completed" %}
                        <span class="badge badge-info text-white font-medium py-2">Completed</span>
                    {% else %}
                        {{ campaign_status }}
                    {% endif %}
                <span class="mr-2 ml-2">|</span>    
                <span class="text-sm font-bold text-gray-800" id="campaign-progress-text">{{stats.sequence_started_rate}}%</span>
                <progress class="progress progress-primary w-40 h-1.5" value="{{stats.sequence_started_rate}}" max="100" id="campaign-progress-bar"></progress>
                <span class="text-sm font-medium text-gray-500" id="campaign-progress-text">out of <span class="text-2xl text-success font-bold mr-1 ml-1">{{stats.total_leads}}</span> total leads</span>
            </div>
            <div class="flex items-center gap-3">
                <button class="btn bg-white text-gray-900 border border-base-300 h-10 min-h-10 rounded-lg px-4 text-sm hover:bg-gray-50" onclick="showCurrentResults()">
                    <i class="fa-solid fa-history mr-2 text-gray-500"></i>
                    see current results
                </button>
                <div class="dropdown dropdown-end">
                    <button tabindex="0" role="button" class="btn bg-white border border-base-300 h-10 min-h-10 px-3 flex items-center gap-2 rounded-lg hover:bg-gray-50">
                        <span class="text-sm font-medium text-gray-700" id="time-filter-text">Last 4 weeks</span>
                        <i class="fa-solid fa-chevron-down text-xs text-gray-500"></i>
                    </button>
                    <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-white rounded-box w-52 mt-2">
                        <li><a onclick="changeTimeFilter('24h', 'Last 24 hours')">Last 24 hours</a></li>
                        <li><a onclick="changeTimeFilter('7d', 'Last 7 days')">Last 7 days</a></li>
                        <li><a onclick="changeTimeFilter('4w', 'Last 4 weeks')" class="active">Last 4 weeks</a></li>
                        <li><a onclick="changeTimeFilter('3m', 'Last 3 months')">Last 3 months</a></li>
                        <li><a onclick="changeTimeFilter('all', 'All time')">All time</a></li>
                    </ul>
                </div>
                <!-- <button class="btn bg-white border border-base-300 btn-square h-10 min-h-10 w-10 hover:bg-gray-50" onclick="openSettings()">
                    <i class="fa-solid fa-gear text-gray-500"></i>
                </button> -->
            </div>
        </div>

        <!-- Stats Cards -->
        <div id="kpi-cards-container-driver" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6 mt-6" id="stats-container">

            <!-- Card 1: sent -->
            <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm stat-card cursor-pointer">
                <div class="flex justify-between items-center text-gray-400 text-sm font-medium">
                    <span>Sent</span>
                    <div class="tooltip tooltip-center" data-tip="number of leads that have been sent at least one message in this campaign">
                        <i class="fa-solid fa-circle-info hover:text-gray-600 cursor-help"></i>
                    </div>
                </div>
                <div class="mt-4 text-4xl font-bold text-gray-800">
                    <span id="conversions-count">{{stats.sequence_started_count}}</span>
                    <span class="text-gray-300 font-light mx-1">|</span>
                    <span class="text-2xl font-semibold text-gray-500" id="conversions-value">{{stats.sequence_started_rate}}%</span>
                </div>
            </div>

            <!-- Card 2: Open Rate -->
            <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm stat-card cursor-pointer">
                <div class="flex justify-between items-center text-gray-400 text-sm font-medium">
                    <span>Open rate</span>
                    <div class="tooltip tooltip-center" data-tip="Number of leads that have opened at least one email in this campaign.">
                        <i class="fa-solid fa-circle-info hover:text-gray-600 cursor-help"></i>
                    </div>
                </div>
                <div class="mt-4 text-4xl font-bold text-gray-800">
                    <span id="opens-count">{{stats.opened_count}}</span>
                    <span class="text-gray-300 font-light mx-1">|</span>
                    <span class="text-2xl font-semibold" id="open-rate">{{stats.open_rate_percentage}}%</span>
                </div>
            </div>

            <!-- Card 3: Click Rate -->
            <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm stat-card cursor-pointer">
                <div class="flex justify-between items-center text-gray-400 text-sm font-medium">
                    <span>Click rate</span>
                    <div class="tooltip tooltip-center" data-tip="Number of leads that have clicked at least one link in this campaign.">
                        <i class="fa-solid fa-circle-info hover:text-gray-600 cursor-help"></i>
                    </div>
                </div>
                <div class="mt-4 text-4xl font-bold text-gray-800">
                    <span id="clicks-count">{{stats.clicked_count}}</span>
                    <span class="text-gray-300 font-light mx-1">|</span>
                    <span class="text-2xl font-semibold" id="click-rate">{{stats.click_rate_percentage}}%</span>
                </div>
            </div>

            <!-- Card : reply rate -->
            <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm stat-card cursor-pointer">
                <div class="flex justify-between items-center text-gray-400 text-sm font-medium">
                    <span>Reply rate</span>
                    <div class="tooltip tooltip-center" data-tip="Number of leads that have replied at least one email in this campaign.">
                        <i class="fa-solid fa-circle-info hover:text-gray-600 cursor-help"></i>
                    </div>
                </div>
                <div class="mt-4 text-4xl font-bold text-gray-800">
                    <span id="sequence-started">{{stats.replied_count}}</span>
                    <span class="text-gray-300 font-light mx-1">|</span>
                    <span class="text-2xl font-semibold">{{stats.reply_rate_percentage}}%</span>
                </div>
            </div>

            <!-- Card 4: Opportunities -->
            <div id="opportunities-card-driver" class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm stat-card cursor-pointer" onclick="updateOpportunityValue()">
                <div class="flex justify-between items-center text-gray-400 text-sm font-medium">
                    <span>Opportunities</span>
                    <div class="tooltip tooltip-left" data-tip="Number of leads that you have marked as positive. Per positive lead value is set to ${{stats.opportunity_value|default:'0'}} Click to update">
                        <i class="fa-solid fa-circle-info hover:text-gray-600 cursor-help"></i>
                    </div>
                </div>
                <div class="mt-4 text-4xl font-bold text-gray-800">
                    <span id="opportunities-count">{{stats.opportunities_count}}</span>
                    <span class="text-gray-300 font-light mx-1">|</span>
                    <span class="text-2xl font-semibold text-gray-500" id="opportunities-value">${{stats.opportunities_total}}</span>
                </div>
                <div class="mt-2 text-xs text-gray-400">
                    Per lead value: $<span id="per-lead-value">{{stats.opportunity_value|default:'0'}}</span> (click to edit)
                </div>
            </div>

        </div>
        
        <!-- Chart Section -->
        <div class="mt-6 bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-800">Performance Overview</h3>
                <div class="flex items-center gap-2">
                    <!-- Chart Legend -->
                    <div class="flex items-center gap-4 text-sm" id="chart-legend" style="display: none;">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                            <span class="text-gray-600">Sent</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            <span class="text-gray-600">Opened</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-orange-500 rounded-full"></div>
                            <span class="text-gray-600">Clicked</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                            <span class="text-gray-600">Replied</span>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-ghost" onclick="refreshChart()" id="refresh-btn">
                        <i class="fa-solid fa-refresh mr-2"></i>Refresh
                    </button>
                </div>
            </div>
            
            <!-- Main Analytics Chart -->
            <div id="performance-overview-chart-driver" class="card bg-base-100 shadow-lg mb-8">
                <div class="card-body">
                    <!-- Custom Legend - Updated to match new order -->
                    <div class="flex flex-wrap gap-x-4 gap-y-2 mb-4">
                        <div class="flex items-center gap-2 text-sm"><div class="w-3 h-3 rounded-full bg-purple-400"></div>Total replies</div>
                        <div class="flex items-center gap-2 text-sm"><div class="w-3 h-3 rounded-full bg-amber-400"></div>Total clicks</div>
                        <div class="flex items-center gap-2 text-sm"><div class="w-3 h-3 rounded-full bg-sky-400"></div>Total opens</div>
                        <div class="flex items-center gap-2 text-sm"><div class="w-3 h-3 rounded-full bg-blue-500"></div>Sent</div>
                        <div class="flex items-center gap-2 text-sm"><div class="w-3 h-3 rounded-full bg-teal-400"></div>Opportunities</div>
                    </div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="mainAnalyticsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step Analytics & Activity -->
        <div class="mt-6 bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
            <div role="tablist" class="tabs tabs-boxed bg-gray-100 w-max">
                <a role="tab" class="tab tab-active bg-white text-primary shadow-sm" onclick="switchTab('analytics')">Step Analytics</a>
                <a role="tab" class="tab" onclick="switchTab('activity')">Activity</a>
            </div>

            <!-- Step Analytics Tab -->
            <div class="mt-6 tab-content active" id="analytics-tab">
                <div class="space-y-4" id="step-analytics-container">
                    <p class="text-sm text-gray-600">👋 Step analytics will appear here once the campaign is published</p>
                </div>
            </div>

            <!-- Activity Tab -->
            <div class="mt-6 tab-content" id="activity-tab">
                <div class="space-y-3" id="activity-container">
                    <p class="text-sm text-gray-600">Recent campaign activity will appear here</p>
                    <button class="btn btn-sm btn-outline btn-primary" onclick="loadActivity()">
                        Load Sample Activity
                    </button>
                </div>
            </div>
        </div>

{{ campaign.id|json_script:"campaign-id" }}
<script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>

<script>
    function pollCampaignStats() {
        const POLL_INTERVAL = 30000; // 30 seconds
        const TIMEOUT = 10 * 60 * 1000; // 10 minutes
        const startTime = Date.now();

        // Show loading modal initially
        ModalSystem.loading('Completing Campaign launching...'); 

        const poll = async () => {
            try {
                const response = await fetch(`/api/campaigns/{{ campaign_id }}/status/`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                const data = await response.json();

                if (response.status === 200) {
                    // Success: stop polling and show success modal
                    ModalSystem.success({
                        title: 'Campaign Launched Successfully!',
                        message: `Your campaign "${data.campaign_name}" has been launched! ${data.pending_emails} emails are being processed.`,
                    });
                    // Reload page after short delay to allow user to see modal
                    setTimeout(() => window.location.reload(), 1500);
                } else if (response.status === 400) {
                    // Keep polling (still loading)
                    if (Date.now() - startTime < TIMEOUT) {
                        setTimeout(poll, POLL_INTERVAL);
                    } else {
                        // Timeout reached
                        ModalSystem.error({
                            title: 'Launch Failed',
                            message: getErrorMessage(data)
                        });
                    }
                } else {
                    // Other errors, stop polling
                    ModalSystem.error({
                        title: 'Launch Failed',
                        message: getErrorMessage(data)
                    });
                }
            } catch (error) {
                // Network or unexpected errors
                if (Date.now() - startTime < TIMEOUT) {
                    setTimeout(poll, POLL_INTERVAL);
                } else {
                    ModalSystem.error({
                        title: 'Launch Failed',
                        message: error.message
                    });
                }
            }
        };

        poll();
    }

    document.addEventListener("DOMContentLoaded", () => {
    {% if campaign_status == 'active' and not stats %}
        console.log('polling');
        pollCampaignStats();
        {% endif %}
    });

    document.addEventListener('DOMContentLoaded', function () {
        let mainAnalyticsChart;
        let currentTimeFilter = '4w';
        const campaignId = {{ campaign_id }};

        // API functions
        const fetchAnalyticsData = async (timeFilter = '4w') => {
            try {
                const response = await fetch(`/campaign/api/analytics/${campaignId}?filter=${timeFilter}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching analytics data:', error);
                return null;
            }
        };

        const refreshStats = async () => {
            try {
                const refreshBtn = document.getElementById('refresh-btn');
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Refreshing...';

                const response = await fetch(`/api/refresh-daily-stats/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        campaign_id: campaignId,
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Reload the chart data after a short delay
                    setTimeout(() => {
                        loadAnalyticsData(currentTimeFilter);
                    }, 2000);
                } else {
                    console.error('Error refreshing stats:', result.message);
                }
            } catch (error) {
                console.error('Error refreshing stats:', error);
            } finally {
                const refreshBtn = document.getElementById('refresh-btn');
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="fa-solid fa-refresh mr-2"></i>Refresh';
            }
        };

        // Update summary cards with new data
        const updateSummaryCards = (summaryStats) => {
            document.getElementById('opens-count').textContent = summaryStats.opened_count;
            document.getElementById('open-rate').textContent = summaryStats.open_rate_percentage + '%';
            document.getElementById('clicks-count').textContent = summaryStats.clicked_count;
            document.getElementById('click-rate').textContent = summaryStats.click_rate_percentage + '%';
            document.getElementById('sequence-started').textContent = summaryStats.replied_count;
            document.getElementById('opportunities-count').textContent = summaryStats.opportunities_count;
            document.getElementById('opportunities-value').textContent = '$' + summaryStats.opportunities_total_value.toLocaleString();
            document.getElementById('conversions-count').textContent = summaryStats.conversions_count;
            document.getElementById('conversions-value').textContent = '$' + summaryStats.conversions_total_value.toLocaleString();

            // Update progress bar
            document.getElementById('campaign-progress-text').textContent = summaryStats.sequence_started_rate + '%';
            document.getElementById('campaign-progress-bar').value = summaryStats.sequence_started_rate;
        };

        const chartOptions = (theme) => {
            const isDark = theme === 'dark';
            return {
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: isDark ? '#1f2937' : '#f9fafb',
                        titleColor: isDark ? '#f3f4f6' : '#1f2937',
                        bodyColor: isDark ? '#e5e7eb' : '#1f2937',
                        borderColor: isDark ? '#374151' : '#e5e7eb',
                        borderWidth: 1,
                        padding: 10
                    },
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: isDark ? '#e5e7eb' : '#374151',
                            font: {
                                size: 12,
                                family: 'Inter, sans-serif',
                            }
                        },
                        grid: {
                            color: isDark ? 'rgba(255, 255, 255, 0.08)' : 'rgba(0, 0, 0, 0.05)',
                            drawBorder: false
                        }
                    },
                    x: {
                        ticks: {
                            color: isDark ? '#e5e7eb' : '#374151',
                            font: {
                                size: 12,
                                family: 'Inter, sans-serif',
                            }
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                elements: {
                    line: {
                        borderWidth: 3,
                        tension: 0.4,
                        borderCapStyle: 'round',
                        borderJoinStyle: 'round'
                    },
                    point: {
                        radius: 3,
                        hoverRadius: 6,
                        hitRadius: 10
                    }
                }
            };
        };

        const createOrUpdateChart = (analyticsData) => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const ctx = document.getElementById('mainAnalyticsChart');
            if (!ctx || !analyticsData) return;

            // Sort datasets by maximum value (lowest to highest for better visibility)
            const datasets = [...analyticsData.chart_data.datasets];
            datasets.sort((a, b) => {
                const maxA = Math.max(...a.data);
                const maxB = Math.max(...b.data);
                return maxA - maxB;
            });

            const chartData = {
                labels: analyticsData.chart_data.labels,
                datasets: datasets
            };

            if (mainAnalyticsChart) {
                mainAnalyticsChart.data = chartData;
                mainAnalyticsChart.options = chartOptions(currentTheme);
                mainAnalyticsChart.update();
            } else {
                mainAnalyticsChart = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: chartData,
                    options: chartOptions(currentTheme)
                });
            }
        };

        // Load analytics data and update chart
        const loadAnalyticsData = async (timeFilter = '4w') => {
            const data = await fetchAnalyticsData(timeFilter);
            if (data && data.success) {
                createOrUpdateChart(data);
                // updateSummaryCards(data.summary_stats);
            }
        };

        // Time filter change handler
        window.changeTimeFilter = (filterValue, displayText) => {
            currentTimeFilter = filterValue;
            document.getElementById('time-filter-text').textContent = displayText;

            // Update active state in dropdown
            document.querySelectorAll('.dropdown-content a').forEach(a => a.classList.remove('active'));
            event.target.classList.add('active');

            // Load new data
            loadAnalyticsData(filterValue);
        };

        // Refresh chart handler
        window.refreshChart = () => {
            refreshStats();
        };

        // Show current results function
        window.showCurrentResults = async () => {
            try {
                ModalSystem.loading('Loading current results...');

                const response = await fetch('/api/campaigns/{{ campaign_id }}/status/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Create the results card HTML
                    const resultsHTML = `
                        <div class="bg-white rounded-lg border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">Campaign Status: ${data.campaign_name}</h3>
                                <span class="badge ${data.campaign_status === 'completed' ? 'badge-success' : data.campaign_status === 'active' ? 'badge-primary' : 'badge-neutral'} text-white">
                                    ${data.campaign_status.charAt(0).toUpperCase() + data.campaign_status.slice(1)}
                                </span>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600">${data.statistics.total_message_assignments}</div>
                                    <div class="text-sm text-gray-500">Total Messages</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600">${data.statistics.sent_emails}</div>
                                    <div class="text-sm text-gray-500">Sent</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-orange-600">${data.statistics.pending_emails}</div>
                                    <div class="text-sm text-gray-500">Pending</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-purple-600">${data.statistics.completion_percentage}%</div>
                                    <div class="text-sm text-gray-500">Complete</div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="flex justify-between text-sm text-gray-600 mb-1">
                                    <span>Progress</span>
                                    <span>${data.statistics.completion_percentage}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${data.statistics.completion_percentage}%"></div>
                                </div>
                            </div>

                            ${data.email_accounts.length > 0 ? `
                                <div>
                                    <h4 class="font-medium text-gray-800 mb-3">Email Accounts</h4>
                                    <div class="space-y-2">
                                        ${data.email_accounts.map(account => `
                                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                <span class="text-sm font-medium">${account.email}</span>
                                                <div class="text-right">
                                                    <div class="text-sm text-gray-600">${account.emails_sent_today}/${account.daily_limit} sent today</div>
                                                    <div class="text-xs text-gray-500">${account.remaining_capacity} remaining</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;

                    ModalSystem.hideLoading();
                    ModalSystem.confirm({
                        title: 'Current Campaign Results',
                        message: '',
                        customContent: resultsHTML,
                        html: true,
                        confirmText: 'Close',
                        confirmClass: 'btn-primary',
                        action: function() {
                            // Just close the modal
                        }
                    });
                } else {
                    ModalSystem.hideLoading();
                    ModalSystem.error('Failed to load campaign results: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                ModalSystem.hideLoading();
                ModalSystem.error('Error loading campaign results: ' + error.message);
            }
        };

        // Update opportunity value function
        window.updateOpportunityValue = () => {
            const currentValue = document.getElementById('per-lead-value').textContent;

            ModalSystem.confirm({
                title: 'Update Opportunity Value',
                message: 'Set the value per positive opportunity lead:',
                customContent: `
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Value per opportunity ($)</label>
                        <input type="number" id="opportunity-value-input" class="input input-bordered w-full"
                               value="${currentValue}" min="0" step="0.01" placeholder="Enter value">
                        <p class="text-xs text-gray-500 mt-1">This value will be used to calculate total opportunity value</p>
                    </div>
                `,
                html: true,
                confirmText: 'Update',
                confirmClass: 'btn-primary',
                action: async function() {
                    const newValue = document.getElementById('opportunity-value-input').value;

                    if (!newValue || isNaN(newValue) || parseFloat(newValue) < 0) {
                        ModalSystem.toast('Please enter a valid positive number', 'error');
                        return;
                    }

                    try {
                        ModalSystem.loading('Updating opportunity value...');

                        const response = await fetch('/api/campaigns/{{ campaign_id }}/update-opportunity-value/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({
                                opportunity_value: parseFloat(newValue)
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            // Update the display
                            document.getElementById('per-lead-value').textContent = data.opportunity_value.toFixed(2);

                            // Update tooltip
                            const tooltip = document.querySelector('[data-tip*="Per positive lead value"]');
                            if (tooltip) {
                                tooltip.setAttribute('data-tip',
                                    `Number of leads that you have marked as positive. Per positive lead value is set to $${data.opportunity_value.toFixed(2)} Click to update`);
                            }

                            // Recalculate total opportunities value
                            const opportunitiesCount = parseInt(document.getElementById('opportunities-count').textContent) || 0;
                            const totalValue = opportunitiesCount * data.opportunity_value;
                            document.getElementById('opportunities-value').textContent = `$${totalValue.toFixed(2)}`;

                            ModalSystem.hideLoading();
                            ModalSystem.toast('Opportunity value updated successfully!', 'success');
                        } else {
                            ModalSystem.hideLoading();
                            ModalSystem.error('Failed to update opportunity value: ' + (data.message || 'Unknown error'));
                        }
                    } catch (error) {
                        ModalSystem.hideLoading();
                        ModalSystem.error('Error updating opportunity value: ' + error.message);
                    }
                }
            });
        };

        // Initialize the dashboard
        loadAnalyticsData(currentTimeFilter);

        // Theme change observer
        const observer = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
                    // Reload chart with current data but new theme
                    loadAnalyticsData(currentTimeFilter);
                }
            }
        });
        observer.observe(document.documentElement, { attributes: true });
    });






{% if not request.user.onboarding_completed %}
document.addEventListener("DOMContentLoaded", () => {
  const step = localStorage.getItem("onboardingStep");

  // *** FIX 1: The key now matches what the previous step set.
  if (step === "campaign_launched_successfully") {
    const driver = window.driver.js.driver;
    const driverObj = driver({
      animate: true,
      overlayOpacity: 0.7,
      stagePadding: 10,
      allowClose: false,
      allowKeyboardControl: false,
      steps: [
        {
          element: "#campaign-status-header-driver",
          popover: {
            title: "🎉 Your Campaign is Live!",
            description: "Welcome to your campaign dashboard. This area shows the real-time status and overall progress of your campaign.",
            position: "bottom"
          }
        },
        {
          element: "#kpi-cards-container-driver",
          popover: {
            title: "At-a-Glance Performance",
            description: "These cards provide a quick summary of your most important metrics like emails sent, open rates, and replies.",
            position: "bottom"
          }
        },
        {
          element: "#opportunities-card-driver",
          popover: {
            title: "Tracking Success",
            description: "The 'Opportunities' card tracks positive outcomes from your campaign. You can even assign a monetary value to each lead.",
            position: "left"
          }
        },
        {
          element: "#performance-overview-chart-driver",
          popover: {
            title: "Performance Over Time",
            description: "This chart visualizes your campaign's performance day-by-day. Hover over any point on the graph to see detailed stats for that day.",
            position: "top"
          }
        },
        {
          element: "#campaign-actions-bar-driver",
          popover: {
            title: "Manage Your Campaign",
            description: "From here, you can pause, resume, or access other advanced settings for your active campaign.",
            position: "bottom"
          }
        },
        {
          element: "#overall-dashboard-tab",
          popover: {
            title: "Onboarding Complete!",
            description: "Great work! To see an overview of ALL your campaigns, just click here. You can return to this specific dashboard anytime.",
            position: "right" 
          }
        }
      ]
    });

    driverObj.drive();

    document.querySelector("#overall-dashboard-tab").addEventListener("click", () => {
        driverObj.destroy();  // hides the overlay
        localStorage.setItem("onboardingStep", "campaign_dashboard_shown");
    });
  }
});
{% endif %}


</script>

{% endblock %}